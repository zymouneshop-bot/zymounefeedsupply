 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ZYMOUNE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx@latest/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5dc;
            color: black;
        }
        
        * {
            color: black !important;
        }
        
        .header {
            background: linear-gradient(135deg, #d2b48c 0%, #bc9a6a 100%);
            color: #8b7355;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn {
            background: rgba(139, 115, 85, 0.2);
            color: #8b7355;
            border: 1px solid rgba(139, 115, 85, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(139, 115, 85, 0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .welcome-section {
            background: #f5f5dc;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .welcome-section h1 {
            color: #8b7355;
            margin-bottom: 0.5rem;
        }
        
        .welcome-section p {
            color: #a09080;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: #f5f5dc;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #8b7355;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card p {
            color: #a09080;
        }
        
        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stat-instruction {
            font-size: 0.8rem;
            color: #d63031;
            font-weight: bold;
            margin-top: 0.5rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Low Stock Modal Styles */
        .low-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #f9f9f9;
        }
        
        .low-stock-item:hover {
            background: #f0f0f0;
        }

        .stock-breakdown {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .stock-detail {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: #495057;
            font-weight: 500;
        }
        
        .product-info h4 {
            margin: 0 0 0.25rem 0;
            color: #333;
            font-size: 1.1rem;
        }
        
        .product-category {
            margin: 0 0 0.5rem 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: capitalize;
        }
        
        .stock-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stock-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .stock-value {
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .stock-value.out-of-stock {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .stock-value.critical {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .stock-value.low {
            background: #fff8e1;
            color: #f9a825;
        }
        
        .stock-value.normal {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .product-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 1.1rem;
        }
        
        .low-stock-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .low-stock-instructions p {
            margin: 0;
            color: #856404;
            font-size: 1rem;
        }
        
        .low-stock-instructions strong {
            color: #d63031;
            font-size: 1.1rem;
        }
        
        /* Stock Management Modal Styles */
        .product-info-header {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .product-info-header h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1.2rem;
        }
        
        .product-info-header p {
            margin: 0 0 1rem 0;
            color: #666;
            text-transform: capitalize;
        }
        
        .current-stock-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .current-stock-label {
            font-weight: 500;
            color: #666;
        }
        
        .current-stock-value {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2e7d32;
            background: #e8f5e8;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .alert-card {
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            color: #8b7355;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .section {
            background: #f5f5dc;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #8b7355;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #d2b48c;
            padding-bottom: 0.5rem;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .product-card {
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .product-image {
            width: 100%;
            height: 150px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .product-info {
            padding: 1rem;
        }
        
        .product-name {
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            word-break: break-word;
        }
        
        .product-category {
            color: #d2b48c;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-stock {
            font-size: 0.9rem;
            margin-bottom: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .stock-low {
            color: #8b7355;
            font-weight: bold;
        }
        
        .stock-ok {
            color: #a09080;
        }
        
        .btn {
            background: #d2b48c;
            color: #8b7355;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 0.5rem;
        }
        
        .btn:hover {
            background: #bc9a6a;
        }
        
        .btn-secondary {
            background: #a09080;
        }
        
        .btn-secondary:hover {
            background: #8b7355;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #a09080;
        }
        
        .error {
            background: #f5f5dc;
            color: #8b7355;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #d2b48c;
            color: #8b7355;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-layout {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 280px;
            background: #d2b48c;
            color: #8b7355;
            padding: 2rem 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 0 2rem 2rem 2rem;
            border-bottom: 1px solid #bc9a6a;
            margin-bottom: 2rem;
        }
        
        .sidebar-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            color: #ecf0f1;
        }
        
        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-btn {
            width: 100%;
            background: none;
            border: none;
            color: #a09080;
            padding: 1rem 2rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1rem;
            border-left: 3px solid transparent;
        }
        
        .nav-btn:hover {
            background: #bc9a6a;
            color: #8b7355;
            border-left-color: #8b7355;
        }
        
        .nav-btn.active {
            background: #bc9a6a;
            color: #8b7355;
            border-left-color: #8b7355;
        }
        
        .nav-icon {
            font-size: 1.5rem;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            background: #f5f5dc;
            overflow-y: auto;
        }
        
        .content-section {
            display: none;
            background: #f5f5dc;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-title {
            font-size: 2rem;
            color: #8b7355;
            margin: 0 0 1.5rem 0;
            font-weight: 600;
        }
        
        .placeholder-content {
            text-align: center;
            padding: 3rem;
            color: #a09080;
        }
        
        .placeholder-content h3 {
            font-size: 1.5rem;
            color: #8b7355;
            margin-bottom: 1rem;
        }
        
        .placeholder-content ul {
            text-align: left;
            max-width: 400px;
            margin: 2rem auto;
        }
        
        .placeholder-content li {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* Product Management Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-primary:hover {
            background: #bc9a6a;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #a09080;
            color: #8b7355;
        }
        
        .btn-secondary:hover {
            background: #8b7355;
        }
        
        .btn-warning {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-warning:hover {
            background: #bc9a6a;
        }
        
        .form-help {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .calculated-field {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .role-staff {
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .role-manager {
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .role-cashier {
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .status-active {
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .status-inactive {
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-edit {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-edit:hover {
            background: #bc9a6a;
        }
        
        .btn-delete {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-delete:hover {
            background: #bc9a6a;
        }
        
        .btn-qr {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-qr:hover {
            background: #bc9a6a;
        }
        
        .btn-danger {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-danger:hover {
            background: #bc9a6a;
        }
        
        .btn-success {
            background: #d2b48c;
            color: #8b7355;
        }
        
        .btn-success:hover {
            background: #bc9a6a;
        }
        
        .filters-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .category-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .animal-category-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .category-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #d2b48c;
            border-radius: 8px;
            background: #f5f5dc;
            color: #8b7355;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .category-btn:hover {
            border-color: #8b7355;
            color: #8b7355;
            transform: translateY(-2px);
        }
        
        .category-btn.active {
            background: #d2b48c;
            border-color: #d2b48c;
            color: #8b7355;
        }
        
        .subcategory-buttons {
            display: none;
            gap: 0.5rem;
            padding-left: 1rem;
        }
        
        .subcategory-buttons.show {
            display: flex;
        }
        
        .subcategory-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #d2b48c;
            background: #f5f5dc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 400;
            font-size: 0.9rem;
        }
        
        .subcategory-btn:hover {
            border-color: #8b7355;
            color: #8b7355;
            background: #f5f5dc;
        }
        
        .subcategory-btn.active {
            background: #d2b48c;
            color: #8b7355;
            border-color: #8b7355;
        }
        
        .search-group {
            display: flex;
            align-items: center;
        }
        
        .search-group input {
            padding: 0.75rem 1rem;
            border: 1px solid #d2b48c;
            border-radius: 8px;
            font-size: 1rem;
            width: 300px;
            transition: border-color 0.3s ease;
            background: #f5f5dc;
            color: #8b7355;
        }
        
        .search-group input:focus {
            outline: none;
            border-color: #8b7355;
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }
        
        .table-container {
            background: #f5f5dc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-table th,
        .products-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .products-table tr:hover {
            background: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Enhanced Product Management Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .header-content {
            flex: 1;
        }

        .section-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin: 0.5rem 0 0 0;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Product Statistics Grid */
        .product-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 0;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .stat-content h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 700;
            color: #495057;
            margin: 0;
        }

        /* Enhanced Filters Section */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .filters-header h3 {
            margin: 0;
            color: #495057;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .filters-content {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 2rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .category-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: #495057;
        }

        .category-btn:hover {
            background: #e9ecef;
            border-color: #d2b48c;
        }

        .category-btn.active {
            background: #d2b48c;
            color: white;
            border-color: #bc9a6a;
        }

        .btn-icon {
            font-size: 1.125rem;
        }

        .btn-text {
            font-weight: 600;
        }

        .animal-category-group {
            position: relative;
        }

        .subcategory-buttons {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
            display: none;
            min-width: 150px;
        }

        .animal-category-group:hover .subcategory-buttons {
            display: block;
        }

        .subcategory-btn {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s ease;
            font-size: 0.875rem;
            color: #495057;
        }

        .subcategory-btn:hover {
            background: #f8f9fa;
        }

        .subcategory-btn.active {
            background: #d2b48c;
            color: white;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            color: #6c757d;
            font-size: 1rem;
        }

        .search-group input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .search-group input:focus {
            outline: none;
            border-color: #d2b48c;
            box-shadow: 0 0 0 3px rgba(210, 180, 140, 0.1);
        }

        .search-clear {
            position: absolute;
            right: 1rem;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .search-clear:hover {
            background: #f8f9fa;
            color: #495057;
        }

        /* Cards Section */
        .cards-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .cards-header h3 {
            margin: 0;
            color: #495057;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .cards-info {
            color: #6c757d;
            font-size: 0.875rem;
        }

        /* Enhanced Product Grid View */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        /* Scrollable container for many products */
        .products-grid.scrollable {
            max-height: 70vh;
            overflow-y: auto;
            flex: 1;
        }

        /* Custom scrollbar for products grid */
        .products-grid.scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .products-grid.scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .products-grid.scrollable::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .products-grid.scrollable::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #d2b48c;
        }

        .product-card-header {
            position: relative;
            height: 100px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #dee2e6;
        }

        .product-image {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #f8f9fa;
        }

        .product-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-badge.low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .product-badge.in-stock {
            background: #d4edda;
            color: #155724;
        }

        .product-card-body {
            padding: 1rem;
        }

        .product-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            line-height: 1.3;
        }

        .product-category {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .product-pricing {
            margin-bottom: 0.75rem;
        }

        .product-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 0.25rem;
        }

        .product-price-unit {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .product-stock {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stock-low {
            background: #fff3cd;
            color: #856404;
        }

        .stock-ok {
            background: #d4edda;
            color: #155724;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .product-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            flex: 1;
        }

        .product-card-footer {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-id {
            font-size: 0.75rem;
            color: #6c757d;
            font-family: monospace;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .product-edit-btn {
            background: #d2b48c;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .product-edit-btn:hover {
            background: #bc9a6a;
            transform: translateY(-1px);
        }

        .product-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.375rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .product-qr-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-qr-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.5rem;
        }

        .empty-state p {
            margin: 0 0 2rem 0;
            font-size: 1rem;
        }

        /* Product Edit Modal Styles */
        .product-overview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .product-preview {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .product-image-preview {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 2px solid #dee2e6;
            overflow: hidden;
        }

        .product-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #f8f9fa;
        }

        .product-basic-info h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .product-basic-info p {
            margin: 0 0 0.75rem 0;
            color: #6c757d;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-stock-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stock-indicator {
            font-size: 1rem;
        }

        /* Stock Management Styles */
        .stock-management {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .current-stock {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .current-stock h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .stock-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .stock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-width: 80px;
        }

        .stock-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #28a745;
        }

        .stock-unit {
            font-size: 1rem;
            color: #6c757d;
        }

        .stock-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stock-action-group {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .stock-action-group .form-label {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .stock-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .stock-input-group .form-input {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .stock-input-group .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .stock-input-group select {
            min-width: 100px;
            flex: 0 0 auto;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* Responsive Card Grid */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 0.75rem;
                padding: 0.75rem;
            }
            
            .products-grid.scrollable {
                max-height: 60vh;
            }

            .product-preview {
                flex-direction: column;
                text-align: center;
            }

            .stock-actions {
                grid-template-columns: 1fr;
            }

            .stock-input-group {
                flex-direction: column;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .products-grid.scrollable {
                max-height: 50vh;
            }

            .product-card-body {
                padding: 0.75rem;
            }

            .product-name {
                font-size: 0.875rem;
            }

            .product-price {
                font-size: 1rem;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-actions {
                justify-content: stretch;
            }

            .product-stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }

            .filters-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .table-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .view-toggle {
                justify-content: center;
            }
        }
        
        /* Enhanced Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }

        .enhanced-modal {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 16px;
            width: 95%;
            max-width: 800px;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title-section h2 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-subtitle {
            margin: 0;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .modal-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        /* Enhanced Form Styles */
        .enhanced-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .form-section .section-header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }

        .form-section .section-header h3 {
            margin: 0;
            color: #495057;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
            font-size: 0.875rem;
        }

        .required {
            color: #dc3545;
            margin-left: 0.25rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #d2b48c;
            box-shadow: 0 0 0 3px rgba(210, 180, 140, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-prefix {
            position: absolute;
            left: 1rem;
            color: #6c757d;
            font-weight: 500;
            z-index: 1;
        }

        .input-group .form-input {
            padding-left: 2.5rem;
        }

        .form-help {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* Enhanced Image Upload */
        .image-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            background: #f8f9fa;
        }

        .image-upload-container:hover {
            border-color: #d2b48c;
            background: #f0f8ff;
        }

        .image-upload-area {
            cursor: pointer;
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .upload-icon {
            font-size: 2rem;
            color: #6c757d;
        }

        .upload-text {
            margin: 0;
            color: #495057;
            font-weight: 500;
        }

        .upload-hint {
            margin: 0;
            color: #6c757d;
            font-size: 0.75rem;
        }

        .image-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
        }

        /* Modal Actions */
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Responsive Modal */
        @media (max-width: 768px) {
            .enhanced-modal {
                margin: 1rem;
                width: calc(100% - 2rem);
                max-height: calc(100vh - 2rem);
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #000;
        }
        
        #productForm {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        /* Image Upload Styles */
        .image-upload-container {
            position: relative;
            width: 100%;
        }
        
        .image-upload-input {
            display: none;
        }
        
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-area:hover {
            border-color: #8b7355;
            background: #f5f5f5;
        }
        
        .image-upload-area.dragover {
            border-color: #8b7355;
            background: #f0f8ff;
        }
        
        .image-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .image-upload-icon {
            font-size: 2rem;
            color: #8b7355;
        }
        
        .image-upload-text {
            color: #666;
        }
        
        .upload-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .upload-subtitle {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .upload-formats {
            font-size: 0.75rem;
            color: #999;
        }
        
        .image-preview {
            position: relative;
            margin-top: 1rem;
            text-align: center;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-image-btn:hover {
            background: #c82333;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        
        /* Category and Stock Badges */
        .category-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .category-chicken {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        
        .category-pig {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }
        
        .type-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .stock-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            background: #d4edda;
            color: #155724;
        }
        
        .stock-badge.low-stock {
            background: #f8d7da;
            color: #721c24;
        }
        
        .pricing-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .price-item {
            font-size: 0.85em;
            color: #2e7d32;
            font-weight: 500;
        }
        
        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .stock-info .stock-badge {
            font-size: 0.8em;
            padding: 2px 6px;
        }
        
        .product-pricing {
            display: flex;
            gap: 10px;
            margin: 5px 0;
        }
        
        .price-option {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .product-stock {
            display: flex;
            gap: 10px;
            margin: 5px 0;
        }
        
        .stock-option {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        /* QR Modal Styles */
        .qr-content {
            padding: 2rem;
            text-align: center;
        }
        
        .product-info {
            margin-bottom: 2rem;
        }
        
        .product-info h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .product-info p {
            color: #666;
            margin: 0;
        }
        
        .qr-code-container {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
        }
        
        #qrCanvas {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
        }
        
        .qr-info {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .qr-info p {
            margin: 0.5rem 0;
            color: #666;
        }
        
        .qr-url {
            font-family: monospace;
            font-size: 0.875rem;
            color: #007bff;
            word-break: break-all;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .qr-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        /* Animation for notifications */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Analytics Styles */
        .time-period-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .period-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            background: #f8f9fa;
            color: #495057;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .period-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
            transform: translateY(-1px);
        }
        
        .period-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .date-input {
            padding: 0.5rem;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .analytics-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .analytics-card h3 {
            color: #666;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .analytics-number {
            font-size: 2rem;
            font-weight: bold;
            color: #dc3545;
        }
        
        .analytics-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .chart {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 5px;
            color: #666;
        }
        
        .top-products {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .top-products h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .top-products-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .top-product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .recent-sales {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .recent-sales h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .sales-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .sales-table th,
        .sales-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .sales-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .sales-table tr:hover {
            background: #f8f9fa;
        }
        
        /* Purchase Modal Styles */
        .product-purchase-info {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .product-details {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .product-details h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .product-description {
            color: #666;
            margin-bottom: 1rem;
        }
        
        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .product-category {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .product-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .product-stock {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Staff Management Styles */
        .staff-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .staff-table-container {
            background: white;
            border-radius: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .staff-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .staff-table th,
        .staff-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .staff-table th {
            background: #f8f9fa;
        }
        
        /* Newest Sale Highlighting Styles */
        .newest-sale {
            animation: newestSalePulse 2s ease-in-out;
        }
        
        @keyframes newestSalePulse {
            0% { 
                background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
                transform: scale(1);
            }
            50% { 
                background: linear-gradient(135deg, #d4edda 0%, #e8f5e8 100%);
                transform: scale(1.02);
            }
            100% { 
                background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
                transform: scale(1);
            }
        }
        
        .newest-sale:hover {
            background: linear-gradient(135deg, #d4edda 0%, #e8f5e8 100%) !important;
            transform: scale(1.01);
            transition: all 0.3s ease;
        }
        
        /* QR Scanner Styles */
        .qr-scanner-section {
            background: #f8f9fa;
            border: 2px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .scanner-header h3 {
            color: #8b7355;
            margin-bottom: 0.5rem;
        }
        
        .scanner-header p {
            color: #666;
            margin-bottom: 1rem;
        }
        
        .scanner-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .scanner-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #d2b48c;
            border-radius: 8px;
            font-size: 1rem;
            background: #f5f5dc;
            color: #8b7355;
            transition: all 0.3s ease;
        }
        
        .scanner-input:focus {
            outline: none;
            border-color: #8b7355;
            box-shadow: 0 0 0 3px rgba(139, 115, 85, 0.1);
        }
        
        .scanner-status {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .scanner-status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .scanner-status.scanning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .scanner-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Category and Scanner Container */
        .category-and-scanner-container {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }
        
        .category-buttons {
            flex: 1;
        }
        
        /* Inline QR Scanner Styles */
        .qr-scanner-inline {
            flex: 0 0 auto;
            min-width: 300px;
            max-width: 100%;
            padding: 1rem;
            background: #f8f9fa;
            border: 1px solid #d2b48c;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .qr-scanner-inline .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .scanner-title-section {
            flex: 1;
            min-width: 120px;
        }
        
        .qr-scanner-inline .scanner-header h4 {
            color: #8b7355;
            margin-bottom: 0.25rem;
            font-size: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .qr-scanner-inline .scanner-header p {
            color: #666;
            margin-bottom: 0;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .scanner-input-group-horizontal {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            margin-left: 1rem;
            align-items: center;
            min-width: 0;
            flex: 1;
        }
        
        .qr-scanner-inline .scanner-input {
            font-size: 0.9rem;
            padding: 0.6rem 0.8rem;
            flex: 1;
            min-width: 0;
        }
        
        .qr-scanner-inline .scanner-status {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Responsive design for smaller screens */
        @media (max-width: 1024px) {
            .category-and-scanner-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .qr-scanner-inline {
                flex: none;
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .qr-scanner-inline .scanner-input {
                flex: 1;
                min-width: 120px;
            }

            .qr-scanner-inline .scanner-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .scanner-input-group-horizontal {
                flex-direction: column;
                margin-left: 0;
                width: 100%;
            }

            .qr-scanner-inline .scanner-header h4 {
                font-size: 0.9rem;
            }

            .qr-scanner-inline .scanner-header p {
                font-size: 0.75rem;
            }
        }
        
        .staff-table tr:hover {
            background: #f8f9fa;
        }
        
        .staff-name {
            font-weight: 600;
            color: #333;
        }
        
        .staff-email {
            color: #666;
            font-size: 0.9rem;
        }
        
        .staff-role {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .role-admin {
            background: #ffebee;
            color: #c62828;
        }
        
        .role-manager {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .role-cashier {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .role-staff {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .staff-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-inactive {
            background: #ffebee;
            color: #c62828;
        }
        
        .staff-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .staff-actions .btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .staff-created {
            color: #666;
            font-size: 0.9rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .purchase-options {
            margin-bottom: 1.5rem;
        }
        
        .purchase-options h4 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .option-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .purchase-option-btn {
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            text-align: left;
        }
        
        .purchase-option-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .purchase-option-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .quantity-section {
            margin-bottom: 1.5rem;
        }
        
        .quantity-section h4 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .quantity-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .quantity-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .total-price {
            font-size: 1.2rem;
            color: #28a745;
            font-weight: bold;
            text-align: center;
        }
        
        .customer-info {
            margin-bottom: 1.5rem;
        }
        
        .customer-info h4 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .purchase-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Image Upload Styles */
        .image-upload-container {
            margin-bottom: 1rem;
        }

        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .image-upload-area:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .image-upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-icon {
            font-size: 2rem;
            opacity: 0.6;
        }

        .upload-placeholder p {
            margin: 0;
            color: #666;
            font-weight: 500;
        }

        .upload-placeholder small {
            color: #999;
            font-size: 0.8rem;
        }

        .image-actions {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
        }

        .image-preview-container img {
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Sales Forecasting Styles */
        .forecast-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .forecast-card {
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .forecast-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #d2b48c;
            border-radius: 50%;
        }
        
        .forecast-content h3 {
            color: #8b7355;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .forecast-value {
            color: #8b7355;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .forecast-change {
            color: #a09080;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .forecast-subtitle {
            color: #a09080;
            font-size: 0.9rem;
        }
        
        .forecast-progress {
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #d2b48c;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }
        
        .progress-fill {
            height: 100%;
            background: #8b7355;
            transition: width 0.3s ease;
        }
        
        .forecast-trend {
            font-size: 1.2rem;
        }
        
        .forecast-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .forecast-controls {
            display: none !important;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            flex-wrap: wrap;
        }
        
        .forecast-charts {
            display: none !important;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-group label {
            color: #8b7355;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .forecast-select {
            padding: 0.5rem 1rem;
            border: 1px solid #d2b48c;
            border-radius: 6px;
            background: #f5f5dc;
            color: #8b7355;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .forecast-select:focus {
            outline: none;
            border-color: #8b7355;
            box-shadow: 0 0 0 2px rgba(139, 115, 85, 0.1);
        }
        
        .forecast-table-container {
            margin-bottom: 2rem;
        }
        
        .forecast-table-container h3 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            background: #f5f5dc;
        }
        
        .forecast-table th,
        .forecast-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #d2b48c;
        }
        
        .forecast-table th {
            background: #d2b48c;
            color: #8b7355;
            font-weight: 600;
        }
        
        .forecast-table td {
            color: #8b7355;
        }
        
        .forecast-table tr:hover {
            background: rgba(210, 180, 140, 0.1);
        }
        
        .forecast-insights {
            margin-top: 2rem;
        }
        
        .forecast-insights h3 {
            color: #8b7355;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .insight-card {
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .insight-card h4 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .insight-card ul {
            list-style: none;
            padding: 0;
        }
        
        .insight-card li {
            color: #8b7355;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(210, 180, 140, 0.2);
        }
        
        .insight-card li:last-child {
            border-bottom: none;
        }
        
        .insight-card li:before {
            content: "";
            color: #d2b48c;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        /* Sales Graph Styles */
        .sales-graph-section {
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .chart-header h3 {
            color: black;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }
        
        .chart-header .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .chart-btn {
            background: #d2b48c;
            color: black;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .chart-btn:hover {
            background: #bc9a6a;
            transform: translateY(-1px);
        }
        
        .chart-btn.active {
            background: #8b7355;
            color: white;
        }
        
        /* Daily Sales Styles */
        .daily-sales-overview {
            margin-bottom: 2rem;
        }
        
        .daily-sales-overview h3 {
            color: #8b7355;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }
        
        .daily-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .daily-stat-card {
            background: #f5f5dc;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .daily-stat-card .stat-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #d2b48c;
            border-radius: 50%;
        }
        
        .daily-stat-card .stat-content h4 {
            color: #8b7355;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .daily-stat-card .stat-value {
            color: #8b7355;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .daily-stat-card .stat-subtitle {
            color: #a09080;
            font-size: 0.8rem;
        }
        
        .recent-sales-section {
            margin-bottom: 2rem;
        }
        
        .recent-sales-section h3 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .recent-sales-table {
            width: 100%;
            border-collapse: collapse;
            background: #f5f5dc;
        }
        
        .recent-sales-table th,
        .recent-sales-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #d2b48c;
        }
        
        .recent-sales-table th {
            background: #d2b48c;
            color: #8b7355;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .recent-sales-table td {
            color: #8b7355;
            font-size: 0.9rem;
        }
        
        .recent-sales-table tr:hover {
            background: rgba(210, 180, 140, 0.1);
        }
        
        .status-completed {
            color: #8b7355;
            font-weight: 600;
        }
        
        .status-pending {
            color: #a09080;
        }

        /* Clickable Card Styles */
        .clickable-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .clickable-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #8b7355;
        }

        .click-hint {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-size: 0.7rem;
            color: #8b7355;
            opacity: 0.7;
            font-weight: 500;
        }

        .clickable-card:hover .click-hint {
            opacity: 1;
            color: #8b7355;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #f5f5dc;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #d2b48c 0%, #bc9a6a 100%);
            color: #8b7355;
            padding: 1.5rem 2rem;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #8b7355;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close {
            color: #8b7355;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #6b5b47;
        }

        .modal-body {
            padding: 2rem;
        }

        .sales-summary {
            margin-bottom: 2rem;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .summary-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #d2b48c;
            border-radius: 50%;
        }

        .summary-content h4 {
            color: #8b7355;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .summary-value {
            color: #8b7355;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .sales-breakdown {
            margin-bottom: 2rem;
        }

        .sales-breakdown h3 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .breakdown-card {
            background: white;
            border: 1px solid #d2b48c;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .breakdown-card h4 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #d2b48c;
        }

        .breakdown-label {
            font-weight: 600;
            color: #8b7355;
            flex: 1;
        }

        .breakdown-value {
            color: #6c757d;
            font-size: 0.9rem;
            margin-right: 1rem;
        }

        .breakdown-percentage {
            background: #d2b48c;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .top-products-modal,
        .recent-transactions {
            margin-bottom: 2rem;
        }

        .top-products-modal h3,
        .recent-transactions h3 {
            color: #8b7355;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .modal-table th {
            background: #d2b48c;
            color: #8b7355;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .modal-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            color: #8b7355;
            font-size: 0.9rem;
        }

        .modal-table tr:hover {
            background: rgba(210, 180, 140, 0.1);
        }

        .modal-footer {
            background: #f8f9fa;
            padding: 1.5rem 2rem;
            border-top: 1px solid #d2b48c;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .modal-footer .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-footer .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-footer .btn-secondary:hover {
            background: #5a6268;
        }

        .modal-footer .btn-primary {
            background: #8b7355;
            color: white;
        }

        .modal-footer .btn-primary:hover {
            background: #6b5b47;
        }

        /* Bulk Cost Update Modal Styles */
        .bulk-update-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #8b7355;
        }

        .bulk-update-info h3 {
            color: #8b7355;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .bulk-update-info p {
            color: #6c757d;
            margin: 0;
            font-size: 0.9rem;
        }

        .product-selection {
            border: 1px solid #d2b48c;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }

        .selection-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .products-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }

        .product-checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }

        .product-checkbox-item:hover {
            background-color: #f8f9fa;
        }

        .product-checkbox-item:last-child {
            border-bottom: none;
        }

        .product-checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
            transform: scale(1.2);
        }

        .product-checkbox-info {
            flex: 1;
        }

        .product-checkbox-name {
            font-weight: 600;
            color: #8b7355;
            margin-bottom: 0.25rem;
        }

        .product-checkbox-details {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .product-checkbox-cost {
            font-size: 0.9rem;
            color: #8b7355;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .breakdown-grid {
                grid-template-columns: 1fr;
            }

            .selection-controls {
                flex-direction: column;
            }

            .btn-sm {
                width: 100%;
                margin-bottom: 0.25rem;
            }
        }

        /* Responsive Design - Tablet (768px to 1023px) */
        @media (max-width: 63.9375em) {
            .dashboard-layout {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                padding: 1rem 0;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .sidebar-header {
                padding: 0 1rem 1rem 1rem;
            }

            .nav-btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.95rem;
            }

            .main-content {
                padding: 1.5rem;
            }

            .container {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-content h3 {
                font-size: 0.8rem;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            /* Staff table responsive sizing */
            .staff-table th,
            .staff-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .staff-name {
                font-size: 0.85rem;
            }

            .staff-email {
                font-size: 0.8rem;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .section {
                padding: 1.5rem;
            }

            .welcome-section {
                padding: 1.5rem;
            }

            .welcome-section h1 {
                font-size: 1.5rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            /* Forecasting responsive sizing */
            .forecast-table th,
            .forecast-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }

            .forecast-table-container h3 {
                font-size: 1rem;
            }

            .recent-sales-table th,
            .recent-sales-table td {
                padding: 0.6rem 0.5rem;
                font-size: 0.8rem;
            }

            .recent-sales-section h3 {
                font-size: 1rem;
            }

            .insight-card {
                padding: 1rem;
            }

            .insight-card h4 {
                font-size: 0.95rem;
                margin-bottom: 0.75rem;
            }

            .insight-card li {
                font-size: 0.85rem;
                padding: 0.35rem 0;
            }

            /* Staff table responsive sizing for tablet */
            .staff-table th,
            .staff-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .staff-name {
                font-size: 0.85rem;
            }

            .staff-email {
                font-size: 0.8rem;
            }
        }

        /* Responsive Design - Mobile (480px to 767px) */
        @media (max-width: 47.9375em) {
            body {
                font-size: 14px;
            }

            .header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .logo {
                font-size: 1.2rem;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .dashboard-layout {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                padding: 0.75rem 0;
            }

            .sidebar-header {
                padding: 0 1rem 0.75rem 1rem;
            }

            .sidebar-title {
                font-size: 1.2rem;
            }

            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding: 0 1rem;
            }

            .nav-item {
                flex-shrink: 0;
            }

            .nav-btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }

            .nav-icon {
                font-size: 1.2rem;
            }

            .main-content {
                padding: 1rem;
            }

            .container {
                padding: 1rem;
                max-width: 100%;
            }

            .welcome-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .welcome-section h1 {
                font-size: 1.3rem;
            }

            .welcome-section p {
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .stat-card p {
                font-size: 0.85rem;
            }

            .stat-content h3 {
                font-size: 0.7rem;
            }

            .stat-number {
                font-size: 1.2rem;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            /* Staff table responsive sizing for mobile */
            .staff-table th,
            .staff-table td {
                padding: 0.5rem 0.3rem;
                font-size: 0.75rem;
            }

            .staff-name {
                font-size: 0.75rem;
            }

            .staff-email {
                font-size: 0.7rem;
            }

            .product-card {
                margin-bottom: 1rem;
            }

            .product-image {
                height: 120px;
                font-size: 1.5rem;
            }

            .product-info {
                padding: 0.75rem;
            }

            .product-name {
                font-size: 1rem;
            }

            .product-category {
                font-size: 0.8rem;
            }

            .product-price {
                font-size: 1rem;
            }

            .section {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .section h2 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .tabs {
                flex-direction: column;
                border-bottom: none;
            }

            .tab {
                padding: 0.5rem 1rem;
                border-bottom: 1px solid #e1e5e9;
                border-left: 2px solid transparent;
            }

            .tab.active {
                border-bottom-color: #e1e5e9;
                border-left-color: #d2b48c;
            }

            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
                margin-right: 0.25rem;
                margin-bottom: 0.5rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions button {
                width: 100%;
            }

            .low-stock-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .stock-breakdown {
                width: 100%;
                flex-wrap: wrap;
            }

            .product-actions {
                width: 100%;
                flex-wrap: wrap;
            }

            /* Forecasting responsive sizing for mobile */
            .forecast-table th,
            .forecast-table td {
                padding: 0.5rem 0.3rem;
                font-size: 0.7rem;
            }

            .forecast-table-container h3 {
                font-size: 0.9rem;
            }

            .recent-sales-table th,
            .recent-sales-table td {
                padding: 0.4rem 0.3rem;
                font-size: 0.7rem;
            }

            .recent-sales-section h3 {
                font-size: 0.9rem;
            }

            .insight-card {
                padding: 0.75rem;
            }

            .insight-card h4 {
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
            }

            .insight-card li {
                font-size: 0.75rem;
                padding: 0.25rem 0;
            }

            .forecast-insights {
                margin-top: 1.5rem;
            }

            .forecast-insights h3 {
                font-size: 0.9rem;
            }

            .insights-grid {
                gap: 1rem;
            }
        }

        /* Responsive Design - Small Mobile (Below 480px) */
        @media (max-width: 29.9375em) {
            * {
                font-size: 13px;
            }

            .header {
                padding: 0.5rem 0.75rem;
            }

            .logo {
                font-size: 1rem;
            }

            .sidebar {
                padding: 0.5rem 0;
            }

            .nav-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }

            .main-content {
                padding: 0.75rem;
            }

            .container {
                padding: 0.75rem;
            }

            .welcome-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .welcome-section h1 {
                font-size: 1.1rem;
            }

            .stats-grid {
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .stat-card h3 {
                font-size: 1.2rem;
            }

            .section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .section h2 {
                font-size: 1rem;
            }

            .product-image {
                height: 100px;
                font-size: 1.2rem;
            }

            .product-info {
                padding: 0.5rem;
            }

            .btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }

            /* Forecasting responsive sizing for small mobile */
            .forecast-table th,
            .forecast-table td {
                padding: 0.3rem 0.2rem;
                font-size: 0.65rem;
            }

            .recent-sales-table th,
            .recent-sales-table td {
                padding: 0.3rem 0.2rem;
                font-size: 0.65rem;
            }

            .insight-card h4 {
                font-size: 0.8rem;
            }

            .insight-card li {
                font-size: 0.65rem;
            }

            /* Staff table responsive sizing for small mobile */
            .staff-table th,
            .staff-table td {
                padding: 0.3rem 0.2rem;
                font-size: 0.65rem;
            }

            .staff-name {
                font-size: 0.65rem;
            }

            .staff-email {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo"> ZYMOUNE - Admin</div>
        <div class="user-info">
            <span id="userName">Welcome, Admin!</span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Admin Panel</h2>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <button class="nav-btn active" data-section="dashboard">
                        <span class="nav-icon"></span>
                        Dashboard
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" data-section="products">
                        <span class="nav-icon"></span>
                        Product Management
                    </button>
                </li>
                <!-- Sales Analytics button hidden
                <li class="nav-item">
                    <button class="nav-btn" data-section="analytics">
                        <span class="nav-icon"></span>
                        Sales Analytics
                    </button>
                </li>
                -->
                <li class="nav-item">
                    <button class="nav-btn" data-section="forecasting">
                        <span class="nav-icon"></span>
                        Sales Forecasting
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-btn" data-section="staff">
                        <span class="nav-icon"></span>
                        Staff Management
                    </button>
                </li>
            </ul>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <h1 class="section-title">Dashboard Overview</h1>
                <div class="welcome-section">
                    <h2 id="welcomeMessage">Welcome back, Admin!</h2>
                    <p>Manage your feed store efficiently</p>
                </div>
                
                <!-- Printer Test Section -->
        <!-- Printer test tools hidden as requested -->
        <div class="printer-test-section" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #495057;">
                 Thermal Printer Test Tools
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="testPrint()" style="padding: 10px 15px; font-size: 14px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                     Test Print
                </button>
                <button onclick="diagnosePrinter()" style="padding: 10px 15px; font-size: 14px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                     Diagnose Printer
                </button>
                <button onclick="window.open('THERMAL_PRINTER_TROUBLESHOOTING.md', '_blank')" style="padding: 10px 15px; font-size: 14px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                     Troubleshooting Guide
                </button>
            </div>
                </div>
                
                <!-- Sales Graph Section -->
                <div class="sales-graph-section">
                    <div class="chart-header">
                        <h3> Sales Performance</h3>
                        <button class="btn btn-secondary" id="downloadChartBtn">
                            <span></span> Download Chart
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart" width="800" height="400"></canvas>
                    </div>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="7">Last 7 Days</button>
                        <button class="chart-btn" data-period="30">Last 30 Days</button>
                        <button class="chart-btn" data-period="90">Last 3 Months</button>
                    </div>
                </div>
                
            </div>
            
            <!-- Product Management Section -->
            <div id="products" class="content-section">
                <!-- Enhanced Header -->
                <div class="section-header">
                    <div class="header-content">
                        <h1 class="section-title"> Product Management</h1>
                        <p class="section-subtitle">Manage your inventory, track stock levels, and organize products</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="loadProducts()" title="Refresh Products">
                            <span></span> Refresh
                        </button>
                        <button class="btn btn-secondary" id="exportProductsBtn" style="display: none;">
                            <span></span> Export Data
                        </button>
                        <button class="btn btn-secondary" id="bulkCostUpdateBtn" style="display: none;">
                            <span></span> Bulk Cost Update
                        </button>
                        <button class="btn btn-primary" id="addProductBtn">
                            <span></span> Add New Product
                        </button>
                    </div>
                </div>

                <!-- Product Statistics Cards -->
                <div class="product-stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <h3>Total Products</h3>
                            <div class="stat-number" id="totalProductsCount">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <h3>Pig Products</h3>
                            <div class="stat-number" id="pigProductsCount">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <h3>Chicken Products</h3>
                            <div class="stat-number" id="chickenProductsCount">0</div>
                        </div>
                    </div>
                    <div class="stat-card clickable" id="lowStockCard" onclick="showLowStockModal()">
                        <div class="stat-icon"></div>
                        <div class="stat-content">
                            <h3>Low Stock</h3>
                            <div class="stat-number" id="lowStockCount">0</div>
                            <div class="stat-instruction">CLICK TO ADD STOCK</div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Filters Section -->
                <div class="filters-section">
                    <div class="filters-header" style="display: none;">
                        <h3> Filter & Search</h3>
                        <button class="btn btn-sm btn-secondary" id="clearFiltersBtn">Clear All</button>
                    </div>
                    
                    <div class="filters-content">
                        <div class="filter-group">
                            <label class="filter-label">Animal Category</label>
                            <div class="category-and-scanner-container">
                            <div class="category-buttons">
                                <button class="category-btn active" data-category="">
                                    <span class="btn-icon"></span>
                                    <span class="btn-text">All Products</span>
                                </button>
                                <div class="animal-category-group">
                                    <button class="category-btn" data-category="pig">
                                        <span class="btn-icon"></span>
                                        <span class="btn-text">PIG</span>
                                    </button>
                                    <div class="subcategory-buttons" id="pigSubcategories">
                                        <button class="subcategory-btn active" data-subcategory="">
                                            All Types
                                        </button>
                                        <button class="subcategory-btn" data-subcategory="feeds">
                                             Feeds
                                        </button>
                                        <button class="subcategory-btn" data-subcategory="supplements">
                                             Supplements
                                        </button>
                                    </div>
                                </div>
                                <div class="animal-category-group">
                                    <button class="category-btn" data-category="chicken">
                                        <span class="btn-icon"></span>
                                        <span class="btn-text">CHICKEN</span>
                                    </button>
                                    <div class="subcategory-buttons" id="chickenSubcategories">
                                        <button class="subcategory-btn active" data-subcategory="">
                                            All Types
                                        </button>
                                        <button class="subcategory-btn" data-subcategory="feeds">
                                             Feeds
                                        </button>
                                        <button class="subcategory-btn" data-subcategory="supplements">
                                             Supplements
                                        </button>
                                </div>
                            </div>
                        </div>
                        
                                <!-- QR Scanner on the right side -->
                                <div class="qr-scanner-inline">
                                    <div class="scanner-header">
                                        <div class="scanner-title-section">
                                            <h4> QR Scanner</h4>
                                        </div>
                                        <div class="scanner-input-group-horizontal">
                                            <input type="text" id="adminQrInput" placeholder="Scan QR code or enter product ID..." class="scanner-input">
                                            <button class="btn btn-primary" onclick="scanProductForEdit()"> Scan</button>
                                        </div>
                                    </div>
                                    <div class="scanner-status" id="adminScannerStatus">Ready to scan</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Product Cards Section -->
                <div class="cards-section">
                    <div class="cards-header">
                        <h3> Product Inventory</h3>
                        <div class="cards-info">
                            <span id="cardsInfo">Showing 0 products</span>
                        </div>
                    </div>
                    
                    <!-- Product Cards Grid -->
                    <div class="products-grid" id="productsGrid">
                        <!-- Product cards will be loaded here -->
                    </div>
                    
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="empty-icon"></div>
                        <h3>No Products Found</h3>
                        <p>No products match your current filters. Try adjusting your search criteria.</p>
                        <button class="btn btn-primary" id="addFirstProductBtn">
                            <span></span> Add Your First Product
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sales Analytics Section -->
            <div id="analytics" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Sales Analytics</h1>
                    <div class="time-period-selector">
                        <button id="dayViewBtn" class="period-btn active" data-period="day"> DAY</button>
                        <button id="monthViewBtn" class="period-btn" data-period="month"> MONTH</button>
                        <button id="yearViewBtn" class="period-btn" data-period="year"> YEAR</button>
                    </div>
                </div>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Total Sales</h3>
                        <div class="analytics-number" id="totalSales">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Total Revenue</h3>
                        <div class="analytics-number" id="totalRevenue">0.00</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Chicken Sales</h3>
                        <div class="analytics-number" id="chickenSales">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Pig Sales</h3>
                        <div class="analytics-number" id="pigSales">0</div>
                    </div>
                </div>
                
                <div class="analytics-charts">
                    <div class="chart-container">
                        <h3>Sales by Animal</h3>
                        <div id="animalChart" class="chart"></div>
                    </div>
                    <div class="chart-container">
                        <h3>Sales by Category</h3>
                        <div id="categoryChart" class="chart"></div>
                    </div>
                </div>
                
                <div class="top-products">
                    <h3>Top Selling Products</h3>
                    <div id="topProductsList" class="top-products-list">
                        <!-- Top products will be loaded here -->
                    </div>
                </div>
                
                <div class="recent-sales">
                    <h3>Recent Sales</h3>
                    <div class="table-container">
                        <table class="sales-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Customer</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Total</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="analyticsRecentSalesTableBody">
                                <!-- Recent sales will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px 0;">
                        <div class="pagination-info">
                            <span id="salesPaginationInfo">Page 1 of 1</span>
                        </div>
                        <div class="pagination-buttons" style="display: flex; gap: 5px;">
                            <button id="prevSalesPage" class="pagination-btn" disabled style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Previous</button>
                            <div id="salesPageNumbers" style="display: flex; gap: 3px;">
                                <!-- Page numbers will be generated here -->
                            </div>
                            <button id="nextSalesPage" class="pagination-btn" disabled style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Next</button>
                        </div>
                    </div>
                    
                    <!-- Total Sales Summary -->
                    <div class="total-sales-summary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; color: #333;">Total Sales Summary:</span>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #666;">Total Transactions: <span id="totalSalesCount">0</span></div>
                                <div style="font-size: 16px; font-weight: bold; color: #2c5530;">Total Revenue: <span id="totalSalesRevenue">0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sales Forecasting Section -->
            <div id="forecasting" class="content-section">
                <div class="section-header">
                    <h1 class="section-title"> Sales Forecasting</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="refreshForecastBtn" style="display: none;">
                            <span></span> Refresh Forecast
                        </button>
                        <button class="btn btn-primary" id="refreshDailySalesBtn" onclick="updateDailySalesDisplay()" style="display: none;">
                            <span></span> Refresh Daily Sales
                        </button>
                        <button class="btn btn-warning" id="recalculateSalesBtn" onclick="recalculateSales()">
                            <span></span> Recalculate Profits
                        </button>
                        <button class="btn btn-primary" id="exportForecastBtn">
                            <span></span> Export Report
                        </button>
                        <button class="btn btn-danger" id="resetAllSalesBtn" onclick="resetAllSales()">
                            <span></span> Reset All Sales
                        </button>
                    </div>
                </div>
                
                <!-- Forecasting Overview Cards -->
                <div class="forecast-overview">
                    <div class="forecast-card">
                        <div class="forecast-icon"></div>
                        <div class="forecast-content">
                            <h3>Next Month Forecast</h3>
                            <div class="forecast-value" id="nextMonthForecast">0.00</div>
                            <div class="forecast-change" id="nextMonthChange">+0%</div>
                        </div>
                    </div>
                    
                    <div class="forecast-card">
                        <div class="forecast-icon"></div>
                        <div class="forecast-content">
                            <h3>Quarterly Target</h3>
                            <div class="forecast-value" id="quarterlyTarget">0.00</div>
                            <div class="forecast-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="quarterlyProgress" style="width: 0%"></div>
                                </div>
                                <span id="quarterlyPercentage">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="forecast-card">
                        <div class="forecast-icon"></div>
                        <div class="forecast-content">
                            <h3>Growth Rate</h3>
                            <div class="forecast-value" id="growthRate">0%</div>
                            <div class="forecast-trend" id="growthTrend"></div>
                        </div>
                    </div>
                    
                    <div class="forecast-card">
                        <div class="forecast-icon"></div>
                        <div class="forecast-content">
                            <h3>Top Product</h3>
                            <div class="forecast-value" id="topProduct">-</div>
                            <div class="forecast-subtitle" id="topProductSales">0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Daily Sales Overview -->
                <div class="daily-sales-overview">
                    <h3> Sales Performance</h3>
                    <div class="daily-stats">
                        <div class="daily-stat-card clickable-card" data-period="today" onclick="showSalesDetailModal('today')">
                            <div class="stat-icon"></div>
                            <div class="stat-content">
                                <h4>Today's Sales</h4>
                                <div class="stat-value" id="todaySales">0.00</div>
                                <div class="stat-subtitle" id="todayOrders">0 items</div>
                                <div class="click-hint">Click for details</div>
                            </div>
                        </div>
                        
                        <div class="daily-stat-card clickable-card" data-period="yesterday" onclick="showSalesDetailModal('yesterday')">
                            <div class="stat-icon"></div>
                            <div class="stat-content">
                                <h4>Yesterday</h4>
                                <div class="stat-value" id="yesterdaySales">0.00</div>
                                <div class="stat-subtitle" id="yesterdayOrders">0 items</div>
                                <div class="click-hint">Click for details</div>
                            </div>
                        </div>
                        
                        <div class="daily-stat-card clickable-card" data-period="week" onclick="showSalesDetailModal('week')">
                            <div class="stat-icon"></div>
                            <div class="stat-content">
                                <h4>This Week</h4>
                                <div class="stat-value" id="weekSales">0.00</div>
                                <div class="stat-subtitle" id="weekOrders">0 items</div>
                                <div class="click-hint">Click for details</div>
                            </div>
                        </div>
                        
                        <div class="daily-stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-content">
                                <h4>Daily Average</h4>
                                <div class="stat-value" id="dailyAverage">0.00</div>
                                <div class="stat-subtitle" id="avgOrders">0 items/day</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Sales Table -->
                <div class="recent-sales-section">
                    <h3> Recent Sales</h3>
                    <div class="table-container">
                        <table class="recent-sales-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentSalesTableBody">
                                <!-- Recent sales will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls for Forecasting Recent Sales (Hidden - showing all sales) -->
                    <div class="forecasting-pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px 0;">
                        <div class="pagination-info">
                            <span id="forecastingPaginationInfo">Page 1 of 1</span>
                        </div>
                        <div class="pagination-buttons" style="display: flex; gap: 5px;">
                            <button id="prevForecastingPage" class="pagination-btn" disabled style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Previous</button>
                            <div id="forecastingPageNumbers" style="display: flex; gap: 3px;">
                                <!-- Page numbers will be generated here -->
                            </div>
                            <button id="nextForecastingPage" class="pagination-btn" disabled style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">Next</button>
                        </div>
                    </div>
                    
                    <!-- Total Sales Summary for Recent Sales -->
                    <div class="recent-sales-summary" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;"></span>
                                <span style="font-weight: bold; color: #333; font-size: 16px;">Recent Sales Summary:</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                                    Total Orders: <span id="recentSalesCount" style="font-weight: bold; color: #2c5530;">0</span>
                                </div>
                                <div style="font-size: 18px; font-weight: bold; color: #2c5530;">
                                    Total Revenue: <span id="recentSalesTotal">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Forecasting Charts -->
                <div class="forecast-charts" style="display: none !important;">
                    <div class="chart-container">
                        <h3>Sales Trend Analysis</h3>
                        <canvas id="salesTrendChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Product Performance Forecast</h3>
                        <canvas id="productForecastChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Forecasting Controls -->
                <div class="forecast-controls">
                    <div class="control-group">
                        <label for="forecastPeriod">Forecast Period:</label>
                        <select id="forecastPeriod" class="forecast-select">
                            <option value="1">1 Month</option>
                            <option value="3" selected>3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12">1 Year</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="forecastMethod">Forecasting Method:</label>
                        <select id="forecastMethod" class="forecast-select">
                            <option value="trend">Trend Analysis</option>
                            <option value="seasonal" selected>Seasonal</option>
                            <option value="moving">Moving Average</option>
                            <option value="exponential">Exponential Smoothing</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="productFilter">Product Category:</label>
                        <select id="productFilter" class="forecast-select">
                            <option value="all">All Products</option>
                            <option value="feeds">Feeds Only</option>
                            <option value="supplements">Supplements Only</option>
                            <option value="chicken">Chicken Products</option>
                            <option value="pig">Pig Products</option>
                        </select>
                    </div>
                </div>
                
                <!-- Detailed Forecast Table -->
                <div class="forecast-table-container">
                    <h3>Detailed Forecast Breakdown</h3>
                    <div class="table-container">
                        <table class="forecast-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Current Sales</th>
                                    <th>Forecasted Sales</th>
                                    <th>Growth %</th>
                                    <th>Confidence</th>
                                    <th>Recommendation</th>
                                </tr>
                            </thead>
                            <tbody id="forecastTableBody">
                                <!-- Forecast data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Forecasting Insights -->
                <div class="forecast-insights">
                    <h3> Forecasting Insights</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4> Key Opportunities</h4>
                            <ul id="opportunitiesList">
                                <li>Loading opportunities...</li>
                            </ul>
                        </div>
                        
                        <div class="insight-card">
                            <h4> Risk Factors</h4>
                            <ul id="risksList">
                                <li>Loading risk factors...</li>
                            </ul>
                        </div>
                        
                        <div class="insight-card">
                            <h4> Recommendations</h4>
                            <ul id="recommendationsList">
                                <li>Loading recommendations...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Management Section -->
            <div id="staff" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Staff Management</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="refreshStaffBtn">
                            <span></span> Refresh
                        </button>
                        <button class="btn btn-danger" id="clearAllStaffBtn">
                            <span></span> Clear All Staff
                        </button>
                        <button class="btn btn-primary" id="addStaffBtn">
                            <span></span> Add New Staff
                        </button>
                    </div>
                </div>
                
                <div class="staff-stats">
                    <div class="stat-card">
                        <h3>Total Staff</h3>
                        <div class="stat-number" id="totalStaff">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Staff</h3>
                        <div class="stat-number" id="activeStaff">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Invitations</h3>
                        <div class="stat-number" id="pendingStaff">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Paused Accounts</h3>
                        <div class="stat-number" id="pausedStaff">0</div>
                    </div>
                </div>
                
                <div class="staff-table-container">
                    <table class="staff-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- Staff data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Enhanced Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content enhanced-modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 id="modalTitle"> Add New Product - CACHE TEST</h2>
                    <p class="modal-subtitle">Fill in the product details below</p>
                </div>
                <button class="close" id="closeModal">
                    <span>&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="productForm" class="enhanced-form">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Basic Information</h3>
                        </div>
                        <div class="form-group">
                            <label for="productName" class="form-label">
                                Product Name <span class="required">*</span>
                            </label>
                            <input type="text" id="productName" name="name" class="form-input" placeholder="Enter product name" required>
                            <div class="form-help">Choose a descriptive name for your product</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea id="productDescription" name="description" class="form-textarea" rows="3" placeholder="Enter product description (optional)"></textarea>
                            <div class="form-help">Provide additional details about the product</div>
                        </div>
                    </div>

                    <!-- Product Image Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Product Image</h3>
                        </div>
                        <div class="form-group">
                            <label for="productImage" class="form-label">Product Image</label>
                            <div class="image-upload-container">
                                <input type="file" id="productImage" name="image" class="image-upload-input" accept="image/*" onchange="handleImageUpload(event)">
                                <div class="image-upload-area" onclick="document.getElementById('productImage').click()">
                                    <div class="image-upload-content">
                                        <div class="image-upload-icon"></div>
                                        <div class="image-upload-text">
                                            <div class="upload-title">Click to upload image</div>
                                            <div class="upload-subtitle">or drag and drop</div>
                                            <div class="upload-formats">PNG, JPG, JPEG up to 10MB</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="imagePreview" class="image-preview" style="display: none;">
                                    <img id="previewImg" src="" alt="Preview" class="preview-image">
                                    <button type="button" class="remove-image-btn" onclick="removeImage()"></button>
                                </div>
                            </div>
                            <div class="form-help">Upload a clear image of the product. Images are stored in the database for persistence.</div>
                        </div>
                    </div>

                    <!-- Category & Classification Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Category & Classification</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productAnimal" class="form-label">
                                    Animal Type <span class="required">*</span>
                                </label>
                                <select id="productAnimal" name="animal" class="form-select" required>
                                    <option value="">Select Animal Type</option>
                                    <option value="chicken"> Chicken</option>
                                    <option value="pig"> Pig</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productCategory" class="form-label">
                                    Product Category <span class="required">*</span>
                                </label>
                                <select id="productCategory" name="category" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="feeds"> Feeds</option>
                                    <option value="supplements"> Supplements</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Pricing Information</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPricePerSack" class="form-label">
                                    Selling Price per Sack () <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix"></span>
                                    <input type="number" id="productPricePerSack" name="pricePerSack" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productPricePerKilo" class="form-label">
                                    Selling Price per Kilo () <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix"></span>
                                    <input type="number" id="productPricePerKilo" name="pricePerKilo" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Supplement Price Field (hidden by default) -->
                        <div class="form-group" id="supplementPriceGroup" style="display: none;">
                            <label for="productPrice" class="form-label">
                                Selling Price () <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="productPrice" name="price" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>
                        
                        <!-- Supplement Cost Price Field (hidden by default) -->
                        <div class="form-group" id="supplementCostGroup" style="display: none;">
                            <label for="productCost" class="form-label">
                                Cost Price ()
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="productCost" name="cost" class="form-input" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-help">Enter the cost price you paid when buying this product</div>
                        </div>
                    </div>

                    <!-- Stock Information Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Stock Information</h3>
                        </div>
                        <div class="form-row" id="feedStockFieldsRow">
                            <div class="form-group">
                                <label for="productStockSacks" class="form-label">
                                    Stock (Sacks) <span class="required">*</span>
                                </label>
                                <input type="number" id="productStockSacks" name="stockSacks" class="form-input" min="0" placeholder="0" required>
                                <div class="form-help">Enter the number of sacks in stock</div>
                            </div>
                            
                            <!-- Cost Price Field -->
                            <div class="form-group">
                                <label for="productCostPerSack" class="form-label">
                                    Cost Price per Sack ()
                                </label>
                                <input type="number" id="productCostPerSack" name="costPerSack" class="form-input" step="0.01" min="0" placeholder="0.00">
                                <div class="form-help">Enter the cost price you paid when buying this product</div>
                            </div>
                        </div>
                        
                        <!-- Supplement Stock Field (hidden by default) -->
                        <div class="form-group" id="supplementStockGroup" style="display: none;">
                            <label for="productStock" class="form-label">
                                Stock (Units) <span class="required">*</span>
                            </label>
                            <input type="number" id="productStock" name="stock" class="form-input" min="0" placeholder="0" required>
                            <div class="form-help">Enter the number of units in stock</div>
                        </div>
                        
                    </div>

                    <!-- Cost Price Section -->

                </form>
            </div>
            
            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelProduct">
                        <span></span> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveProduct" form="productForm">
                        <span></span> Save Product
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Edit Modal -->
    <div id="productEditModal" class="modal">
        <div class="modal-content enhanced-modal">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 id="editModalTitle"> Edit Product</h2>
                    <p class="modal-subtitle">Update product information and stock levels</p>
                </div>
                <button class="close" id="closeEditModal">
                    <span>&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="productEditForm" class="enhanced-form">
                    <!-- Product Overview -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Product Overview</h3>
                        </div>
                        <div class="product-overview">
                            <div class="product-preview">
                                <div class="product-image-preview" id="editProductImagePreview">
                                    <div class="image-placeholder"></div>
                                </div>
                                <div class="product-basic-info">
                                    <h4 id="editProductNameDisplay">Product Name</h4>
                                    <p id="editProductCategoryDisplay">Category</p>
                                    <div class="product-stock-status" id="editStockStatus">
                                        <span class="stock-indicator"></span>
                                        <span class="stock-text">In Stock</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Basic Information</h3>
                        </div>
                        <div class="form-group">
                            <label for="editProductName" class="form-label">
                                Product Name <span class="required">*</span>
                            </label>
                            <input type="text" id="editProductName" name="name" class="form-input" placeholder="Enter product name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editProductDescription" class="form-label">Description</label>
                            <textarea id="editProductDescription" name="description" class="form-textarea" rows="3" placeholder="Enter product description"></textarea>
                        </div>
                    </div>

                    <!-- Category & Classification Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Category & Classification</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProductAnimal" class="form-label">
                                    Animal Type <span class="required">*</span>
                                </label>
                                <select id="editProductAnimal" name="animal" class="form-select" required>
                                    <option value="">Select Animal Type</option>
                                    <option value="chicken"> Chicken</option>
                                    <option value="pig"> Pig</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editProductCategory" class="form-label">
                                    Product Category <span class="required">*</span>
                                </label>
                                <select id="editProductCategory" name="category" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="feeds"> Feeds</option>
                                    <option value="supplements"> Supplements</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Pricing Information</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProductPricePerSack" class="form-label">
                                    Selling Price per Sack () <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix"></span>
                                    <input type="number" id="editProductPricePerSack" name="pricePerSack" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editProductPricePerKilo" class="form-label">
                                    Selling Price per Kilo () <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix"></span>
                                    <input type="number" id="editProductPricePerKilo" name="pricePerKilo" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cost Price Field for Edit -->
                        <div class="form-group">
                            <label for="editProductCostPerSack" class="form-label">
                                Cost Price per Sack ()
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="editProductCostPerSack" name="costPerSack" class="form-input" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-help">Enter the cost price you paid when buying this product. Cost per kilo will be automatically calculated (1 sack = 25 kilos)</div>
                        </div>
                        
                        <!-- Supplement Price Field (hidden by default) -->
                        <div class="form-group" id="editSupplementPriceGroup" style="display: none;">
                            <label for="editProductPrice" class="form-label">
                                Selling Price () <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="editProductPrice" name="price" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                        </div>
                        
                        <!-- Supplement Cost Price Field (hidden by default) -->
                        <div class="form-group" id="editSupplementCostGroup" style="display: none;">
                            <label for="editProductCost" class="form-label">
                                Cost Price ()
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="editProductCost" name="cost" class="form-input" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-help">Enter the cost price you paid when buying this product</div>
                        </div>
                    </div>

                    <!-- Stock Management Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Stock Management</h3>
                        </div>
                        <div class="stock-management">
                            <div class="current-stock">
                                <h4> Stock Management</h4>
                                <div class="stock-display">
                                    <div class="stock-item">
                                        <span class="stock-amount" id="currentStockAmount">0</span>
                                        <span class="stock-unit" id="currentStockUnit">sacks</span>
                                    </div>
                                    <div class="stock-item">
                                        <span class="stock-amount" id="currentStockKilos">0</span>
                                        <span class="stock-unit">kilos</span>
                                    </div>
                                    <div class="stock-item">
                                        <span class="stock-amount" id="currentStockHalfKilos">0</span>
                                        <span class="stock-unit">half kilos</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stock Management - Only Sack Input -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProductStockSacks" class="form-label">Stock (Sacks):</label>
                                    <input type="number" id="editProductStockSacks" name="stockSacks" class="form-input" min="0" placeholder="Enter amount to add/remove">
                                    <small class="form-help">Kilos and half-kilos will be calculated automatically based on net weight</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="editProductNetWeightPerSack" class="form-label">Net Weight per Sack (kg):</label>
                                    <input type="number" id="editProductNetWeightPerSack" name="netWeightPerSack" class="form-input" min="0" step="0.1" placeholder="25">
                                    <small class="form-help">Enter the actual weight of each sack (e.g., 25kg, 50kg)</small>
                                </div>
                            </div>
                            
                            <!-- Auto-calculated stock display (read-only) -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Calculated Stock (Kilos):</label>
                                    <input type="number" id="editCalculatedStockKilos" readonly class="form-input calculated-field" placeholder="Auto-calculated">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Calculated Stock (Half Kilos):</label>
                                    <input type="number" id="editCalculatedStockHalfKilos" readonly class="form-input calculated-field" placeholder="Auto-calculated">
                                </div>
                            </div>
                            
                            <div class="stock-actions">
                                <div class="stock-action-group">
                                    <label class="form-label">Stock Actions</label>
                                    <div class="stock-input-group">
                                        <button type="button" class="btn btn-success" id="addStockBtn">
                                            <span></span> Add Stock
                                        </button>
                                        <button type="button" class="btn btn-warning" id="removeStockBtn">
                                            <span></span> Remove Stock
                                        </button>
                                    </div>
                                    <div class="form-help">Enter amounts in the stock fields above, then click Add or Remove</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden stock fields for form submission -->
                        <input type="hidden" id="editProductStockSacksHidden" name="stockSacks" value="0">
                        <input type="hidden" id="editProductStockKilosHidden" name="stockKilos" value="0">
                        <input type="hidden" id="editProductStockHalfKilosHidden" name="stockHalfKilos" value="0">
                        
                        <!-- Supplement Stock Field (hidden by default) -->
                        <div class="form-group" id="editSupplementStockGroup" style="display: none;">
                            <label for="editProductStock" class="form-label">
                                Stock (Units) <span class="required">*</span>
                            </label>
                            <input type="number" id="editProductStock" name="stock" class="form-input" min="0" placeholder="0" required>
                        </div>
                    </div>

                    <!-- Product Image Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3> Product Image</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product Image</label>
                            <div class="image-upload-container">
                                <input type="file" id="editProductImage" name="imageFile" accept="image/*" style="display: none;" onchange="handleEditImageUpload(event)">
                                <div class="image-upload-area" onclick="document.getElementById('editProductImage').click()">
                                    <div class="upload-placeholder" id="editUploadPlaceholder">
                                        <div class="upload-icon"></div>
                                        <p class="upload-text">Click to change product image</p>
                                        <small class="upload-hint">Supports: JPG, PNG, GIF, WebP (Max 5MB)</small>
                                    </div>
                                    <img id="editImagePreview" style="display: none; max-width: 200px; max-height: 200px; border-radius: 8px;">
                                </div>
                                <div class="image-actions" id="editImageActions" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearEditImage()">
                                        <span></span> Remove Image
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEditProduct">
                        <span></span> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveEditProduct" form="productEditForm">
                        <span></span> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="qrModalTitle">Product QR Code</h2>
                <span class="close" id="closeQrModal">&times;</span>
            </div>
            <div class="qr-content">
                <div class="product-info">
                    <h3 id="qrProductName">Product Name</h3>
                    <p id="qrProductDetails">Product details will appear here</p>
                </div>
                <div class="qr-code-container">
                    <img id="qrCodeImage" src="" alt="QR Code" style="display: none; max-width: 200px; border: 1px solid #ddd; border-radius: 5px;">
                    <canvas id="qrCanvas" width="200" height="200" style="display: none;"></canvas>
                </div>
                <div class="qr-info">
                    <p><strong>Scan this QR code to view product details</strong></p>
                    <p class="product-id" id="productIdDisplay" style="color: #666; font-size: 0.9rem; margin: 5px 0;">Product ID: <span id="productIdValue"></span></p>
                    <p class="qr-url" id="qrUrl">URL will appear here</p>
                </div>
                <div class="qr-actions">
                    <button class="btn btn-primary" id="downloadQrBtn"> Download QR Code</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="staffModalTitle">Add New Staff</h2>
                <span class="close" id="closeStaffModal">&times;</span>
            </div>
            <form id="staffForm">
                <input type="hidden" id="staffId" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="staffFirstName">First Name *</label>
                        <input type="text" id="staffFirstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="staffLastName">Last Name *</label>
                        <input type="text" id="staffLastName" name="lastName" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="staffEmail">Email Address *</label>
                    <input type="email" id="staffEmail" name="email" required>
                </div>
                
                <!-- Role is automatically set to 'staff' -->
                <input type="hidden" id="staffRole" name="role" value="staff">
                
                <div class="form-group" id="staffStatusGroup" style="display: none;">
                    <label for="staffStatus">Status *</label>
                    <select id="staffStatus" name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelStaffBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveStaffBtn">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        // Detect environment and set API URL
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:4000' 
            : 'https://feeds-store-api.onrender.com';
        const API_BASE = API_URL + '/api';
        let user = null;
        let salesChart = null;
        let currentChartPeriod = 7;
        
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (!token || !userData) {
                window.location.href = './admin-dashboard.html';
                return;
            }
            
            user = JSON.parse(userData);
            
            if (user.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                logout();
                return;
            }
            
            document.getElementById('userName').textContent = `Welcome, ${user.firstName}!`;
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.firstName}!`;
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = './login.html';
        }
        
        // Switch tabs
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Products').classList.add('active');
        }
        
        // Enhanced Product Card Creation
        function createProductCard(product) {
            // Calculate total stock using the same logic as getTotalStock
            const totalStock = getTotalStock(product);
            const stockClass = totalStock <= 3 ? 'stock-low' : 'stock-ok';
            // Determine the appropriate unit for display
            const displayUnit = product.category === 'supplements' ? 'units' : (product.unit || 'sack');
            const stockText = totalStock <= 3 ? 
                `Low Stock: ${totalStock} ${displayUnit}` :
                `In Stock: ${totalStock} ${displayUnit}`;
            
            const badgeClass = totalStock <= 3 ? 'low-stock' : 'in-stock';
            const badgeText = totalStock <= 3 ? 'Low Stock' : 'In Stock';
            
            const animalIcon = product.animal === 'chicken' ? '' : '';
            const categoryIcon = product.category === 'feeds' ? '' : '';
            
            // Debug image URL
            console.log(' Creating product card for:', product.name, 'Image URL:', product.imageUrl ? 'Present' : 'Missing');
            
            return `
                <div class="product-card" data-product-id="${product._id}" onclick="openEditModal('${product._id}')">
                    <div class="product-card-header">
                        <div class="product-image">
                            ${product.imageUrl ? 
                                `<img src="${product.imageUrl.startsWith('data:') ? product.imageUrl : product.imageUrl + '?t=' + Date.now()}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px; background: #f8f9fa;" onerror="console.log(' Image failed to load for product:', '${product.name}', 'URL:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 8px; font-size: 2rem;">${animalIcon}</div>` :
                                `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 8px; font-size: 2rem;">${animalIcon}</div>`
                            }
                        </div>
                        <div class="product-badge ${badgeClass}">${badgeText}</div>
                    </div>
                    <div class="product-card-body">
                        <div class="product-name">${product.name}</div>
                        <div class="product-category">
                            <span>${animalIcon}</span>
                            <span>${categoryIcon}</span>
                            <span>${product.animal.toUpperCase()} ${product.category.toUpperCase()}</span>
                        </div>
                        <div class="product-pricing">
                            <div class="product-price">${product.pricePerSack || product.price}</div>
                            <div class="product-price-unit">per ${product.unit || 'sack'}</div>
                        </div>
                        <div class="product-stock ${stockClass}">
                            <span></span>
                            <span>${stockText}</span>
                        </div>
                    </div>
                    <div class="product-card-footer">
                        <!-- <div class="product-id">ID: ${product.customId || product._id.slice(-8)}</div> -->
                        <div class="product-actions">
                            <button class="product-qr-btn" onclick="event.stopPropagation(); generateQRCode('${product._id}')">
                                <span></span> QR
                            </button>
                            <button class="product-delete-btn" onclick="event.stopPropagation(); deleteProduct('${product._id}')">
                                <span></span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize Cards View
        function initializeCardsView() {
            // Always show cards view
            const productsGrid = document.getElementById('productsGrid');
            if (productsGrid) {
                productsGrid.style.display = 'grid';
            }
            
            // Load and render products
            loadProducts();
        }

        // Render Product Cards
        function renderProductCards() {
            console.log(' renderProductCards function called');
            const productsGrid = document.getElementById('productsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (!productsGrid) {
                console.log(' productsGrid not found');
                return;
            }
            
            const filteredProducts = getFilteredProducts();
            console.log(' Filtered products count:', filteredProducts.length);
            
            if (filteredProducts.length === 0) {
                productsGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            productsGrid.style.display = 'grid';
            
            const cardsHTML = filteredProducts.map(product => createProductCard(product)).join('');
            productsGrid.innerHTML = cardsHTML;
            
            // Apply conditional scrolling based on product count
            if (filteredProducts.length > 8) {
                productsGrid.classList.add('scrollable');
                console.log(' Applied scrollable class for', filteredProducts.length, 'products');
                console.log(' productsGrid classes:', productsGrid.className);
            } else {
                productsGrid.classList.remove('scrollable');
                console.log(' Removed scrollable class for', filteredProducts.length, 'products');
            }
            
            // Update cards info
            updateCardsInfo(filteredProducts.length);
        }

        // Get Filtered Products
        function getFilteredProducts() {
            const activeCategoryBtn = document.querySelector('.category-btn.active');
            const selectedAnimal = activeCategoryBtn ? activeCategoryBtn.getAttribute('data-category') : '';
            
            // Find the active subcategory button in the selected animal group
            let selectedCategory = '';
            if (selectedAnimal && selectedAnimal !== '') {
                const animalGroup = document.querySelector(`[data-category="${selectedAnimal}"]`).closest('.animal-category-group');
                const activeSubcategoryBtn = animalGroup.querySelector('.subcategory-btn.active');
                selectedCategory = activeSubcategoryBtn ? activeSubcategoryBtn.getAttribute('data-subcategory') : '';
            }
            
            
            let filteredProducts = products;
            
            // Apply animal filter
            if (selectedAnimal) {
                filteredProducts = filteredProducts.filter(product => product.animal === selectedAnimal);
            }
            
            // Apply category filter (feeds/supplements)
            if (selectedCategory) {
                filteredProducts = filteredProducts.filter(product => product.category === selectedCategory);
            }
            
            
            return filteredProducts;
        }

        // Update Cards Info
        function updateCardsInfo(count) {
            const cardsInfo = document.getElementById('cardsInfo');
            if (cardsInfo) {
                cardsInfo.textContent = `Showing ${count} products`;
            }
        }

        // Clear All Filters
        function clearAllFilters() {
            // Reset category buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.category-btn[data-category=""]').classList.add('active');
            
            // Reset subcategory buttons
            document.querySelectorAll('.subcategory-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.subcategory-btn[data-subcategory=""]').forEach(btn => {
                btn.classList.add('active');
            });
            
            // Clear search
            const searchInput = document.getElementById('searchProduct');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Refresh products in cards view
            renderProductCards();
        }

        // Clear Search
        function clearSearch() {
            const searchInput = document.getElementById('searchProduct');
            if (searchInput) {
                searchInput.value = '';
                renderProductCards(); // Refresh products in cards view
            }
        }

        // Export Products
        function exportProducts() {
            try {
                console.log(' Exporting detailed products report...');
                
                // Get products data
                const products = allProducts || [];
                
                if (!products || products.length === 0) {
                    showNotification('No products available to export', 'error');
                    return;
                }
                
                // Calculate summary metrics
                const totalProducts = products.length;
                const totalStockSacks = products.reduce((sum, product) => sum + (product.stockSacks || 0), 0);
                const totalStockKilos = products.reduce((sum, product) => sum + (product.stockKilos || 0), 0);
                const lowStockProducts = products.filter(product => {
                    const totalStock = getTotalStock(product);
                    return totalStock <= 3;
                });
                const chickenProducts = products.filter(product => product.animal === 'chicken').length;
                const pigProducts = products.filter(product => product.animal === 'pig').length;
                const currentDate = new Date();
                
                // Create detailed HTML content for Word document
                let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Product Inventory Report - ${currentDate.toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #8b7355; padding-bottom: 20px; }
                        .header h1 { color: #8b7355; font-size: 28px; margin: 0; }
                        .header h2 { color: #666; font-size: 18px; margin: 10px 0; }
                        .section { margin: 30px 0; }
                        .section h3 { color: #8b7355; font-size: 20px; border-bottom: 2px solid #d2b48c; padding-bottom: 10px; }
                        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
                        .summary-card { background: #f5f5dc; padding: 20px; border-radius: 8px; border-left: 4px solid #8b7355; }
                        .summary-card h4 { margin: 0 0 10px 0; color: #8b7355; font-size: 16px; }
                        .summary-card .value { font-size: 24px; font-weight: bold; color: #333; }
                        .summary-card .label { font-size: 14px; color: #666; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
                        th { background: #8b7355; color: white; font-weight: bold; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .low-stock { background: #ffe8e8; }
                        .good-stock { background: #e8f5e8; }
                        .warning-stock { background: #fff3cd; }
                        .category-section { margin: 30px 0; }
                        .category-header { background: #8b7355; color: white; padding: 15px; font-weight: bold; font-size: 18px; }
                        .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1> ZYMOUNE FEEDS SUPPLY</h1>
                        <h2>Product Inventory Report</h2>
                        <p>Generated on: ${currentDate.toLocaleDateString()} at ${currentDate.toLocaleTimeString()}</p>
                    </div>
                    
                    <div class="section">
                        <h3> Inventory Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h4>Total Products</h4>
                                <div class="value">${totalProducts}</div>
                                <div class="label">Active Products</div>
                            </div>
                            <div class="summary-card">
                                <h4>Total Stock Sacks</h4>
                                <div class="value">${totalStockSacks}</div>
                                <div class="label">Sacks Available</div>
                            </div>
                            <div class="summary-card">
                                <h4>Total Stock Kilos</h4>
                                <div class="value">${totalStockKilos}</div>
                                <div class="label">Kilos Available</div>
                            </div>
                            <div class="summary-card">
                                <h4>Chicken Products</h4>
                                <div class="value">${chickenProducts}</div>
                                <div class="label"> Chicken Feeds</div>
                            </div>
                            <div class="summary-card">
                                <h4>Pig Products</h4>
                                <div class="value">${pigProducts}</div>
                                <div class="label"> Pig Feeds</div>
                            </div>
                            <div class="summary-card">
                                <h4>Low Stock Alert</h4>
                                <div class="value">${lowStockProducts.length}</div>
                                <div class="label">Products  3 Stock</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3> Low Stock Products (Require Immediate Attention)</h3>`;
                
                if (lowStockProducts.length > 0) {
                    htmlContent += `
                        <table>
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Animal</th>
                                    <th>Category</th>
                                    <th>Current Stock</th>
                                    <th>Price per Sack</th>
                                    <th>Price per Kilo</th>
                                    <th>Action Required</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    lowStockProducts.forEach(product => {
                        const totalStock = getTotalStock(product);
                        const stockClass = totalStock === 0 ? 'low-stock' : 'warning-stock';
                        const actionRequired = totalStock === 0 ? 'URGENT: Restock immediately' : 'Monitor closely - Consider restocking';
                        
                        htmlContent += `
                            <tr class="${stockClass}">
                                <td><strong>${product.name}</strong></td>
                                <td>${product.animal === 'chicken' ? '' : ''} ${product.animal}</td>
                                <td>${product.category}</td>
                                <td>${totalStock} (${product.stockSacks || 0} sacks, ${product.stockKilos || 0} kilos, ${product.stockHalfKilos || 0} half kilos)</td>
                                <td>${(product.pricePerSack || 0).toLocaleString()}</td>
                                <td>${(product.pricePerKilo || 0).toLocaleString()}</td>
                                <td><strong>${actionRequired}</strong></td>
                            </tr>`;
                    });
                    
                    htmlContent += `</tbody></table>`;
                } else {
                    htmlContent += `<p style="text-align: center; color: #28a745; font-weight: bold;"> All products have adequate stock levels!</p>`;
                }
                
                htmlContent += `
                    </div>
                    
                    <div class="section">
                        <h3> Complete Product Inventory</h3>`;
                
                // Group products by animal type
                const chickenProductsList = products.filter(product => product.animal === 'chicken');
                const pigProductsList = products.filter(product => product.animal === 'pig');
                
                if (chickenProductsList.length > 0) {
                    htmlContent += `
                        <div class="category-section">
                            <div class="category-header"> Chicken Feed Products</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>Stock Sacks</th>
                                        <th>Stock Kilos</th>
                                        <th>Total Stock</th>
                                        <th>Price per Sack</th>
                                        <th>Price per Kilo</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    chickenProductsList.forEach(product => {
                        const totalStock = (product.stockSacks || 0) + (product.stockKilos || 0);
                        const stockClass = totalStock <= 3 ? (totalStock === 0 ? 'low-stock' : 'warning-stock') : 'good-stock';
                        
                        htmlContent += `
                            <tr class="${stockClass}">
                                <td><strong>${product.name}</strong></td>
                                <td>${product.category}</td>
                                <td>${product.stockSacks || 0}</td>
                                <td>${product.stockKilos || 0}</td>
                                <td><strong>${totalStock}</strong></td>
                                <td>${(product.pricePerSack || 0).toLocaleString()}</td>
                                <td>${(product.pricePerKilo || 0).toLocaleString()}</td>
                                <td>${product.description || 'No description'}</td>
                            </tr>`;
                    });
                    
                    htmlContent += `</tbody></table></div>`;
                }
                
                if (pigProductsList.length > 0) {
                    htmlContent += `
                        <div class="category-section">
                            <div class="category-header"> Pig Feed Products</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>Stock Sacks</th>
                                        <th>Stock Kilos</th>
                                        <th>Total Stock</th>
                                        <th>Price per Sack</th>
                                        <th>Price per Kilo</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    pigProductsList.forEach(product => {
                        const totalStock = (product.stockSacks || 0) + (product.stockKilos || 0);
                        const stockClass = totalStock <= 3 ? (totalStock === 0 ? 'low-stock' : 'warning-stock') : 'good-stock';
                        
                        htmlContent += `
                            <tr class="${stockClass}">
                                <td><strong>${product.name}</strong></td>
                                <td>${product.category}</td>
                                <td>${product.stockSacks || 0}</td>
                                <td>${product.stockKilos || 0}</td>
                                <td><strong>${totalStock}</strong></td>
                                <td>${(product.pricePerSack || 0).toLocaleString()}</td>
                                <td>${(product.pricePerKilo || 0).toLocaleString()}</td>
                                <td>${product.description || 'No description'}</td>
                            </tr>`;
                    });
                    
                    htmlContent += `</tbody></table></div>`;
                }
                
                htmlContent += `
                    </div>
                    
                    <div class="section">
                        <h3> Inventory Analysis</h3>
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h4> Key Insights</h4>
                            <ul>
                                <li><strong>Stock Distribution:</strong> ${totalStockSacks} sacks and ${totalStockKilos} kilos across ${totalProducts} products</li>
                                <li><strong>Product Mix:</strong> ${chickenProducts} chicken products (${((chickenProducts/totalProducts)*100).toFixed(1)}%) and ${pigProducts} pig products (${((pigProducts/totalProducts)*100).toFixed(1)}%)</li>
                                <li><strong>Stock Health:</strong> ${lowStockProducts.length} products require attention (${((lowStockProducts.length/totalProducts)*100).toFixed(1)}% of inventory)</li>
                                <li><strong>Inventory Value:</strong> Estimated total inventory value based on current pricing</li>
                            </ul>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h4> Recommendations</h4>
                            <ul>
                                <li>Monitor low stock products closely and plan restocking</li>
                                <li>Consider bulk purchasing for high-demand products</li>
                                <li>Review pricing strategy for optimal profit margins</li>
                                <li>Implement automated stock alerts for critical products</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>This report was generated automatically by the ZYMOUNE FEEDS SUPPLY Inventory Management System.</p>
                        <p>For questions or additional analysis, please contact the management team.</p>
                    </div>
                </body>
                </html>`;
                
                // Create and download file
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ZYMOUNE-Inventory-Report-${currentDate.toISOString().split('T')[0]}.html`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Detailed inventory report exported successfully!', 'success');
                console.log(' Detailed inventory report exported successfully');
                
            } catch (error) {
                console.error('Error exporting products data:', error);
                showNotification('Failed to export products data', 'error');
            }
        }

        // Export Forecast Report
        function exportForecastReport() {
            try {
                console.log(' Exporting detailed forecast report to Excel...');
                
                // Get forecast data
                const salesData = forecastData.salesHistory;
                const products = forecastData.products;
                const forecasts = forecastData.forecasts;
                
                if (!salesData || salesData.length === 0) {
                    showNotification('No forecast data available to export', 'error');
                    return;
                }
                
                // Calculate summary metrics
                const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
                const totalSales = salesData.length;
                const averageOrderValue = totalRevenue / totalSales;
                const currentDate = new Date();
                const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                const nextQuarter = new Date(currentDate.getFullYear(), currentDate.getMonth() + 3, 1);
                
                // Create Excel-compatible CSV content with proper formatting
                let csvContent = '';
                
                // Add BOM for proper UTF-8 encoding in Excel
                csvContent += '\uFEFF';
                
                // Title Header
                csvContent += 'ZYMOUNE FEEDS SUPPLY - SALES FORECAST REPORT\n';
                csvContent += `Generated on: ${currentDate.toLocaleDateString()} at ${currentDate.toLocaleTimeString()}\n\n`;
                
                // Recent Sales Summary Section
                csvContent += 'RECENT SALES SUMMARY\n';
                csvContent += 'Metric,Value,Description\n';
                csvContent += `Total Revenue,${totalRevenue.toLocaleString()},"Total revenue from all sales transactions"\n`;
                csvContent += `Total Sales,${totalSales},"Number of completed sales transactions"\n`;
                csvContent += `Average Order Value,${averageOrderValue.toLocaleString()},"Average amount per transaction"\n`;
                csvContent += `Products Analyzed,${products.length},"Number of products included in forecast"\n`;
                csvContent += `Report Date,${currentDate.toLocaleDateString()},"Date when forecast was generated"\n\n`;
                
                // Product Performance Forecast
                csvContent += 'PRODUCT PERFORMANCE FORECAST\n';
                csvContent += 'Product Name,Current Revenue,Next Month Forecast,Next Quarter Forecast,Growth Rate (%),Confidence (%),Recommendation\n';
                
                products.forEach(product => {
                    const forecast = forecasts[product._id];
                    if (forecast) {
                        const growthPercent = forecast.growthRate.toFixed(1);
                        const confidence = (forecast.confidence * 100).toFixed(0);
                        
                        let recommendation = 'Maintain current strategy';
                        if (forecast.growthRate > 20) {
                            recommendation = 'Increase inventory and marketing investment';
                        } else if (forecast.growthRate < -10) {
                            recommendation = 'Review pricing strategy and promotional activities';
                        }
                        
                        // Escape commas and quotes in product name and recommendation
                        const productName = `"${product.name.replace(/"/g, '""')}"`;
                        const recommendationEscaped = `"${recommendation.replace(/"/g, '""')}"`;
                        
                        csvContent += `${productName},${forecast.currentRevenue.toLocaleString()},${forecast.nextMonthForecast.toLocaleString()},${forecast.nextQuarterForecast.toLocaleString()},${growthPercent},${confidence},${recommendationEscaped}\n`;
                    }
                });
                
                csvContent += '\n';
                
                // Forecasting Insights
                csvContent += 'FORECASTING INSIGHTS\n';
                csvContent += 'Category,Insight,Priority\n';
                csvContent += 'Growth Opportunities,"High-performing products showing strong demand","High"\n';
                csvContent += 'Growth Opportunities,"Seasonal trends indicate upcoming demand increase","Medium"\n';
                csvContent += 'Growth Opportunities,"Bulk purchasing opportunities for cost optimization","Medium"\n';
                csvContent += 'Risk Factors,"Products with declining sales trends","High"\n';
                csvContent += 'Risk Factors,"Market competition affecting pricing","Medium"\n';
                csvContent += 'Risk Factors,"Supply chain disruptions potential","Low"\n';
                csvContent += 'Strategic Actions,"Increase inventory for high-growth products","Immediate"\n';
                csvContent += 'Strategic Actions,"Review pricing for declining products","Within 30 days"\n';
                csvContent += 'Strategic Actions,"Develop promotional campaigns for seasonal products","Next quarter"\n';
                csvContent += 'Strategic Actions,"Monitor competitor pricing strategies","Ongoing"\n';
                
                csvContent += '\n';
                
                // Forecast Timeline
                csvContent += 'FORECAST TIMELINE\n';
                csvContent += 'Period,Expected Revenue,Confidence Level,Key Factors\n';
                csvContent += `Next Month (${nextMonth.toLocaleDateString()}),"Based on current trends","85%","Seasonal patterns and recent performance"\n`;
                csvContent += `Next Quarter (${nextQuarter.toLocaleDateString()}),"Long-term projections","75%","Market conditions and product lifecycle"\n`;
                csvContent += 'Methodology,"Seasonal analysis with trend identification","N/A","Historical data analysis and confidence scoring"\n';
                
                // Create and download Excel file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ZYMOUNE-Forecast-Report-${currentDate.toISOString().split('T')[0]}.xlsx`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Forecast report exported to Excel successfully!', 'success');
                console.log(' Forecast report exported to Excel successfully');
                
            } catch (error) {
                console.error('Error exporting forecast report:', error);
                showNotification('Failed to export forecast report', 'error');
            }
        }

        // Open Edit Modal
        function openEditModal(productId) {
            console.log('Opening edit modal for product:', productId);
            const modal = document.getElementById('productEditModal');
            if (!modal) {
                console.error('Edit modal not found');
                return;
            }
            
            // Find product data
            const product = getProductById(productId);
            if (!product) {
                console.error('Product not found:', productId);
                console.log('Available products:', products);
                return;
            }
            
            console.log('Found product:', product);
            
            // Store product ID in modal dataset
            modal.dataset.productId = productId;
            
            // Populate modal with product data
            populateEditModal(product);
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close Edit Modal
        function closeEditModal() {
            const modal = document.getElementById('productEditModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Get Product by ID
        function getProductById(productId) {
            return products.find(product => product._id === productId);
        }

        // Populate Edit Modal
        function populateEditModal(product) {
            console.log('Populating edit modal with product:', product);
            console.log('Product keys:', Object.keys(product));
            console.log('Product animal:', product.animal);
            console.log('Product category:', product.category);
            console.log('Product name:', product.name);
            
            // Populate form fields
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductDescription').value = product.description || '';
            document.getElementById('editProductAnimal').value = product.animal || '';
            document.getElementById('editProductCategory').value = product.category || '';
            
            // Debug price fields
            console.log('Price per sack:', product.pricePerSack);
            console.log('Price per kilo:', product.pricePerKilo);
            console.log('Price (fallback):', product.price);
            console.log('Stock sacks:', product.stockSacks);
            console.log('Stock (legacy):', product.stock);
            
            // Handle both price field structures
            document.getElementById('editProductPricePerSack').value = product.pricePerSack || product.price || '';
            document.getElementById('editProductPricePerKilo').value = product.pricePerKilo || product.price || '';
            document.getElementById('editProductCostPerSack').value = product.costPerSack || 0;
            document.getElementById('editProductNetWeightPerSack').value = product.netWeightPerSack || 25;
            
            // Update stock display and hidden field
            const currentStock = product.stockSacks || 0;
            const stockKilos = product.stockKilos || 0;
            const stockHalfKilos = product.stockHalfKilos || 0;
            
            document.getElementById('currentStockAmount').textContent = currentStock;
            document.getElementById('currentStockKilos').textContent = stockKilos;
            document.getElementById('currentStockHalfKilos').textContent = stockHalfKilos;
            
            // Don't pre-fill the stock input field - keep it empty for add/remove operations
            document.getElementById('editProductStockSacks').value = '';
            
            // Handle category-specific fields
            const isSupplement = product.category === 'supplements';
            
            // Update calculated fields with current stock values (only for feeds)
            if (!isSupplement) {
                document.getElementById('editCalculatedStockKilos').value = stockKilos;
                document.getElementById('editCalculatedStockHalfKilos').value = stockHalfKilos;
            }
            
            // Hide/show fields based on category
            handleEditModalCategoryChange(product.category);
            
            // Update product overview display
            document.getElementById('editProductNameDisplay').textContent = product.name || 'Product Name';
            const animal = product.animal || 'Unknown';
            const category = product.category || 'Unknown';
            document.getElementById('editProductCategoryDisplay').textContent = `${animal}  ${category}`.toUpperCase();
            
            // Update stock display
            const stockAmount = document.getElementById('currentStockAmount');
            const stockUnit = document.getElementById('currentStockUnit');
            if (stockAmount) stockAmount.textContent = product.stockSacks || 0;
            if (stockUnit) stockUnit.textContent = 'sacks';
            
            // Update stock status
            const stockStatus = document.getElementById('editStockStatus');
            if (stockStatus) {
                const currentStock = product.stockSacks || 0;
                const isLowStock = currentStock <= 3;
                stockStatus.className = `product-stock-status ${isLowStock ? 'stock-low' : 'stock-ok'}`;
                stockStatus.innerHTML = `
                    <span class="stock-indicator">${isLowStock ? '' : ''}</span>
                    <span class="stock-text">${isLowStock ? 'Low Stock' : 'In Stock'}</span>
                `;
            }
            
            // Update image preview
            const imagePreview = document.getElementById('editProductImagePreview');
            if (imagePreview) {
                if (product.imageUrl) {
                    const imageSrc = product.imageUrl.startsWith('data:') ? product.imageUrl : product.imageUrl + '?t=' + Date.now();
                    imagePreview.innerHTML = `<img src="${imageSrc}" alt="${product.name}">`;
                } else {
                    imagePreview.innerHTML = '<div class="image-placeholder"></div>';
                }
            }
            
            // Update image upload area
            const editImagePreview = document.getElementById('editImagePreview');
            const editUploadPlaceholder = document.getElementById('editUploadPlaceholder');
            const editImageActions = document.getElementById('editImageActions');
            
            if (product.imageUrl) {
                // Show current image
                if (editImagePreview) {
                    editImagePreview.src = product.imageUrl.startsWith('data:') ? product.imageUrl : product.imageUrl + '?t=' + Date.now();
                    editImagePreview.style.display = 'block';
                }
                if (editUploadPlaceholder) {
                    editUploadPlaceholder.style.display = 'none';
                }
                if (editImageActions) {
                    editImageActions.style.display = 'flex';
                }
            } else {
                // Show upload placeholder
                if (editImagePreview) {
                    editImagePreview.style.display = 'none';
                }
                if (editUploadPlaceholder) {
                    editUploadPlaceholder.style.display = 'flex';
                }
                if (editImageActions) {
                    editImageActions.style.display = 'none';
                }
            }
        }
        
        // Handle category change in edit modal
        function handleEditModalCategoryChange(category) {
            const isSupplement = category === 'supplements';
            
            // Get form groups to show/hide
            const netWeightGroup = document.querySelector('#editProductNetWeightPerSack')?.closest('.form-group');
            const costGroup = document.querySelector('#editProductCostPerSack')?.closest('.form-group');
            const calculatedKilosGroup = document.querySelector('#editCalculatedStockKilos')?.closest('.form-group');
            const calculatedHalfKilosGroup = document.querySelector('#editCalculatedStockHalfKilos')?.closest('.form-group');
            
            // Get stock display elements to show/hide
            const stockKilosElement = document.querySelector('#currentStockKilos')?.closest('.stock-item');
            const stockHalfKilosElement = document.querySelector('#currentStockHalfKilos')?.closest('.stock-item');
            
            if (isSupplement) {
                // Hide feed-specific fields for supplements
                if (netWeightGroup) netWeightGroup.style.display = 'none';
                if (costGroup) costGroup.style.display = 'none';
                if (calculatedKilosGroup) calculatedKilosGroup.style.display = 'none';
                if (calculatedHalfKilosGroup) calculatedHalfKilosGroup.style.display = 'none';
                
                // Hide kilo and half-kilo stock display for supplements
                if (stockKilosElement) stockKilosElement.style.display = 'none';
                if (stockHalfKilosElement) stockHalfKilosElement.style.display = 'none';
            } else {
                // Show all fields for feeds
                if (netWeightGroup) netWeightGroup.style.display = 'block';
                if (costGroup) costGroup.style.display = 'block';
                if (calculatedKilosGroup) calculatedKilosGroup.style.display = 'block';
                if (calculatedHalfKilosGroup) calculatedHalfKilosGroup.style.display = 'block';
                
                // Show kilo and half-kilo stock display for feeds
                if (stockKilosElement) stockKilosElement.style.display = 'flex';
                if (stockHalfKilosElement) stockHalfKilosElement.style.display = 'flex';
            }
        }

        // Stock Management Functions
        async function addStock() {
            // Get value from sack input field only
            const sacksInput = document.getElementById('editProductStockSacks');
            const sacksValue = parseInt(sacksInput.value) || 0;
            
            // If sack field is empty (0), show a message
            if (sacksValue === 0) {
                showNotification('Please enter sack amount to add', 'warning');
                return;
            }
            
            // Get current display values
            const currentSacks = parseInt(document.getElementById('currentStockAmount').textContent) || 0;
            
            // Get product category to determine calculation method
            const modal = document.getElementById('productEditModal');
            const productId = modal.dataset.productId;
            const product = getProductById(productId);
            const isSupplement = product && product.category === 'supplements';
            
            // Calculate new values (add input value to current value)
            const newSacks = currentSacks + sacksValue;
            let newKilos = 0;
            let newHalfKilos = 0;
            
            if (!isSupplement) {
                // For feeds, calculate kilos and half-kilos
                const netWeightInput = document.getElementById('editProductNetWeightPerSack');
                const netWeight = parseFloat(netWeightInput.value) || 25;
                newKilos = newSacks * netWeight;
                newHalfKilos = newSacks * netWeight * 2;
            }
            
            // Update display
            document.getElementById('currentStockAmount').textContent = newSacks;
            if (!isSupplement) {
                document.getElementById('currentStockKilos').textContent = newKilos;
                document.getElementById('currentStockHalfKilos').textContent = newHalfKilos;
                
                // Update calculated fields (only for feeds)
                document.getElementById('editCalculatedStockKilos').value = newKilos;
                document.getElementById('editCalculatedStockHalfKilos').value = newHalfKilos;
            }
            
            // Clear the input field after processing
            sacksInput.value = '';
            
            // Update hidden fields
            document.getElementById('editProductStockSacksHidden').value = newSacks;
            document.getElementById('editProductStockKilosHidden').value = newKilos;
            document.getElementById('editProductStockHalfKilosHidden').value = newHalfKilos;
            
            // Update stock status (use sacks as primary for status)
            updateStockStatus(newSacks);
            
            // Auto-save stock changes to database
            await autoSaveStockChanges(newSacks, newKilos, newHalfKilos);
            
            // Show notification based on product type
            if (isSupplement) {
                showNotification(`Stock added: ${sacksValue} sacks`, 'success');
            } else {
                showNotification(`Stock added: ${sacksValue} sacks (${newKilos} kilos, ${newHalfKilos} half kilos)`, 'success');
            }
        }

        async function removeStock() {
            // Get value from sack input field only
            const sacksInput = document.getElementById('editProductStockSacks');
            const sacksValue = parseInt(sacksInput.value) || 0;
            
            // If sack field is empty (0), show a message
            if (sacksValue === 0) {
                showNotification('Please enter sack amount to remove', 'warning');
                return;
            }
            
            // Get current display values
            const currentSacks = parseInt(document.getElementById('currentStockAmount').textContent) || 0;
            
            // Get product category to determine calculation method
            const modal = document.getElementById('productEditModal');
            const productId = modal.dataset.productId;
            const product = getProductById(productId);
            const isSupplement = product && product.category === 'supplements';
            
            // Calculate new values (subtract input value from current value, minimum 0)
            const newSacks = Math.max(0, currentSacks - sacksValue);
            let newKilos = 0;
            let newHalfKilos = 0;
            
            if (!isSupplement) {
                // For feeds, calculate kilos and half-kilos
                const netWeightInput = document.getElementById('editProductNetWeightPerSack');
                const netWeight = parseFloat(netWeightInput.value) || 25;
                newKilos = newSacks * netWeight;
                newHalfKilos = newSacks * netWeight * 2;
            }
            
            // Update display
            document.getElementById('currentStockAmount').textContent = newSacks;
            if (!isSupplement) {
                document.getElementById('currentStockKilos').textContent = newKilos;
                document.getElementById('currentStockHalfKilos').textContent = newHalfKilos;
                
                // Update calculated fields (only for feeds)
                document.getElementById('editCalculatedStockKilos').value = newKilos;
                document.getElementById('editCalculatedStockHalfKilos').value = newHalfKilos;
            }
            
            // Clear the input field after processing
            sacksInput.value = '';
            
            // Update hidden fields
            document.getElementById('editProductStockSacksHidden').value = newSacks;
            document.getElementById('editProductStockKilosHidden').value = newKilos;
            document.getElementById('editProductStockHalfKilosHidden').value = newHalfKilos;
            
            // Update stock status (use sacks as primary for status)
            updateStockStatus(newSacks);
            
            // Auto-save stock changes to database
            await autoSaveStockChanges(newSacks, newKilos, newHalfKilos);
            
            // Show notification based on product type
            if (isSupplement) {
                showNotification(`Stock removed: ${sacksValue} sacks`, 'success');
            } else {
                showNotification(`Stock removed: ${sacksValue} sacks (${newKilos} kilos, ${newHalfKilos} half kilos)`, 'success');
            }
        }


        function updateStockStatus(stock) {
            const stockStatus = document.getElementById('editStockStatus');
            const isLowStock = stock <= 3;
            
            if (stockStatus) {
                stockStatus.className = `product-stock-status ${isLowStock ? 'stock-low' : 'stock-ok'}`;
                stockStatus.innerHTML = `
                    <span class="stock-indicator">${isLowStock ? '' : ''}</span>
                    <span class="stock-text">${isLowStock ? 'Low Stock' : 'In Stock'}</span>
                `;
            }
        }

        // Auto-save stock changes to database
        async function autoSaveStockChanges(newSacks, newKilos, newHalfKilos) {
            try {
                const modal = document.getElementById('productEditModal');
                if (!modal) {
                    console.error('Edit modal not found');
                    return;
                }

                const productId = modal.dataset.productId;
                if (!productId) {
                    console.error('No product ID found');
                    return;
                }

                // Get product to check if it's a supplement
                const product = products.find(p => p.id === productId || p._id === productId);
                const isSupplement = product && product.category === 'supplements';

                console.log('Auto-saving stock changes for product:', productId);
                console.log('New stock values:', { newSacks, newKilos, newHalfKilos });
                console.log('Is supplement:', isSupplement);
                console.log('Product category:', product?.category);

                // Prepare stock update data
                const stockUpdateData = {
                    stockSacks: newSacks,
                    stockKilos: newKilos,
                    stockHalfKilos: newHalfKilos
                };

                // For supplements, also update the stock field and reset kilo fields
                if (isSupplement) {
                    stockUpdateData.stock = newSacks;
                    stockUpdateData.stockKilos = 0;
                    stockUpdateData.stockHalfKilos = 0;
                }

                // Send update to backend API
                console.log('Making API request to:', `${API_BASE}/products/${productId}`);
                console.log('Sending stock update data:', stockUpdateData);
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(stockUpdateData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Auto-save error response:', errorData);
                    throw new Error(errorData.details || errorData.error || 'Failed to auto-save stock changes');
                }

                const result = await response.json();
                console.log('Stock auto-saved successfully:', result);

                // Refresh the products list to show updated stock
                await loadProducts();

            } catch (error) {
                console.error('Error auto-saving stock changes:', error);
                
                // Check if it's a network error
                if (error.message.includes('Failed to fetch') || error.message.includes('ERR_BLOCKED_BY_CLIENT')) {
                    showNotification('Network error: Please check your connection and try again. If using ngrok, ensure the tunnel is active.', 'error');
                } else {
                    showNotification(`Failed to auto-save stock: ${error.message}`, 'error');
                }
            }
        }

        // Clear Edit Image
        function clearEditImage() {
            const imagePreview = document.getElementById('editImagePreview');
            const uploadPlaceholder = document.getElementById('editUploadPlaceholder');
            const imageActions = document.getElementById('editImageActions');
            const fileInput = document.getElementById('editProductImage');
            
            if (imagePreview) imagePreview.style.display = 'none';
            if (uploadPlaceholder) uploadPlaceholder.style.display = 'flex';
            if (imageActions) imageActions.style.display = 'none';
            if (fileInput) fileInput.value = '';
        }

        // Delete Product
        function deleteProduct(productId) {
            console.log('Delete product called for ID:', productId);
            
            // Find the product to get its name for confirmation
            const product = products.find(p => p._id === productId);
            if (!product) {
                console.error('Product not found');
                return;
            }
            
            // Show confirmation dialog
            const confirmDelete = confirm(`Are you sure you want to delete "${product.name}"?\n\nThis action cannot be undone.`);
            
            if (confirmDelete) {
                // Remove product from array
                const productIndex = products.findIndex(p => p._id === productId);
                if (productIndex !== -1) {
                    products.splice(productIndex, 1);
                    
                    // Re-render the products
                    renderProducts();
                    
                    // Update cards info
                    updateCardsInfo(products.length);
                    
                    // Update product statistics
                    updateProductStats();
                    
                    console.log('Product deleted successfully');
                    alert('Product deleted successfully!');
                } else {
                    console.error('Product not found in array');
                    alert('Error: Product not found');
                }
            }
        }

        // Save Edit Product
        async function saveEditProduct() {
            console.log('Save edit product called');
            
            const form = document.getElementById('productEditForm');
            if (!form) {
                console.error('Edit form not found');
                return;
            }
            
            const formData = new FormData(form);
            
            // Get the current product ID from the modal
            const modal = document.getElementById('productEditModal');
            if (!modal) {
                console.error('Edit modal not found');
                return;
            }
            
            const productId = modal.dataset.productId;
            if (!productId) {
                console.error('No product ID found');
                return;
            }
            
            console.log('Product ID:', productId);
            
            // Convert FormData to object - only include fields that are being updated
            const productData = {
                name: formData.get('name'),
                description: formData.get('description') || 'No description provided',
                animal: formData.get('animal'),
                category: formData.get('category'),
                pricePerSack: parseFloat(formData.get('pricePerSack')) || 0,
                pricePerKilo: parseFloat(formData.get('pricePerKilo')) || 0,
                costPerSack: parseFloat(formData.get('costPerSack')) || 0,
                netWeightPerSack: parseFloat(formData.get('netWeightPerSack')) || 25
            };
            
            // Get current stock values from the display (not from form fields)
            // This ensures we use the auto-saved values, not the original form values
            const currentStockDisplay = document.getElementById('currentStockAmount');
            const currentKilosDisplay = document.getElementById('currentStockKilos');
            const currentHalfKilosDisplay = document.getElementById('currentStockHalfKilos');
            
            if (currentStockDisplay && currentKilosDisplay && currentHalfKilosDisplay) {
                productData.stockSacks = parseInt(currentStockDisplay.textContent) || 0;
                productData.stockKilos = parseInt(currentKilosDisplay.textContent) || 0;
                productData.stockHalfKilos = parseInt(currentHalfKilosDisplay.textContent) || 0;
            } else {
                // Fallback to form values if display elements not found
                productData.stockSacks = parseInt(formData.get('stockSacks')) || 0;
                productData.stockKilos = parseInt(formData.get('stockKilos')) || 0;
                productData.stockHalfKilos = parseInt(formData.get('stockHalfKilos')) || 0;
            }
            
            // Handle image upload if a new image was selected
            const imageFile = formData.get('imageFile');
            if (imageFile && imageFile.size > 0) {
                try {
                    // Convert image to base64
                    const base64Image = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageFile);
                    });
                    productData.imageUrl = base64Image;
                    console.log('New image uploaded and converted to base64');
                } catch (error) {
                    console.error('Error processing image:', error);
                    showNotification('Error processing image', 'error');
                    return;
                }
            }
            
            console.log('Product data to save:', productData);
            console.log('Current products array:', products);
            
            // Basic validation
            if (!productData.name || !productData.animal || !productData.category) {
                alert('Please fill in all required fields (Name, Animal, Category)');
                return;
            }
            
            if (productData.pricePerSack <= 0 || productData.pricePerKilo <= 0) {
                alert('Please enter valid prices (greater than 0)');
                return;
            }
            
            // Send update to backend API
            try {
                console.log('Sending product update to API:', productData);
                
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(productData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Server error response:', errorData);
                    throw new Error(errorData.details || errorData.error || 'Failed to update product');
                }
                
                const result = await response.json();
                console.log('Product updated successfully:', result);
                
                // Refresh the products list from the server
                await loadProducts();
                
                // Close the modal
                closeEditModal();
                
                showNotification('Product updated successfully! Sales profits recalculated automatically.', 'success');
                
                // Also refresh the sales display to show updated profits
                setTimeout(() => {
                    updateDailySalesDisplay();
                }, 1000);
                
            } catch (error) {
                console.error('Error updating product:', error);
                showNotification(`Failed to update product: ${error.message}`, 'error');
            }
        }
        
        
        // Update stock (placeholder)
        function updateStock(productId) {
            alert('Update stock functionality will be implemented!');
        }
        
        
        // Navigation function
        function switchSection(sectionId) {
            console.log('Switching to section:', sectionId);
            
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section (if it exists)
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('Successfully switched to section:', sectionId);
            } else {
                console.warn(`Section with id "${sectionId}" not found`);
            }
            
            // Add active class to clicked button (if it exists)
            const targetButton = document.querySelector(`[data-section="${sectionId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            } else {
                console.warn(`Button with data-section="${sectionId}" not found`);
            }
            
            // Load products when switching to products section
            if (sectionId === 'products') {
                loadProducts();
                startProductsAutoRefresh(); // Start auto-refresh when on products section
            } else {
                stopProductsAutoRefresh(); // Stop auto-refresh when leaving products section
            }
            
            // Load analytics when switching to analytics section
            if (sectionId === 'analytics') {
                loadAnalytics();
            }
            
            // Load staff when switching to staff section
            if (sectionId === 'staff') {
                loadStaff();
            }
        }
        
        // Product Management Variables
        let products = [];
        let editingProductId = null;
        
        // Recent Sales Pagination Variables
        let recentSalesData = [];
        let currentSalesPage = 1;
        const salesItemsPerPage = 10;
        let totalSalesPages = 1;
        
        // Forecasting Recent Sales Pagination Variables
        let forecastingSalesData = [];
        let currentForecastingPage = 1;
        const forecastingItemsPerPage = 10;
        let totalForecastingPages = 1;
        
        
        // Load products from database
        async function loadProductsFromDB() {
            try {
                const response = await fetch(`${API_BASE}/products?_t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Map _id to id for compatibility with existing code
                    products = (result.products || []).map(product => ({
                        ...product,
                        id: product._id || product.id,
                        // Fix image URLs to use full backend URL
                        imageUrl: product.imageUrl && !product.imageUrl.startsWith('http') && !product.imageUrl.startsWith('data:')
                            ? `${API_URL}${product.imageUrl}`
                            : product.imageUrl
                    }));
                    console.log(' Loaded products from database:', products.length);
                    
                    // Debug image URLs
                    products.forEach(product => {
                        console.log(' Product:', product.name, 'Image URL:', product.imageUrl ? 'Present' : 'Missing');
                        if (product.imageUrl) {
                            console.log(' Image URL length:', product.imageUrl.length, 'First 50 chars:', product.imageUrl.substring(0, 50));
                        }
                    });
                } else {
                    console.error('Failed to load products from database');
                    // Fallback to empty array
                    products = [];
                }
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
            }
        }

        // Sample products data (fallback)
        const sampleProducts = [
            // CHICKEN - Feeds
            {
                id: 1,
                name: 'Premium Starter Feed',
                description: 'High-quality starter feed for young chickens (0-8 weeks)',
                animal: 'chicken',
                category: 'feeds',
                type: 'starter',
                price: 25.99,
                stock: 45,
                unit: 'bag',
                imageUrl: ''
            },
            {
                id: 2,
                name: 'Layer Feed Complete',
                description: 'Complete nutrition for laying hens',
                animal: 'chicken',
                category: 'feeds',
                type: 'layer',
                price: 27.99,
                stock: 5,
                unit: 'bag',
                imageUrl: ''
            },
            {
                id: 3,
                name: 'Chicken Grower Feed',
                description: 'Balanced nutrition for growing chickens (8-20 weeks)',
                animal: 'chicken',
                category: 'feeds',
                type: 'grower',
                price: 24.99,
                stock: 32,
                unit: 'bag',
                imageUrl: ''
            },
            // CHICKEN - Supplements
            {
                id: 4,
                name: 'Poultry Vitamin Complex',
                description: 'Complete vitamin supplement for all poultry',
                animal: 'chicken',
                category: 'supplements',
                type: 'vitamins',
                price: 15.99,
                stock: 30,
                unit: 'kg',
                imageUrl: ''
            },
            {
                id: 5,
                name: 'Chicken Mineral Mix',
                description: 'Essential minerals for chicken health and egg production',
                animal: 'chicken',
                category: 'supplements',
                type: 'minerals',
                price: 12.99,
                stock: 25,
                unit: 'kg',
                imageUrl: ''
            },
            // PIG - Feeds
            {
                id: 6,
                name: 'Piglet Starter Feed',
                description: 'Premium starter feed for piglets (3-8 weeks)',
                animal: 'pig',
                category: 'feeds',
                type: 'starter',
                price: 32.99,
                stock: 38,
                unit: 'bag',
                imageUrl: ''
            },
            {
                id: 7,
                name: 'Pig Finisher Feed',
                description: 'Final stage feed for market-ready pigs',
                animal: 'pig',
                category: 'feeds',
                type: 'finisher',
                price: 28.99,
                stock: 8,
                unit: 'bag',
                imageUrl: ''
            },
            {
                id: 8,
                name: 'Pig Grower Feed',
                description: 'High-energy feed for growing pigs (8-20 weeks)',
                animal: 'pig',
                category: 'feeds',
                type: 'grower',
                price: 30.99,
                stock: 15,
                unit: 'bag',
                imageUrl: ''
            },
            // PIG - Supplements
            {
                id: 9,
                name: 'Pig Vitamin Supplement',
                description: 'Specialized vitamins for pig health and growth',
                animal: 'pig',
                category: 'supplements',
                type: 'vitamins',
                price: 18.99,
                stock: 20,
                unit: 'kg',
                imageUrl: ''
            },
            {
                id: 10,
                name: 'Pig Mineral Premix',
                description: 'Essential minerals for pig bone and muscle development',
                animal: 'pig',
                category: 'supplements',
                type: 'minerals',
                price: 14.99,
                stock: 18,
                unit: 'kg',
                imageUrl: ''
            }
        ];
        
        // Update product statistics
        function updateProductStats() {
            if (!products || products.length === 0) {
                document.getElementById('totalProductsCount').textContent = '0';
                document.getElementById('pigProductsCount').textContent = '0';
                document.getElementById('chickenProductsCount').textContent = '0';
                document.getElementById('lowStockCount').textContent = '0';
                return;
            }

            // Calculate statistics
            const totalProducts = products.length;
            const pigProducts = products.filter(p => p.animal === 'pig').length;
            const chickenProducts = products.filter(p => p.animal === 'chicken').length;
            
            // Calculate low stock items (assuming low stock is <= 3)
            const lowStockItems = products.filter(p => {
                const totalStock = getTotalStock(p);
                return totalStock <= 3;
            }).length;

            // Update the display
            document.getElementById('totalProductsCount').textContent = totalProducts;
            document.getElementById('pigProductsCount').textContent = pigProducts;
            document.getElementById('chickenProductsCount').textContent = chickenProducts;
            document.getElementById('lowStockCount').textContent = lowStockItems;

            console.log(' Product stats updated:', {
                total: totalProducts,
                pig: pigProducts,
                chicken: chickenProducts,
                lowStock: lowStockItems
            });
        }

        // Show low stock modal
        function showLowStockModal() {
            const modal = document.getElementById('lowStockModal');
            if (!modal) return;
            
            // Get low stock products
            const lowStockProducts = getLowStockProducts();
            
            // Update modal content
            const lowStockList = document.getElementById('lowStockList');
            if (lowStockProducts.length === 0) {
                lowStockList.innerHTML = '<div class="no-data"> No products are low in stock!</div>';
            } else {
                lowStockList.innerHTML = lowStockProducts.map(product => {
                    const isSupplement = product.category === 'supplements';
                    
                    // Create stock breakdown based on product category
                    let stockBreakdown = '';
                    if (isSupplement) {
                        // For supplements, show only sacks
                        stockBreakdown = `
                            <div class="stock-breakdown">
                                <span class="stock-detail">Sacks: ${formatStockValue(product.stockSacks)}</span>
                            </div>
                        `;
                    } else {
                        // For feeds, show all units
                        stockBreakdown = `
                            <div class="stock-breakdown">
                                <span class="stock-detail">Sacks: ${formatStockValue(product.stockSacks)}</span>
                                <span class="stock-detail">Kilos: ${formatStockValue(product.stockKilos)}</span>
                                <span class="stock-detail">Half Kilos: ${formatStockValue(product.stockHalfKilos)}</span>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="low-stock-item">
                            <div class="product-info">
                                <h4>${product.name}</h4>
                                <p class="product-category">${product.animal}  ${product.category}</p>
                                <div class="stock-info">
                                    <span class="stock-label">Current Stock:</span>
                                    <span class="stock-value ${getStockLevel(product)}">${getTotalStock(product)}</span>
                                </div>
                                ${stockBreakdown}
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-sm btn-primary" onclick="openStockManagementModal('${product.id}')">
                                     Add Stock
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.style.display = 'block';
        }

        // Get low stock products
        function getLowStockProducts() {
            if (!products || products.length === 0) return [];
            
            const lowStockProducts = products.filter(p => {
                const totalStock = getTotalStock(p);
                const isLowStock = totalStock <= 3;
                
                // Debug logging
                if (isLowStock) {
                    console.log('Low stock product found:', {
                        name: p.name,
                        stockSacks: p.stockSacks,
                        stockKilos: p.stockKilos,
                        stock: p.stock,
                        totalStock: totalStock
                    });
                }
                
                return isLowStock;
            });
            
            console.log('Total low stock products found:', lowStockProducts.length);
            return lowStockProducts;
        }

        // Get total stock for a product
        function getTotalStock(product) {
            // Always use stockSacks like the staff dashboard
            return Math.max(0, Math.round((product.stockSacks || 0) * 100) / 100);
        }
        
        // Utility function to format stock values and prevent negative numbers
        function formatStockValue(value) {
            return Math.max(0, Math.round((value || 0) * 100) / 100);
        }

        // Get stock level class for styling
        function getStockLevel(product) {
            const totalStock = getTotalStock(product);
            if (totalStock === 0) return 'out-of-stock';
            if (totalStock <= 2) return 'critical';
            if (totalStock <= 3) return 'low';
            return 'normal';
        }

        // Close low stock modal
        function closeLowStockModal() {
            const modal = document.getElementById('lowStockModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Open stock management modal
        function openStockManagementModal(productId) {
            console.log('Opening stock management modal for product:', productId);
            
            // Find the product
            const product = products.find(p => p.id === productId || p._id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                showNotification('Product not found', 'error');
                return;
            }
            
            // Close the low stock modal
            closeLowStockModal();
            
            // Populate the stock management modal
            document.getElementById('stockProductName').textContent = product.name;
            document.getElementById('stockProductCategory').textContent = `${product.animal}  ${product.category}`;
            document.getElementById('currentStockDisplay').textContent = getTotalStock(product);
            
            // Handle stock breakdown display based on product category
            const stockBreakdownDisplay = document.getElementById('stockBreakdownDisplay');
            const isSupplement = product.category === 'supplements';
            
            // Hide/show help text and calculation display based on product category
            const formHelp = document.querySelector('.form-help');
            const stockCalculationDisplay = document.getElementById('stockCalculationDisplay');
            
            if (isSupplement) {
                // For supplements, show only sacks and hide help text/calculations
                stockBreakdownDisplay.innerHTML = `
                    <span class="stock-detail">Sacks: <span id="currentSacks">${formatStockValue(product.stockSacks)}</span></span>
                `;
                
                // Hide the help text and calculation display for supplements
                if (formHelp) formHelp.style.display = 'none';
                if (stockCalculationDisplay) stockCalculationDisplay.style.display = 'none';
            } else {
                // For feeds, show all units and show help text/calculations
                stockBreakdownDisplay.innerHTML = `
                    <span class="stock-detail">Sacks: <span id="currentSacks">${formatStockValue(product.stockSacks)}</span></span>
                    <span class="stock-detail">Kilos: <span id="currentKilos">${formatStockValue(product.stockKilos)}</span></span>
                    <span class="stock-detail">Half Kilos: <span id="currentHalfKilos">${formatStockValue(product.stockHalfKilos)}</span></span>
                `;
                
                // Show the help text and calculation display for feeds
                if (formHelp) formHelp.style.display = 'block';
                if (stockCalculationDisplay) stockCalculationDisplay.style.display = 'none'; // Initially hidden, will show on input
            }
            
            // Set the product ID in the modal
            const modal = document.getElementById('stockManagementModal');
            modal.dataset.productId = product.id || product._id;
            
            // Reset the form
            document.getElementById('stockManagementForm').reset();
            
            // Show the modal
            modal.style.display = 'block';
        }

        // Close stock management modal
        function closeStockManagementModal() {
            const modal = document.getElementById('stockManagementModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Update stock calculation display in real-time
        function updateStockCalculation() {
            const sacksToAdd = parseInt(document.getElementById('stockToAddSacks').value) || 0;
            const calculationDisplay = document.getElementById('stockCalculationDisplay');
            
            if (sacksToAdd === 0) {
                calculationDisplay.style.display = 'none';
                return;
            }
            
            // Get current product data
            const modal = document.getElementById('stockManagementModal');
            const productId = modal.dataset.productId;
            const product = products.find(p => p.id === productId || p._id === productId);
            
            if (!product) return;
            
            const isSupplement = product.category === 'supplements';
            
            // Calculate new stock values
            const currentSacks = formatStockValue(product.stockSacks);
            const newSacks = currentSacks + sacksToAdd;
            
            // Update display based on product category
            if (isSupplement) {
                // For supplements, show only sacks
                document.getElementById('newStockSacks').textContent = `Sacks: ${formatStockValue(newSacks)}`;
                // Hide kilo and half-kilo calculations for supplements
                const kiloElement = document.getElementById('newStockKilos');
                const halfKiloElement = document.getElementById('newStockHalfKilos');
                if (kiloElement) kiloElement.style.display = 'none';
                if (halfKiloElement) halfKiloElement.style.display = 'none';
            } else {
                // For feeds, show all units
                const netWeightPerSack = product.netWeightPerSack || 25;
                const currentKilos = formatStockValue(product.stockKilos);
                const currentHalfKilos = formatStockValue(product.stockHalfKilos);
                
                const newKilos = newSacks * netWeightPerSack;
                const newHalfKilos = newSacks * netWeightPerSack * 2;
                
                document.getElementById('newStockSacks').textContent = `Sacks: ${formatStockValue(newSacks)}`;
                document.getElementById('newStockKilos').textContent = `Kilos: ${formatStockValue(newKilos)}`;
                document.getElementById('newStockHalfKilos').textContent = `Half Kilos: ${formatStockValue(newHalfKilos)}`;
                
                // Show kilo and half-kilo calculations for feeds
                const kiloElement = document.getElementById('newStockKilos');
                const halfKiloElement = document.getElementById('newStockHalfKilos');
                if (kiloElement) kiloElement.style.display = 'block';
                if (halfKiloElement) halfKiloElement.style.display = 'block';
            }
            
            calculationDisplay.style.display = 'block';
        }

        // Handle stock management form submission
        async function handleStockManagementSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const stockToAddSacks = parseInt(formData.get('stockToAddSacks')) || 0;
            
            // Check if sacks field has a value
            if (stockToAddSacks === 0) {
                showNotification('Please enter the number of sacks to add', 'warning');
                return;
            }
            
            const modal = document.getElementById('stockManagementModal');
            const productId = modal.dataset.productId;
            
            if (!productId) {
                showNotification('Product ID not found', 'error');
                return;
            }
            
            // Find the product
            const product = products.find(p => p.id === productId || p._id === productId);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            
            try {
                // Get net weight per sack (default to 25kg if not set)
                const netWeightPerSack = product.netWeightPerSack || 25;
                
                // Calculate new stock values - only add sacks, kilos and half-kilos are calculated automatically
                const newStockSacks = (product.stockSacks || 0) + stockToAddSacks;
                const newStockKilos = newStockSacks * netWeightPerSack; // Auto-calculate from sacks
                const newStockHalfKilos = newStockSacks * netWeightPerSack * 2; // Auto-calculate from sacks
                
                // Prepare update data
                let updateData = {
                    stockSacks: newStockSacks
                };
                
                if (product.category === 'supplements') {
                    // For supplements, only update simple stock and zero out kilo fields
                    updateData.stock = newStockSacks;
                    updateData.stockKilos = 0;
                    updateData.stockHalfKilos = 0;
                } else {
                    // For feeds, update all units
                    updateData.stockKilos = newStockKilos;
                    updateData.stockHalfKilos = newStockHalfKilos;
                }
                
                // Update the product in the database
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    // Reload products from database to ensure we have the latest data
                    await loadProductsFromDB();
                    
                    // Update statistics
                    updateProductStats();
                    
                    // Re-render the product cards to show updated stock
                    renderProductCards();
                    
                    // Close modal
                    closeStockManagementModal();
                    
                    // Show success message
                    showNotification(`Successfully added ${stockToAddSacks} sacks to ${product.name}`, 'success');
                    
                    // Refresh the low stock modal if it's open
                    if (document.getElementById('lowStockModal').style.display === 'block') {
                        // Close and reopen the low stock modal to refresh the list
                        closeLowStockModal();
                        setTimeout(() => {
                            showLowStockModal();
                        }, 100);
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to update stock', 'error');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showNotification('Failed to update stock', 'error');
            }
        }

        // Edit product from low stock modal
        function editProductFromLowStock(productId) {
            console.log('Editing product from low stock:', productId);
            
            // Close the low stock modal first
            closeLowStockModal();
            
            // Find the product
            const product = products.find(p => p.id === productId || p._id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                showNotification('Product not found', 'error');
                return;
            }
            
            // Open the edit modal for this product
            openEditModalWithProduct(product);
        }

        // Open edit modal for a specific product object
        function openEditModalWithProduct(product) {
            console.log('Opening edit modal for product:', product);
            
            // Check if product is a string ID instead of an object
            if (typeof product === 'string') {
                console.log('Product is a string ID, finding product object...');
                const productObj = products.find(p => p.id === product || p._id === product);
                if (!productObj) {
                    console.error('Product not found with ID:', product);
                    showNotification('Product not found', 'error');
                    return;
                }
                product = productObj;
            }
            
            console.log('Product structure:', {
                id: product.id,
                _id: product._id,
                name: product.name,
                animal: product.animal,
                category: product.category,
                description: product.description
            });
            
            const modal = document.getElementById('productEditModal');
            if (!modal) {
                console.error('Edit modal not found');
                return;
            }
            
            // Set the product ID in the modal
            modal.dataset.productId = product.id || product._id;
            
            // Use the existing populateEditModal function
            populateEditModal(product);
            
            // Show the modal
            modal.style.display = 'block';
        }

        // Load products
        async function loadProducts() {
            await loadProductsFromDB();
            updateProductStats(); // Update statistics after loading products
            renderProducts();
        }

        // Auto-refresh products every 30 seconds when on products section
        let productsRefreshInterval = null;
        
        function startProductsAutoRefresh() {
            if (productsRefreshInterval) {
                clearInterval(productsRefreshInterval);
            }
            
            productsRefreshInterval = setInterval(async () => {
                const currentSection = document.querySelector('.nav-btn.active')?.getAttribute('data-section');
                if (currentSection === 'products') {
                    console.log(' Auto-refreshing products...');
                    await loadProducts();
                }
            }, 30000); // Refresh every 30 seconds
        }
        
        function stopProductsAutoRefresh() {
            if (productsRefreshInterval) {
                clearInterval(productsRefreshInterval);
                productsRefreshInterval = null;
            }
        }
        
        // Load analytics
        async function loadAnalytics(period = 'day') {
            try {
                console.log(' Loading analytics for period:', period);
                
                // Get authentication token
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to view analytics', 'error');
                    return;
                }
                
                const { startDate, endDate } = getDateRangeForPeriod(period);
                console.log(' Date range:', { startDate, endDate });
                
                const params = new URLSearchParams();
                params.append('startDate', startDate.toISOString());
                params.append('endDate', endDate.toISOString());
                
                // Add timestamp to prevent caching
                params.append('_t', Date.now());
                
                console.log(' Making request to date-range API:', `${API_BASE}/orders/date-range?${params}`);
                
                const response = await fetch(`${API_BASE}/orders/date-range?${params}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                console.log(' Response status:', response.status);
                
                const analytics = await response.json();
                console.log(' Raw analytics response:', analytics);
                
                if (response.ok) {
                    updateAnalyticsDisplay(analytics, period);
                } else {
                    console.error('Failed to load analytics:', analytics.error);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        // Load all analytics periods in parallel for speed
        async function loadAllAnalyticsPeriods() {
            console.log(' Loading all analytics periods in parallel...');
            
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Please log in to view analytics', 'error');
                return;
            }
            
            // Show loading skeleton immediately
            showAnalyticsLoading(true);
            
            // Try to show cached data first (from previous session)
            const cachedDay = localStorage.getItem('analytics_day_cache');
            if (cachedDay) {
                try {
                    const cached = JSON.parse(cachedDay);
                    updateAnalyticsDisplay(cached, 'day');
                    showAnalyticsLoading(false);
                    console.log(' Showing cached day data');
                } catch (e) {
                    console.log('Cache parse error, continuing...');
                }
            }
            
            // Create requests for all three periods simultaneously with aggressive timeout
            const requests = ['day', 'month', 'year'].map(period => {
                const { startDate, endDate } = getDateRangeForPeriod(period);
                const params = new URLSearchParams();
                params.append('startDate', startDate);
                params.append('endDate', endDate);
                params.append('_t', Date.now());
                
                // Add timeout controller for faster failure
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                return fetch(`${API_BASE}/orders/date-range?${params}`, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                }).then(response => {
                    clearTimeout(timeoutId);
                    return response.json().then(data => ({ period, data, ok: response.ok }));
                }).catch(error => {
                    clearTimeout(timeoutId);
                    return ({ period, error, ok: false });
                });
            });
            
            // Use Promise.race to show first response immediately instead of waiting for all
            // This shows day view as soon as it arrives
            Promise.race(requests).then(result => {
                if (result.ok) {
                    console.log(` First response arrived (${result.period}):`, result.data);
                    updateAnalyticsDisplay(result.data, result.period);
                    // Cache the data
                    localStorage.setItem(`analytics_${result.period}_cache`, JSON.stringify(result.data));
                    showAnalyticsLoading(false);
                }
            });
            
            // Still fetch all in background
            const results = await Promise.allSettled(requests);
            
            // Process results as they arrive and cache them
            results.forEach((result, index) => {
                if (result.status === 'fulfilled' && result.value.ok) {
                    console.log(` ${result.value.period} analytics loaded`);
                    localStorage.setItem(`analytics_${result.value.period}_cache`, JSON.stringify(result.value.data));
                } else {
                    console.error(` Failed to load analytics`);
                }
            });
            
            showAnalyticsLoading(false);
            console.log(' All analytics periods loaded');
        }
        
        // Get date range based on period
        function getDateRangeForPeriod(period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'day':
                case 'today':
                    // Today
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    break;
                case 'month':
                    // Current month
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'year':
                    // Current year
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                default:
                    // Default to today
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            }
            
            return {
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            };
        }
        
        // Show/hide analytics loading state
        function showAnalyticsLoading(isLoading) {
            const analyticsSection = document.getElementById('analytics');
            if (!analyticsSection) return;
            
            if (isLoading) {
                analyticsSection.style.opacity = '0.7';
                analyticsSection.style.pointerEvents = 'none';
            } else {
                analyticsSection.style.opacity = '1';
                analyticsSection.style.pointerEvents = 'auto';
            }
        }
        
        // Switch analytics period
        function switchAnalyticsPeriod(period) {
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Load analytics for the selected period
            loadAnalytics(period);
        }
        
        // Process raw orders data into analytics format
        function processOrdersToAnalytics(ordersData) {
            console.log(' Processing', ordersData.length, 'orders into analytics...');
            
            if (!ordersData || ordersData.length === 0) {
                return {
                    totalSales: 0,
                    totalRevenue: 0,
                    totalCost: 0,
                    totalProfit: 0,
                    salesByAnimal: { chicken: { count: 0, revenue: 0 }, pig: { count: 0, revenue: 0 } },
                    salesByCategory: { feeds: { count: 0, revenue: 0 }, supplements: { count: 0, revenue: 0 } },
                    topProducts: [],
                    sales: []
                };
            }
            
            const salesByAnimal = { chicken: { count: 0, revenue: 0 }, pig: { count: 0, revenue: 0 } };
            const salesByCategory = { feeds: { count: 0, revenue: 0 }, supplements: { count: 0, revenue: 0 } };
            const productMap = {};
            let totalRevenue = 0;
            
            ordersData.forEach(order => {
                if (!order.items) return;
                
                order.items.forEach(item => {
                    const itemRevenue = (item.price || 0) * (item.quantity || 1);
                    
                    // Count and revenue by animal type
                    const animalType = item.animalType?.toLowerCase() || 'chicken';
                    if (salesByAnimal[animalType]) {
                        salesByAnimal[animalType].count += item.quantity || 1;
                        salesByAnimal[animalType].revenue += itemRevenue;
                    }
                    
                    // Count and revenue by category
                    const category = item.category?.toLowerCase() || 'feeds';
                    if (salesByCategory[category]) {
                        salesByCategory[category].count += item.quantity || 1;
                        salesByCategory[category].revenue += itemRevenue;
                    }
                    
                    // Track top products
                    const productName = item.name || item.productName || 'Unknown';
                    if (!productMap[productName]) {
                        productMap[productName] = { name: productName, quantity: 0, revenue: 0 };
                    }
                    productMap[productName].quantity += item.quantity || 1;
                    productMap[productName].revenue += itemRevenue;
                });
                
                totalRevenue += order.total || order.totalAmount || 0;
            });
            
            console.log(' Breakdown calculations:', {
                salesByAnimal,
                salesByCategory,
                totalRevenue
            });
            
            // Convert product map to sorted array
            const topProducts = Object.values(productMap)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 10);
            
            return {
                totalSales: ordersData.length,
                totalRevenue: totalRevenue,
                totalCost: 0,
                totalProfit: totalRevenue,
                salesByAnimal,
                salesByCategory,
                topProducts,
                sales: ordersData.slice(0, 10)
            };
        }
        
        // Update analytics display
        function updateAnalyticsDisplay(analyticsOrOrders, period = 'day') {
            console.log(' Updating analytics display with data:', analyticsOrOrders);
            
            // If we received raw orders data, process it first
            let analytics;
            if (Array.isArray(analyticsOrOrders)) {
                analytics = processOrdersToAnalytics(analyticsOrOrders);
            } else if (analyticsOrOrders.orders) {
                analytics = processOrdersToAnalytics(analyticsOrOrders.orders);
            } else {
                analytics = analyticsOrOrders;
            }
            
            document.getElementById('totalSales').textContent = analytics.totalSales;
            document.getElementById('totalRevenue').textContent = `${analytics.totalRevenue.toFixed(2)}`;
            
            // Update animal sales
            const chickenSales = analytics.salesByAnimal.chicken ? analytics.salesByAnimal.chicken.count : 0;
            const pigSales = analytics.salesByAnimal.pig ? analytics.salesByAnimal.pig.count : 0;
            
            console.log(' Chicken sales:', chickenSales);
            console.log(' Pig sales:', pigSales);
            
            document.getElementById('chickenSales').textContent = chickenSales;
            document.getElementById('pigSales').textContent = pigSales;
            
            // Update charts
            updateAnimalChart(analytics.salesByAnimal);
            updateCategoryChart(analytics.salesByCategory);
            
            // Update top products
            updateTopProducts(analytics.topProducts);
            
            // Update recent sales
            updateRecentSales(analytics.sales);
        }
        
        // Update animal chart
        function updateAnimalChart(salesByAnimal) {
            const chart = document.getElementById('animalChart');
            const chickenCount = salesByAnimal.chicken ? salesByAnimal.chicken.count : 0;
            const pigCount = salesByAnimal.pig ? salesByAnimal.pig.count : 0;
            
            chart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #e3f2fd; border-radius: 5px;">
                        <span> Chicken</span>
                        <strong>${chickenCount} sales</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f3e5f5; border-radius: 5px;">
                        <span> Pig</span>
                        <strong>${pigCount} sales</strong>
                    </div>
                </div>
            `;
        }
        
        // Update category chart
        function updateCategoryChart(salesByCategory) {
            const chart = document.getElementById('categoryChart');
            const feedsCount = salesByCategory.feeds ? salesByCategory.feeds.count : 0;
            const supplementsCount = salesByCategory.supplements ? salesByCategory.supplements.count : 0;
            
            chart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #e8f5e8; border-radius: 5px;">
                        <span> Feeds</span>
                        <strong>${feedsCount} sales</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #fff3cd; border-radius: 5px;">
                        <span> Supplements</span>
                        <strong>${supplementsCount} sales</strong>
                    </div>
                </div>
            `;
        }
        
        // Update top products
        function updateTopProducts(topProducts) {
            const container = document.getElementById('topProductsList');
            container.innerHTML = topProducts.map((product, index) => `
                <div class="top-product-item">
                    <span>${index + 1}. ${product.name}</span>
                    <span>${product.quantity} units sold</span>
                </div>
            `).join('');
        }
        
        // Update recent sales with pagination
        function updateRecentSales(recentSales) {
            console.log(' Updating analytics recent sales with', recentSales.length, 'sales');
            console.log(' Recent sales data:', recentSales);
            
            // Store all sales data for pagination
            recentSalesData = recentSales || [];
            
            // Calculate total pages
            totalSalesPages = Math.max(1, Math.ceil(recentSalesData.length / salesItemsPerPage));
            
            // Reset to page 1 if current page is beyond total pages
            if (currentSalesPage > totalSalesPages) {
                currentSalesPage = 1;
            }
            
            // Update pagination display
            updateSalesPagination();
            
            // Update total sales summary
            updateTotalSalesSummary();
            
            // Get current page data
            const startIndex = (currentSalesPage - 1) * salesItemsPerPage;
            const endIndex = startIndex + salesItemsPerPage;
            const currentPageSales = recentSalesData.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('analyticsRecentSalesTableBody');
            
            if (currentPageSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #a09080;">No recent sales data</td></tr>';
                return;
            }
            
            tbody.innerHTML = currentPageSales.map((sale, index) => {
                try {
                    // Highlight the newest sale (first in the sorted list)
                    const isNewest = index === 0;
                    const highlightClass = isNewest ? 'newest-sale' : '';
                    const highlightStyle = isNewest ? 'background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-left: 4px solid #4CAF50; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);' : '';
                    
                    return `
                        <tr class="${highlightClass}" style="${highlightStyle}">
                            <td>${sale.productName || 'Unknown Product'}${isNewest ? ' ' : ''}</td>
                            <td>${sale.customerName || sale.customerInfo?.name || 'N/A'}</td>
                            <td>${sale.quantity || 0}</td>
                            <td>${sale.unit || 'N/A'}</td>
                            <td>${(sale.totalAmount || 0).toFixed(2)}</td>
                    <td>${new Date(sale.saleDate).toLocaleDateString()}</td>
                </tr>
                    `;
                } catch (error) {
                    console.error('Error rendering sale row:', error, sale);
                    return '<tr><td colspan="6">Error displaying sale</td></tr>';
                }
            }).join('');
        }
        
        // Update pagination controls
        function updateSalesPagination() {
            const paginationInfo = document.getElementById('salesPaginationInfo');
            const prevBtn = document.getElementById('prevSalesPage');
            const nextBtn = document.getElementById('nextSalesPage');
            const pageNumbers = document.getElementById('salesPageNumbers');
            
            // Update pagination info
            paginationInfo.textContent = `Page ${currentSalesPage} of ${totalSalesPages}`;
            
            // Update button states
            prevBtn.disabled = currentSalesPage <= 1;
            nextBtn.disabled = currentSalesPage >= totalSalesPages;
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentSalesPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalSalesPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `pagination-btn ${i === currentSalesPage ? 'active' : ''}`;
                pageBtn.style.cssText = 'padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px; margin: 0 2px;';
                if (i === currentSalesPage) {
                    pageBtn.style.background = '#2c5530';
                    pageBtn.style.color = 'white';
                }
                pageBtn.addEventListener('click', () => goToSalesPage(i));
                pageNumbers.appendChild(pageBtn);
            }
        }
        
        // Update total sales summary
        function updateTotalSalesSummary() {
            const totalCount = document.getElementById('totalSalesCount');
            const totalRevenue = document.getElementById('totalSalesRevenue');
            
            const totalTransactions = recentSalesData.length;
            const totalRevenueAmount = recentSalesData.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            
            totalCount.textContent = totalTransactions;
            totalRevenue.textContent = totalRevenueAmount.toFixed(2);
        }
        
        // Navigate to specific sales page
        function goToSalesPage(page) {
            if (page >= 1 && page <= totalSalesPages) {
                currentSalesPage = page;
                updateRecentSales(recentSalesData); // Refresh with same data
            }
        }
        
        // Navigate to previous sales page
        function prevSalesPage() {
            if (currentSalesPage > 1) {
                goToSalesPage(currentSalesPage - 1);
            }
        }
        
        // Navigate to next sales page
        function nextSalesPage() {
            if (currentSalesPage < totalSalesPages) {
                goToSalesPage(currentSalesPage + 1);
            }
        }
        
        // Render products table
        function renderProducts() {
            const productsGrid = document.getElementById('productsGrid');
            const emptyState = document.getElementById('emptyState');
            const activeCategoryBtn = document.querySelector('.category-btn.active');
            const selectedAnimal = activeCategoryBtn ? activeCategoryBtn.getAttribute('data-category') : '';
            
            // Find the active subcategory button in the selected animal group
            let selectedCategory = '';
            if (selectedAnimal && selectedAnimal !== '') {
                const animalGroup = document.querySelector(`[data-category="${selectedAnimal}"]`).closest('.animal-category-group');
                const activeSubcategoryBtn = animalGroup.querySelector('.subcategory-btn.active');
                selectedCategory = activeSubcategoryBtn ? activeSubcategoryBtn.getAttribute('data-subcategory') : '';
            }
            
            
            let filteredProducts = products;
            
            // Apply animal filter
            if (selectedAnimal) {
                filteredProducts = filteredProducts.filter(product => product.animal === selectedAnimal);
            }
            
            // Apply category filter (feeds/supplements)
            if (selectedCategory) {
                filteredProducts = filteredProducts.filter(product => product.category === selectedCategory);
            }
            
            
            if (filteredProducts.length === 0) {
                if (productsGrid) productsGrid.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                updateCardsInfo(0);
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            if (productsGrid) {
                productsGrid.style.display = 'grid';
                productsGrid.innerHTML = filteredProducts.map(product => createProductCard(product)).join('');
                
                // Apply conditional scrolling based on product count
                if (filteredProducts.length > 8) {
                    productsGrid.classList.add('scrollable');
                    console.log(' Applied scrollable class for', filteredProducts.length, 'products');
                    console.log(' productsGrid classes:', productsGrid.className);
                } else {
                    productsGrid.classList.remove('scrollable');
                    console.log(' Removed scrollable class for', filteredProducts.length, 'products');
                }
            }
            
            updateCardsInfo(filteredProducts.length);
        }
        
        // Test function to manually check field visibility (for debugging)
        window.testFieldVisibility = function() {
            console.log('=== FIELD VISIBILITY TEST ===');
            const supplementPriceGroup = document.getElementById('supplementPriceGroup');
            const supplementStockGroup = document.getElementById('supplementStockGroup');
            const pricePerSackGroup = document.querySelector('label[for="productPricePerSack"]')?.parentElement;
            const pricePerKiloGroup = document.querySelector('label[for="productPricePerKilo"]')?.parentElement;
            
            console.log('Elements found:', {
                supplementPriceGroup: supplementPriceGroup,
                supplementStockGroup: supplementStockGroup,
                pricePerSackGroup: pricePerSackGroup,
                pricePerKiloGroup: pricePerKiloGroup
            });
            
            if (supplementPriceGroup) {
                console.log('Supplement price group display:', supplementPriceGroup.style.display);
            }
            if (supplementStockGroup) {
                console.log('Supplement stock group display:', supplementStockGroup.style.display);
            }
        };
        
        // Test function to manually trigger category change
        window.testCategoryChange = function(category) {
            console.log('=== MANUAL CATEGORY CHANGE TEST ===');
            const productCategory = document.getElementById('productCategory');
            if (productCategory) {
                productCategory.value = category;
                productCategory.dispatchEvent(new Event('change'));
                console.log('Triggered category change to:', category);
            } else {
                console.log('Product category element not found');
            }
        };
        
        // Test function to manually hide/show fields
        window.testHideFields = function() {
            console.log('=== MANUAL FIELD HIDE TEST ===');
            const pricePerSackGroup = document.querySelector('label[for="productPricePerSack"]')?.parentElement;
            const pricePerKiloGroup = document.querySelector('label[for="productPricePerKilo"]')?.parentElement;
            const stockSacksGroup = document.querySelector('label[for="productStockSacks"]')?.parentElement;
            const supplementPriceGroup = document.getElementById('supplementPriceGroup');
            const supplementStockGroup = document.getElementById('supplementStockGroup');
            
            console.log('Hiding kilo/sack fields...');
            if (pricePerSackGroup) pricePerSackGroup.style.display = 'none';
            if (pricePerKiloGroup) pricePerKiloGroup.style.display = 'none';
            if (stockSacksGroup) stockSacksGroup.style.display = 'none';
            
            console.log('Showing supplement fields...');
            if (supplementPriceGroup) supplementPriceGroup.style.display = 'block';
            if (supplementStockGroup) supplementStockGroup.style.display = 'block';
            
            console.log('Fields should now be hidden/shown');
        };
        
        // Function to manually show cost price field
        window.showCostPriceField = function() {
            console.log('=== MANUAL COST PRICE FIELD SHOW ===');
            const costPerSackElement = document.getElementById('costPerSackGroup');
            if (costPerSackElement) {
                costPerSackElement.style.display = 'block';
                costPerSackElement.style.visibility = 'visible';
                costPerSackElement.style.opacity = '1';
                console.log(' Cost price field shown manually');
            } else {
                console.log(' Cost price field not found');
                // Try alternative selectors
                const modal = document.getElementById('productModal');
                if (modal) {
                    const allFormGroups = modal.querySelectorAll('.form-group');
                    allFormGroups.forEach((group, index) => {
                        if (group.id === 'costPerSackGroup') {
                            group.style.display = 'block';
                            group.style.visibility = 'visible';
                            group.style.opacity = '1';
                            console.log(' Found and showed cost price field at index', index);
                        }
                    });
                }
            }
        };
        
        // Inline category change handler
        window.handleCategoryChange = function(category) {
            console.log('=== INLINE CATEGORY CHANGE ===');
            console.log('Category changed to:', category);
            
            // Update type options
            const productType = document.getElementById('productType');
            if (productType) {
                productType.innerHTML = '<option value="">Select Type</option>';
                
                if (category === 'feeds') {
                    productType.innerHTML += `
                        <option value="starter">Starter</option>
                        <option value="grower">Grower</option>
                        <option value="layer">Layer</option>
                        <option value="finisher">Finisher</option>
                    `;
                } else if (category === 'supplements') {
                    productType.innerHTML += `
                        <option value="vitamins">Vitamins</option>
                        <option value="minerals">Minerals</option>
                    `;
                }
            }
            
            // Update field visibility
            updateFieldVisibility(category);
        };

        // Function to update field visibility based on category
        function updateFieldVisibility(category) {
            console.log('Updating field visibility for category:', category);
            
            // Get price and stock fields using more specific selectors
            const pricePerSackGroup = document.querySelector('label[for="productPricePerSack"]')?.parentElement;
            const pricePerKiloGroup = document.querySelector('label[for="productPricePerKilo"]')?.parentElement;
            const costPerSackGroup = document.getElementById('costPerSackGroup');
            const costPerSackNewGroup = document.querySelector('label[for="productCostPerSackNew"]')?.parentElement?.parentElement;
            const feedStockFieldsRow = document.getElementById('feedStockFieldsRow');
            const feedCostPriceRow = document.getElementById('feedCostPriceRow');
            const calculatedStockRow = document.getElementById('calculatedStockRow');
            const supplementPriceGroup = document.getElementById('supplementPriceGroup');
            const supplementStockGroup = document.getElementById('supplementStockGroup');
            const supplementCostGroup = document.getElementById('supplementCostGroup');
            
            console.log('Field elements found:', {
                costPerSackGroup: !!costPerSackGroup,
                pricePerSackGroup: !!pricePerSackGroup,
                pricePerKiloGroup: !!pricePerKiloGroup,
                feedStockFieldsRow: !!feedStockFieldsRow,
                feedCostPriceRow: !!feedCostPriceRow,
                calculatedStockRow: !!calculatedStockRow
            });
            
            if (category === 'supplements') {
                // Hide kilo/sack fields for supplements
                if (pricePerSackGroup) pricePerSackGroup.style.display = 'none';
                if (pricePerKiloGroup) pricePerKiloGroup.style.display = 'none';
                if (costPerSackGroup) costPerSackGroup.style.display = 'none';
                if (feedStockFieldsRow) feedStockFieldsRow.style.display = 'none';
                if (feedCostPriceRow) feedCostPriceRow.style.display = 'none';
                if (calculatedStockRow) calculatedStockRow.style.display = 'none';
                
                // Hide feed-specific fields for supplements
                const netWeightGroup = document.querySelector('label[for="productNetWeightPerSack"]')?.parentElement;
                const costPerSackField = document.querySelector('label[for="productCostPerSack"]')?.parentElement;
                
                // Handle both Add Product modal (calculatedStockKilos) and Edit Product modal (editCalculatedStockKilos)
                const calculatedKilosGroup = document.querySelector('#calculatedStockKilos')?.closest('.form-group') || 
                                             document.querySelector('#editCalculatedStockKilos')?.closest('.form-group');
                const calculatedHalfKilosGroup = document.querySelector('#calculatedStockHalfKilos')?.closest('.form-group') || 
                                                 document.querySelector('#editCalculatedStockHalfKilos')?.closest('.form-group');
                
                console.log(' Hiding supplement fields:', {
                    netWeightGroup: !!netWeightGroup,
                    costPerSackField: !!costPerSackField,
                    calculatedKilosGroup: !!calculatedKilosGroup,
                    calculatedHalfKilosGroup: !!calculatedHalfKilosGroup
                });
                
                if (netWeightGroup) netWeightGroup.style.display = 'none';
                if (costPerSackField) costPerSackField.style.display = 'none';
                if (calculatedKilosGroup) calculatedKilosGroup.style.display = 'none';
                if (calculatedHalfKilosGroup) calculatedHalfKilosGroup.style.display = 'none';
                
                // Show supplement fields
                if (supplementPriceGroup) supplementPriceGroup.style.display = 'block';
                if (supplementStockGroup) supplementStockGroup.style.display = 'block';
                if (supplementCostGroup) supplementCostGroup.style.display = 'block';
                
                // Make fields required/not required for supplements
                const netWeightField = document.getElementById('productNetWeightPerSack') || 
                                      document.getElementById('editProductNetWeightPerSack');
                const costPerSackFieldInput = document.getElementById('productCostPerSack');
                
                if (netWeightField) netWeightField.required = false;
                if (costPerSackFieldInput) costPerSackFieldInput.required = false;
                
                const pricePerSackElement = document.getElementById('productPricePerSack') || 
                                           document.getElementById('editProductPricePerSack');
                const pricePerKiloElement = document.getElementById('productPricePerKilo') || 
                                           document.getElementById('editProductPricePerKilo');
                const stockSacksElement = document.getElementById('productStockSacks') || 
                                         document.getElementById('editProductStockSacks');
                const priceElement = document.getElementById('productPrice');
                const stockElement = document.getElementById('productStock') || 
                                    document.getElementById('editProductStock');
                
                if (pricePerSackElement) pricePerSackElement.required = false;
                if (pricePerKiloElement) pricePerKiloElement.required = false;
                if (stockSacksElement) stockSacksElement.required = false;
                if (priceElement) priceElement.required = true;
                if (stockElement) stockElement.required = true;
            } else {
                // Show kilo/sack fields for feeds or default
                console.log('Showing feeds fields for category:', category);
                if (pricePerSackGroup) {
                    pricePerSackGroup.style.display = 'block';
                    console.log(' Showing pricePerSackGroup');
                }
                if (pricePerKiloGroup) {
                    pricePerKiloGroup.style.display = 'block';
                    console.log(' Showing pricePerKiloGroup');
                }
                if (costPerSackGroup) {
                    costPerSackGroup.style.display = 'block';
                    costPerSackGroup.style.visibility = 'visible';
                    costPerSackGroup.style.opacity = '1';
                    console.log(' Showing costPerSackGroup');
                } else {
                    console.log(' costPerSackGroup not found in JavaScript');
                    // Try to find it again
                    const costPerSackElement = document.getElementById('costPerSackGroup');
                    if (costPerSackElement) {
                        costPerSackElement.style.display = 'block';
                        costPerSackElement.style.visibility = 'visible';
                        costPerSackElement.style.opacity = '1';
                        console.log(' Found and showed costPerSackGroup via direct ID lookup');
                    }
                }
                if (costPerSackNewGroup) {
                    costPerSackNewGroup.style.display = 'block';
                    console.log(' Showing costPerSackNewGroup');
                }
                
                // Show feed stock fields row (Stock Sacks + Cost Price Per Sack)
                if (feedStockFieldsRow) {
                    feedStockFieldsRow.style.display = 'flex';
                    console.log(' Showing feedStockFieldsRow');
                }
                
                // Show feed cost price row
                if (feedCostPriceRow) {
                    feedCostPriceRow.style.display = 'flex';
                    console.log(' Showing feedCostPriceRow');
                }
                
                // Show calculated stock row
                if (calculatedStockRow) {
                    calculatedStockRow.style.display = 'flex';
                    console.log(' Showing calculatedStockRow');
                }
                
                // Show feed-specific fields for feeds
                const netWeightGroup = document.querySelector('label[for="productNetWeightPerSack"]')?.parentElement;
                const costPerSackField = document.querySelector('label[for="productCostPerSack"]')?.parentElement;
                
                // Handle both Add Product modal (calculatedStockKilos) and Edit Product modal (editCalculatedStockKilos)
                const calculatedKilosGroup = document.querySelector('#calculatedStockKilos')?.closest('.form-group') || 
                                             document.querySelector('#editCalculatedStockKilos')?.closest('.form-group');
                const calculatedHalfKilosGroup = document.querySelector('#calculatedStockHalfKilos')?.closest('.form-group') || 
                                                 document.querySelector('#editCalculatedStockHalfKilos')?.closest('.form-group');
                
                if (netWeightGroup) netWeightGroup.style.display = 'block';
                if (costPerSackField) costPerSackField.style.display = 'block';
                if (calculatedKilosGroup) calculatedKilosGroup.style.display = 'block';
                if (calculatedHalfKilosGroup) calculatedHalfKilosGroup.style.display = 'block';
                
                // Hide supplement fields
                if (supplementPriceGroup) supplementPriceGroup.style.display = 'none';
                if (supplementStockGroup) supplementStockGroup.style.display = 'none';
                if (supplementCostGroup) supplementCostGroup.style.display = 'none';
                
                // Make fields required for feeds
                const netWeightField = document.getElementById('productNetWeightPerSack') || 
                                      document.getElementById('editProductNetWeightPerSack');
                const costPerSackFieldInput = document.getElementById('productCostPerSack');
                
                if (netWeightField) netWeightField.required = true;
                if (costPerSackFieldInput) costPerSackFieldInput.required = false; // Cost is optional
                
                const pricePerSackElement = document.getElementById('productPricePerSack') || 
                                           document.getElementById('editProductPricePerSack');
                const pricePerKiloElement = document.getElementById('productPricePerKilo') || 
                                           document.getElementById('editProductPricePerKilo');
                const stockSacksElement = document.getElementById('productStockSacks') || 
                                         document.getElementById('editProductStockSacks');
                const priceElement = document.getElementById('productPrice');
                const stockElement = document.getElementById('productStock') || 
                                    document.getElementById('editProductStock');
                
                if (pricePerSackElement) pricePerSackElement.required = true;
                if (pricePerKiloElement) pricePerKiloElement.required = true;
                if (stockSacksElement) stockSacksElement.required = true;
                if (priceElement) priceElement.required = false;
                if (stockElement) stockElement.required = false;
            }
        }

        // Image Compression Function
        function compressImage(file, quality = 0.8, maxWidth = 800, maxHeight = 600) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    // Set canvas dimensions
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('Canvas to Blob conversion failed'));
                        }
                    }, 'image/jpeg', quality);
                };
                
                img.onerror = () => reject(new Error('Image load failed'));
                
                // Use FileReader to create data URL instead of blob URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result; // Use data URL instead of blob URL
                };
                reader.onerror = () => reject(new Error('File read failed'));
                reader.readAsDataURL(file);
            });
        }

        // Global variable to store compressed image
        let compressedImageBlob = null;

        // Image Upload Functions
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select a valid image file', 'error');
                    return;
                }
                
                // Validate file size (2MB limit for base64)
                if (file.size > 2 * 1024 * 1024) {
                    showNotification('Image size must be less than 2MB for optimal performance', 'error');
                    return;
                }
                
                // Compress image before creating preview
                compressImage(file, 0.7, 800, 600).then(compressedFile => {
                    // Store compressed image globally
                    compressedImageBlob = compressedFile;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        const previewImg = document.getElementById('previewImg');
                        
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                        
                        // Hide upload area
                        const uploadArea = document.querySelector('.image-upload-area');
                        uploadArea.style.display = 'none';
                    };
                    reader.readAsDataURL(compressedFile);
                }).catch(error => {
                    console.error('Error compressing image:', error);
                    showNotification('Error processing image', 'error');
                });
            }
        }
        
        function removeImage() {
            const preview = document.getElementById('imagePreview');
            const uploadArea = document.querySelector('.image-upload-area');
            const fileInput = document.getElementById('productImage');
            
            preview.style.display = 'none';
            uploadArea.style.display = 'flex';
            fileInput.value = '';
            
            // Clear compressed image
            compressedImageBlob = null;
        }
        
        // Handle Edit Image Upload
        function handleEditImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select a valid image file', 'error');
                    return;
                }
                
                // Validate file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image size must be less than 5MB', 'error');
                    return;
                }
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imagePreview = document.getElementById('editImagePreview');
                    const uploadPlaceholder = document.getElementById('editUploadPlaceholder');
                    const imageActions = document.getElementById('editImageActions');
                    
                    if (imagePreview) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    }
                    if (uploadPlaceholder) {
                        uploadPlaceholder.style.display = 'none';
                    }
                    if (imageActions) {
                        imageActions.style.display = 'flex';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Convert image to base64 for database storage
        function getImageAsBase64() {
            if (compressedImageBlob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(compressedImageBlob);
                });
            }
            return null;
        }
        
        // Add drag and drop functionality
        function initializeImageUpload() {
            const uploadArea = document.querySelector('.image-upload-area');
            const fileInput = document.getElementById('productImage');
            
            if (uploadArea) {
                // Drag and drop events
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        handleImageUpload({ target: { files: files } });
                    }
                });
            }
        }
        
        // Initialize image upload when modal opens
        function initializeProductModal() {
            initializeImageUpload();
        }

        // Add new product
        function addProduct() {
            console.log('Adding new product');
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            
            // Ensure the form has the correct structure
            restoreProductForm();
            
            // Initialize image upload functionality
            // Initialize immediately
            initializeProductModal();
            
            // Pause QR Scanner
            pauseQRScanner();
            
            const modal = document.getElementById('productModal');
            modal.style.display = 'block';
            
            // Use MutationObserver to watch for when modal becomes visible
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const target = mutation.target;
                        if (target.style.display === 'block') {
                            console.log('Modal is now visible, updating field visibility...');
                            // Update field visibility immediately
                            const category = document.getElementById('productCategory')?.value || '';
                            updateFieldVisibility(category);
                            observer.disconnect(); // Stop observing after first change
                        }
                    }
                });
            });
            
            // Start observing the modal
            observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
            
            // Fallback: also try after a delay
            setTimeout(() => {
                const category = document.getElementById('productCategory')?.value || '';
                updateFieldVisibility(category);
                
                // Force show cost price field regardless of category
                const costPerSackElement = document.getElementById('costPerSackGroup');
                if (costPerSackElement) {
                    costPerSackElement.style.display = 'block';
                    costPerSackElement.style.visibility = 'visible';
                    costPerSackElement.style.opacity = '1';
                    console.log(' Force showing costPerSackGroup in fallback');
                } else {
                    console.log(' costPerSackGroup still not found in fallback');
                }
            }, 500);
            
            // Additional fallback with longer delay
            setTimeout(() => {
                const costPerSackElement = document.getElementById('costPerSackGroup');
                if (costPerSackElement) {
                    costPerSackElement.style.display = 'block';
                    costPerSackElement.style.visibility = 'visible';
                    costPerSackElement.style.opacity = '1';
                    console.log(' Force showing costPerSackGroup in extended fallback');
                } else {
                    console.log(' costPerSackGroup still not found in extended fallback');
                    // Try to find it by searching the entire modal
                    const modal = document.getElementById('productModal');
                    if (modal) {
                        const allFormGroups = modal.querySelectorAll('.form-group');
                        console.log(' Found form groups in modal:', allFormGroups.length);
                        allFormGroups.forEach((group, index) => {
                            console.log(` Form group ${index}:`, {
                                id: group.id,
                                className: group.className,
                                hasCostPriceLabel: !!group.querySelector('label[for="productCostPerSack"]'),
                                innerHTML: group.innerHTML.substring(0, 100) + '...'
                            });
                            if (group.id === 'costPerSackGroup') {
                                group.style.display = 'block';
                                group.style.visibility = 'visible';
                                group.style.opacity = '1';
                                console.log(' Found costPerSackGroup in modal search at index', index);
                            }
                        });
                        
                        // Also try to find by label
                        const costPriceLabel = modal.querySelector('label[for="productCostPerSack"]');
                        if (costPriceLabel) {
                            const parentGroup = costPriceLabel.closest('.form-group');
                            if (parentGroup) {
                                parentGroup.style.display = 'block';
                                parentGroup.style.visibility = 'visible';
                                parentGroup.style.opacity = '1';
                                console.log(' Found cost price field by label search');
                            }
                        }
                    }
                }
            }, 1000);
        }
        
        // Edit product
        function editProduct(id) {
            console.log('Editing product:', id);
            const product = products.find(p => p.id === id);
            if (!product) {
                console.error('Product not found:', id);
                return;
            }
            
            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            
            // Ensure the form has the correct structure
            restoreProductForm();
            
            // Fill form with product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productPricePerSack').value = product.pricePerSack || product.price || 0;
            document.getElementById('productPricePerKilo').value = product.pricePerKilo || product.price || 0;
            document.getElementById('productStockSacks').value = product.stockSacks || product.stock || 0;
            
            // Handle category-specific fields
            handleEditModalCategoryChange(product.category);
            
            // Auto-calculate and display kilo and half-kilo values (only for feeds)
            if (product.category !== 'supplements') {
                const sacks = parseInt(document.getElementById('productStockSacks').value) || 0;
                const netWeight = parseFloat(product.netWeightPerSack) || 25;
                const kilos = sacks * netWeight;
                const halfKilos = sacks * netWeight * 2;
                document.getElementById('calculatedStockKilos').value = kilos;
                document.getElementById('calculatedStockHalfKilos').value = halfKilos;
            }
            
            document.getElementById('productModal').style.display = 'block';
        }
        
        // Delete product
        async function deleteProduct(id) {
            console.log('Deleting product:', id);
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`${API_BASE}/products/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Product deleted successfully!', 'success');
                        await loadProducts(); // Reload products from database
                        renderProducts();
                    } else {
                        showNotification(result.error || 'Failed to delete product', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showNotification('Failed to delete product', 'error');
                }
            }
        }
        
        // Save product (add or edit)
        async function saveProduct(formData) {
            console.log('Saving product, editing ID:', editingProductId);
            console.log('Form data received:', {
                name: formData.get('name'),
                animal: formData.get('animal'),
                category: formData.get('category'),
                pricePerSack: formData.get('pricePerSack'),
                pricePerKilo: formData.get('pricePerKilo'),
                stockSacks: formData.get('stockSacks'),
                stock: formData.get('stock'),
                price: formData.get('price'),
                cost: formData.get('cost')
            });
            
            // Check if this is just an empty form (modal opening)
            if (!formData.get('name') && !formData.get('animal') && !formData.get('category')) {
                console.log('Empty form detected, skipping validation');
                return;
            }
            
            const category = formData.get('category');
            const productData = {
                name: formData.get('name'),
                description: formData.get('description') || 'No description provided',
                animal: formData.get('animal'),
                category: category
            };
            
            // Handle different categories
            if (category === 'supplements') {
                // For supplements, use simple price and stock
                productData.price = parseFloat(formData.get('price')) || 0;
                productData.cost = parseFloat(formData.get('cost')) || 0;
                // Get stock from the supplement field (name="stock") and store in stockSacks
                const supplementStock = parseInt(formData.get('stock')) || 0;
                console.log(' Supplement stock processing:', {
                    rawStock: formData.get('stock'),
                    parsedStock: supplementStock,
                    category: category
                });
                productData.stockSacks = supplementStock;
                productData.unit = 'units';
                // Set legacy stock field to match stockSacks for backward compatibility
                productData.stock = supplementStock;
                // Set kilo/sack fields to 0 for supplements
                productData.pricePerSack = 0;
                productData.pricePerKilo = 0;
                productData.costPerSack = 0;
                productData.costPerKilo = 0;
                productData.stockKilos = 0;
            } else {
                // For feeds, use kilo/sack pricing
                productData.pricePerSack = parseFloat(formData.get('pricePerSack')) || 0;
                productData.pricePerKilo = parseFloat(formData.get('pricePerKilo')) || 0;
                productData.costPerSack = parseFloat(formData.get('costPerSack')) || 0;
                productData.stockSacks = parseInt(formData.get('stockSacks')) || 0;
                productData.netWeightPerSack = parseFloat(formData.get('netWeightPerSack')) || 25;
                // Auto-calculate kilo and half-kilo from sacks using net weight
                productData.stockKilos = productData.stockSacks * productData.netWeightPerSack;
                productData.stockHalfKilos = productData.stockSacks * productData.netWeightPerSack * 2;
                // Legacy fields for backward compatibility
                productData.price = productData.pricePerSack; // Default to sack price
                productData.cost = productData.costPerSack; // Default to sack cost
                productData.stock = productData.stockSacks; // Default to sack stock
                productData.unit = 'sack'; // Default unit
            }
            
            // Basic validation
            if (!productData.name || productData.name.trim() === '') {
                showNotification('Product name is required', 'error');
                return;
            }
            
            if (!productData.animal) {
                showNotification('Please select an animal type', 'error');
                return;
            }
            
            if (!productData.category) {
                showNotification('Please select a category', 'error');
                return;
            }
            
            // Validate fields based on category
            if (category === 'supplements') {
                // For supplements, validate simple price and stock
                if (isNaN(productData.price) || productData.price <= 0) {
                    showNotification('Please enter a valid price', 'error');
                    return;
                }
                
                if (isNaN(productData.stock) || productData.stock < 0) {
                    showNotification('Please enter a valid stock quantity', 'error');
                    return;
                }
            } else {
                // For feeds, validate kilo/sack fields
                if (isNaN(productData.pricePerSack) || productData.pricePerSack <= 0) {
                    showNotification('Please enter a valid price per sack', 'error');
                    return;
                }
                
                if (isNaN(productData.pricePerKilo) || productData.pricePerKilo <= 0) {
                    showNotification('Please enter a valid price per kilo', 'error');
                    return;
                }
                
                if (isNaN(productData.stockSacks) || productData.stockSacks < 0) {
                    showNotification('Please enter a valid stock quantity for sacks', 'error');
                    return;
                }
                
                // Kilo stock is optional - no validation required
            }
            
            // Handle image upload
            try {
                const imageBase64 = await getImageAsBase64();
                if (imageBase64) {
                    productData.imageUrl = imageBase64;
                    console.log(' Image uploaded and converted to base64');
                    console.log(' Base64 length:', imageBase64.length);
                    console.log(' Base64 first 50 chars:', imageBase64.substring(0, 50));
                } else {
                    console.log(' No image uploaded');
                }
            } catch (error) {
                console.error('Error processing image:', error);
                showNotification('Error processing image', 'error');
                return;
            }
            
            console.log('Product data:', productData);
            
            try {
                console.log('Sending product data to API:', productData);
                let response;
                
                if (editingProductId) {
                    // Edit existing product - use _id if available, otherwise use id
                    const productId = editingProductId;
                    console.log('Editing existing product with ID:', productId);
                    
                    response = await fetch(`${API_BASE}/products/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(productData)
                    });
                } else {
                    // Add new product
                    console.log('Creating new product');
                    
                    response = await fetch(`${API_BASE}/products`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(productData)
                    });
                }
                
                console.log('API response status:', response.status);
                console.log('API response ok:', response.ok);
                
                const result = await response.json();
                console.log(' API response:', result);
                
                if (result.success) {
                    console.log(' Product created/updated successfully');
                    if (result.product && result.product.imageUrl) {
                        console.log(' Product has imageUrl:', result.product.imageUrl.substring(0, 50));
                    } else {
                        console.log(' Product does not have imageUrl in response');
                    }
                    showNotification(result.message, 'success');
                    await loadProducts(); // Reload products from database
                    renderProducts();
                    // Small delay to ensure UI updates before closing modal
                    setTimeout(() => {
                        closeModal();
                    }, 500);
                } else {
                    showNotification(result.error || 'Failed to save product', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Failed to save product', 'error');
            }
        }
        
        // Close modal
        function closeModal() {
            console.log('Closing modal');
            const modal = document.getElementById('productModal');
            if (modal) {
                modal.style.display = 'none';
                editingProductId = null;
                
                // Restore original product form
                restoreProductForm();
                
                // Resume QR Scanner
                resumeQRScanner();
                
                console.log('Modal closed successfully');
            } else {
                console.error('Modal element not found');
            }
        }
        
        // Pause QR Scanner
        function pauseQRScanner() {
            const qrScanner = document.querySelector('.qr-scanner-inline');
            const adminQrInput = document.getElementById('adminQrInput');
            const scanBtn = document.querySelector('.qr-scanner-inline .btn-primary');
            const scannerStatus = document.getElementById('adminScannerStatus');
            
            if (qrScanner) {
                qrScanner.style.opacity = '0.5';
                qrScanner.style.pointerEvents = 'none';
            }
            if (adminQrInput) {
                adminQrInput.disabled = true;
            }
            if (scanBtn) {
                scanBtn.disabled = true;
            }
            if (scannerStatus) {
                scannerStatus.textContent = 'Scanner paused (modal open)';
            }
        }
        
        // Resume QR Scanner
        function resumeQRScanner() {
            const qrScanner = document.querySelector('.qr-scanner-inline');
            const adminQrInput = document.getElementById('adminQrInput');
            const scanBtn = document.querySelector('.qr-scanner-inline .btn-primary');
            const scannerStatus = document.getElementById('adminScannerStatus');
            
            if (qrScanner) {
                qrScanner.style.opacity = '1';
                qrScanner.style.pointerEvents = 'auto';
            }
            if (adminQrInput) {
                adminQrInput.disabled = false;
            }
            if (scanBtn) {
                scanBtn.disabled = false;
            }
            if (scannerStatus) {
                scannerStatus.textContent = 'Ready to scan';
            }
        }
        
        // Restore original product form
        function restoreProductForm() {
            document.getElementById('modalTitle').textContent = 'Add New Product';
            
            const originalFormHTML = `
                <!-- Basic Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3> Basic Information</h3>
                    </div>
                <div class="form-group">
                        <label for="productName" class="form-label">
                            Product Name <span class="required">*</span>
                        </label>
                        <input type="text" id="productName" name="name" class="form-input" placeholder="Enter product name" required>
                        <div class="form-help">Choose a descriptive name for your product</div>
                </div>
                
                <div class="form-group">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea id="productDescription" name="description" class="form-textarea" rows="3" placeholder="Enter product description (optional)"></textarea>
                        <div class="form-help">Provide additional details about the product</div>
                    </div>
                </div>
                
                <!-- Product Image Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3> Product Image</h3>
                    </div>
                <div class="form-group">
                        <label for="productImage" class="form-label">Product Image</label>
                        <div class="image-upload-container">
                            <input type="file" id="productImage" name="image" class="image-upload-input" accept="image/*" onchange="handleImageUpload(event)">
                            <div class="image-upload-area" onclick="document.getElementById('productImage').click()">
                                <div class="image-upload-content">
                                    <div class="image-upload-icon"></div>
                                    <div class="image-upload-text">
                                        <div class="upload-title">Click to upload image</div>
                                        <div class="upload-subtitle">or drag and drop</div>
                                        <div class="upload-formats">PNG, JPG, JPEG up to 10MB</div>
                                    </div>
                                </div>
                            </div>
                            <div id="imagePreview" class="image-preview" style="display: none;">
                                <img id="previewImg" src="" alt="Preview" class="preview-image">
                                <button type="button" class="remove-image-btn" onclick="removeImage()"></button>
                            </div>
                        </div>
                        <div class="form-help">Upload a clear image of the product. Images are stored in the database for persistence.</div>
                    </div>
                </div>

                <!-- Category & Classification Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3> Category & Classification</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productAnimal" class="form-label">
                                Animal Type <span class="required">*</span>
                            </label>
                            <select id="productAnimal" name="animal" class="form-select" required>
                                <option value="">Select Animal Type</option>
                        <option value="chicken"> Chicken</option>
                        <option value="pig"> Pig</option>
                    </select>
                </div>
                <div class="form-group">
                            <label for="productCategory" class="form-label">
                                Product Category <span class="required">*</span>
                            </label>
                            <select id="productCategory" name="category" class="form-select" required>
                        <option value="">Select Category</option>
                        <option value="feeds"> Feeds</option>
                        <option value="supplements"> Supplements</option>
                    </select>
                        </div>
                    </div>
                </div>
                
                <!-- Pricing Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3> Pricing Information</h3>
                    </div>
                <div class="form-row">
                    <div class="form-group">
                            <label for="productPricePerSack" class="form-label">
                                Selling Price per Sack () <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="productPricePerSack" name="pricePerSack" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                        </div>
                    <div class="form-group">
                            <label for="productPricePerKilo" class="form-label">
                                Selling Price per Kilo () <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="productPricePerKilo" name="pricePerKilo" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                    </div>
                </div>
                
                <!-- Supplement Price Field (hidden by default) -->
                <div class="form-group" id="supplementPriceGroup" style="display: none;">
                        <label for="productPrice" class="form-label">
                            Selling Price () <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-prefix"></span>
                            <input type="number" id="productPrice" name="price" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                </div>
                
                    <!-- Supplement Cost Price Field (hidden by default) -->
                    <div class="form-group" id="supplementCostGroup" style="display: none;">
                        <label for="productCost" class="form-label">
                            Cost Price ()
                        </label>
                        <div class="input-group">
                            <span class="input-prefix"></span>
                            <input type="number" id="productCost" name="cost" class="form-input" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Stock Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3> Stock Information</h3>
                    </div>
        
        <!-- Feed Stock Fields Row (Stock Sacks + Net Weight) -->
        <div class="form-row" id="feedStockFieldsRow">
            <div class="form-group">
                            <label for="productStockSacks" class="form-label">
                                Stock (Sacks) <span class="required">*</span>
                            </label>
                            <input type="number" id="productStockSacks" name="stockSacks" class="form-input" min="0" placeholder="0" required>
                            <div class="form-help">Enter the number of sacks in stock</div>
            </div>
            <div class="form-group">
                            <label for="productNetWeightPerSack" class="form-label">
                                Net Weight per Sack (kg) <span class="required">*</span>
                            </label>
                            <input type="number" id="productNetWeightPerSack" name="netWeightPerSack" class="form-input" min="0" step="0.1" value="25" placeholder="25" required>
                            <div class="form-help">Enter the actual weight of each sack (e.g., 25kg, 50kg)</div>
            </div>
        </div>
        
        <!-- Cost Price Per Sack Row -->
        <div class="form-row" id="feedCostPriceRow">
            <div class="form-group">
                            <label for="productCostPerSack" class="form-label">
                                Cost Price per Sack ()
                            </label>
                            <div class="input-group">
                                <span class="input-prefix"></span>
                                <input type="number" id="productCostPerSack" name="costPerSack" class="form-input" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-help">Enter the cost price you paid when buying this product</div>
            </div>
            <div class="form-group">
                            <!-- Empty for layout balance -->
            </div>
        </div>
        
        <!-- Auto-calculated stock display (read-only) -->
        <div class="form-row" id="calculatedStockRow">
            <div class="form-group">
                            <label class="form-label">Calculated Stock (Kilos)</label>
                            <input type="number" id="calculatedStockKilos" class="form-input calculated-field" readonly placeholder="Auto-calculated">
            </div>
            <div class="form-group">
                            <label class="form-label">Calculated Stock (Half Kilos)</label>
                            <input type="number" id="calculatedStockHalfKilos" class="form-input calculated-field" readonly placeholder="Auto-calculated">
            </div>
        </div>
                
                <!-- Supplement Stock Field (hidden by default) -->
                <div class="form-group" id="supplementStockGroup" style="display: none;">
                        <label for="productStock" class="form-label">
                            Stock (Units) <span class="required">*</span>
                        </label>
                        <input type="number" id="productStock" name="stock" class="form-input" min="0" placeholder="0" required>
                </div>
                </div>
            `;
            
            document.getElementById('productForm').innerHTML = originalFormHTML;
            
            // Initialize image upload functionality
            // Initialize immediately
            initializeImageUpload();
            
            // Re-add event listeners for the restored form
            setupProductFormEvents();
            
            // Re-setup category change event listener
            setupCategoryChangeListener();
        }
        
        // Setup category change listener
        function setupCategoryChangeListener() {
            const productCategory = document.getElementById('productCategory');
            
            if (productCategory) {
                // Remove any existing event listeners by cloning the element
                const newCategory = productCategory.cloneNode(true);
                productCategory.parentNode.replaceChild(newCategory, productCategory);
                
                // Add a single event listener
                newCategory.addEventListener('change', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const category = this.value;
                    console.log('Category changed to:', category);
                    
                    // Update field visibility immediately
                    updateFieldVisibility(category);
                }, { once: false, passive: false });
            }
        }

        // Setup product form events
        function setupProductFormEvents() {
            // Product form submission
            const productForm = document.getElementById('productForm');
            if (productForm) {
                // Remove any existing event listeners to prevent duplicates
                const newForm = productForm.cloneNode(true);
                productForm.parentNode.replaceChild(newForm, productForm);
                
                // Add the event listener to the new form
                newForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('Form submitted, preventing default page reload');
                    const formData = new FormData(e.target);
                    saveProduct(formData);
                });
            }
            
            // Category selection change is now handled in setupCategoryChangeListener()
            
            // Auto-calculation for stock sacks (add product modal)
            const stockSacksInput = document.getElementById('productStockSacks');
            const netWeightInput = document.getElementById('productNetWeightPerSack');
            
            function updateCalculatedStock() {
                const sacks = parseInt(stockSacksInput.value) || 0;
                const netWeight = parseFloat(netWeightInput.value) || 25;
                const kilos = sacks * netWeight;
                const halfKilos = sacks * netWeight * 2;
                
                // Update calculated display fields
                const calculatedKilos = document.getElementById('calculatedStockKilos');
                const calculatedHalfKilos = document.getElementById('calculatedStockHalfKilos');
                
                if (calculatedKilos) calculatedKilos.value = kilos;
                if (calculatedHalfKilos) calculatedHalfKilos.value = halfKilos;
            }
            
            if (stockSacksInput) {
                stockSacksInput.addEventListener('input', updateCalculatedStock);
            }
            
            if (netWeightInput) {
                netWeightInput.addEventListener('input', updateCalculatedStock);
            }
            
            // Auto-calculation for stock sacks (edit product modal)
            const editStockSacksInput = document.getElementById('editProductStockSacks');
            const editNetWeightInput = document.getElementById('editProductNetWeightPerSack');
            
            function updateEditCalculatedStock() {
                const sacks = parseInt(editStockSacksInput.value) || 0;
                const netWeight = parseFloat(editNetWeightInput.value) || 25;
                const kilos = sacks * netWeight;
                const halfKilos = sacks * netWeight * 2;
                
                // Update calculated display fields in edit modal
                const editCalculatedKilos = document.getElementById('editCalculatedStockKilos');
                const editCalculatedHalfKilos = document.getElementById('editCalculatedStockHalfKilos');
                
                if (editCalculatedKilos) editCalculatedKilos.value = kilos;
                if (editCalculatedHalfKilos) editCalculatedHalfKilos.value = halfKilos;
            }
            
            if (editStockSacksInput) {
                editStockSacksInput.addEventListener('input', updateEditCalculatedStock);
            }
            
            if (editNetWeightInput) {
                editNetWeightInput.addEventListener('input', updateEditCalculatedStock);
            }
            
            // Cancel button
            const cancelBtn = document.getElementById('cancelProduct');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }
            
        }

        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            // Add icon based on type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '';
                    break;
                case 'error':
                    icon = '';
                    break;
                case 'warning':
                    icon = '';
                    break;
                default:
                    icon = '';
            }
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1001;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid rgba(255,255,255,0.3);
            `;
            
            document.body.appendChild(notification);
            
            // Remove after longer duration for error messages
            const duration = type === 'error' ? 7000 : 5000;
            setTimeout(() => {
                notification.remove();
            }, duration);
        }
        
        // Generate Real QR Code
        function generateQRCode(text, canvas) {
            // Clear canvas first
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Generate real QR code using qrcode.js library
            QRCode.toCanvas(canvas, text, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function (error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    // Fallback: show error message
                    ctx.fillStyle = '#f8d7da';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#721c24';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('QR Code Error', canvas.width/2, canvas.height/2 - 10);
                    ctx.fillText('Please try again', canvas.width/2, canvas.height/2 + 10);
                } else {
                    console.log('QR Code generated successfully');
                }
            });
        }
        
        // Generate QR Code
        async function generateQRCode(productId) {
            console.log('Generating QR code for product:', productId);
            const product = products.find(p => p.id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                return;
            }
            
            try {
                // Get authentication token
                const token = localStorage.getItem('token');
                if (!token) {
                    showNotification('Please log in to generate QR codes', 'error');
                    return;
                }
                
                // Generate QR code via API - use the original _id
                const response = await fetch(`${API_BASE}/sales/qr/${product._id || productId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const qrData = await response.json();
                
                if (response.ok) {
                    // Update modal content
                    document.getElementById('qrProductName').textContent = product.name;
                    document.getElementById('qrProductDetails').textContent = 
                        `${product.category === 'chicken' ? 'Chicken Feeds' : 'Pig Feeds'}  Sack: ${(product.pricePerSack || product.price || 0).toFixed(2)}  Kilo: ${(product.pricePerKilo || product.price || 0).toFixed(2)}`;
                    
                    // Display QR code image
                    const qrCodeImg = document.getElementById('qrCodeImage');
                    if (qrCodeImg) {
                        qrCodeImg.src = qrData.qrCode;
                        qrCodeImg.style.display = 'block';
                    }
                    
                    // Display the URL
                    document.getElementById('qrUrl').textContent = qrData.qrUrl;
                    
                    // Display the Product ID
                    document.getElementById('productIdValue').textContent = product._id || productId;
                    
                    // Show modal
                    document.getElementById('qrModal').style.display = 'block';
                } else {
                    showNotification('Failed to generate QR code', 'error');
                }
            } catch (error) {
                console.error('Error generating QR code:', error);
                showNotification('Error generating QR code', 'error');
            }
        }
        
        // Enhanced Print Receipt Function
        async function printReceipt(saleData) {
            try {
                console.log(' Starting receipt print process...');
                console.log(' Sale data:', saleData);
                
                // Create receipt content for 57mm thermal printer
                const receiptContent = `
                    <div id="receipt" style="
                        width: 57mm;
                        font-family: 'Courier New', monospace;
                        font-size: 12px;
                        line-height: 1.2;
                        padding: 5mm;
                        background: white;
                        color: black;
                    ">
                        <div style="text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 10px; color: black;">
                            ZYMOUNE FEEDS SUPPLY
                        </div>
                        <div style="text-align: center; font-size: 10px; margin-bottom: 15px; color: black;">
                            Premium Chicken & Pig Feeds & Supplements
                        </div>
                        <div style="border-top: 1px dashed #000; padding-top: 5px; margin-bottom: 10px;"></div>
                        
                        <div style="margin-bottom: 8px; color: black; font-size: 10px;">
                            <strong>Receipt #:</strong> ${Date.now().toString().slice(-8)}
                        </div>
                        <div style="margin-bottom: 8px; color: black; font-size: 10px;">
                            <strong>Date:</strong> ${saleData.timestamp.toLocaleDateString()}
                        </div>
                        <div style="margin-bottom: 8px; color: black; font-size: 10px;">
                            <strong>Time:</strong> ${saleData.timestamp.toLocaleTimeString()}
                        </div>
                        
                        <div style="border-top: 1px dashed #000; padding-top: 5px; margin: 10px 0;"></div>
                        
                        <div style="margin-bottom: 5px; color: black; font-size: 10px;">
                            <strong>Product:</strong> ${saleData.productName}
                        </div>
                        <div style="margin-bottom: 5px; color: black; font-size: 10px;">
                            <strong>Quantity:</strong> ${saleData.quantity} ${saleData.unit}
                        </div>
                        <div style="margin-bottom: 5px; color: black; font-size: 10px;">
                            <strong>Unit Price:</strong> ${saleData.unitPrice.toFixed(2)}
                        </div>
                        
                        <div style="border-top: 1px dashed #000; padding-top: 5px; margin: 10px 0;"></div>
                        
                        <div style="text-align: right; font-size: 12px; font-weight: bold; margin: 10px 0; color: black;">
                            TOTAL: ${saleData.total.toFixed(2)}
                        </div>
                        
                        <div style="border-top: 1px dashed #000; padding-top: 5px; margin: 10px 0;"></div>
                        
                        <div style="text-align: center; font-size: 10px; margin-top: 15px; color: black;">
                            Thank you for your purchase!
                        </div>
                        <div style="text-align: center; font-size: 10px; margin-top: 5px; color: black;">
                            Visit us again soon!
                        </div>
                    </div>
                `;
                
                // Check if popup is blocked
                const printWindow = window.open('', '_blank', 'width=300,height=600,scrollbars=yes,resizable=yes');
                
                if (!printWindow || printWindow.closed || typeof printWindow.closed == 'undefined') {
                    showNotification('Popup blocked! Please allow popups for this site to print receipts.', 'error');
                    return;
                }
                
                // Write content to print window
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <title>Receipt</title>
                            <meta charset="UTF-8">
                            <style>
                                * {
                                    margin: 0;
                                    padding: 0;
                                    box-sizing: border-box;
                                }
                                body { 
                                    margin: 0; 
                                    padding: 0; 
                                    width: 57mm;
                                    height: auto;
                                    overflow: hidden;
                                    background: white;
                                    font-family: 'Courier New', monospace;
                                }
                                #receipt { 
                                    width: 57mm;
                                    height: auto;
                                    margin: 0;
                                    padding: 2mm;
                                    background: white;
                                    display: block;
                                }
                                @media print {
                                    body { 
                                        margin: 0; 
                                        padding: 0; 
                                        width: 57mm;
                                        height: auto;
                                        overflow: hidden;
                                        background: white;
                                    }
                                    #receipt { 
                                        width: 57mm !important;
                                        height: auto !important;
                                        margin: 0 !important;
                                        padding: 2mm !important;
                                        background: white !important;
                                        page-break-after: always;
                                        page-break-inside: avoid;
                                    }
                                    @page {
                                        size: 57mm auto;
                                        margin: 0;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            ${receiptContent}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Wait for content to load, then print
                setTimeout(() => {
                    try {
                        // Focus the window
                        printWindow.focus();
                        
                        // Trigger print dialog
                        printWindow.print();
                        
                        // Close window after printing (with delay to allow print dialog to appear)
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 3000);
                        
                        console.log(' Print dialog triggered successfully');
                        showNotification('Receipt sent to printer!', 'success');
                        
                    } catch (printError) {
                        console.error(' Error triggering print:', printError);
                        showNotification('Print dialog failed. The receipt window is open - please press Ctrl+P to print manually.', 'error');
                    }
                }, 1000); // Increased timeout
                
                console.log(' Receipt print window opened');
                
            } catch (error) {
                console.error(' Critical error in printReceipt:', error);
                showNotification(`Receipt printing failed: ${error.message}`, 'error');
            }
        }
        
        // Test Print Function (for debugging)
        function testPrint() {
            console.log(' Testing print functionality...');
            
            const testData = {
                productName: 'Test Chicken Feed',
                quantity: 2,
                unit: 'sack',
                unitPrice: 150.00,
                total: 300.00,
                customerName: 'Test Customer',
                customerPhone: '123-456-7890',
                customerEmail: 'test@example.com',
                timestamp: new Date()
            };
            
            console.log(' Test data created:', testData);
            printReceipt(testData);
        }
        
        // Printer Diagnostics Function
        function diagnosePrinter() {
            console.log(' Running printer diagnostics...');
            
            // Check browser support
            const browserInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine
            };
            
            console.log(' Browser Info:', browserInfo);
            
            // Test popup blocking
            try {
                const testWindow = window.open('', '_blank', 'width=100,height=100');
                if (testWindow) {
                    console.log(' Popup blocking: OK');
                    testWindow.close();
                } else {
                    console.log(' Popup blocking: BLOCKED');
                }
            } catch (e) {
                console.log(' Popup blocking: ERROR -', e.message);
            }
            
            // Test print function availability
            if (typeof window.print === 'function') {
                console.log(' Print function: Available');
            } else {
                console.log(' Print function: Not available');
            }
            
            showNotification('Printer diagnostics completed. Check console for results.', 'info');
        }

        // Show Product Purchase Modal (for QR scanning)
        function showProductPurchaseModal(productId) {
            console.log('showProductPurchaseModal called with productId:', productId);
            console.log('Available products:', products.map(p => ({id: p.id, name: p.name})));
            
            const product = products.find(p => p.id == productId);
            if (!product) {
                console.error('Product not found for ID:', productId);
                showNotification('Product not found', 'error');
                return;
            }
            
            console.log('Found product:', product);
            
            // Close any open modals first
            closeQRModal();
            // Don't call closeModal() here as it will interfere with the purchase modal
            
            // Small delay to ensure modals are closed
            setTimeout(() => {
                // Update the existing product modal to show purchase form
                document.getElementById('modalTitle').textContent = ` Purchase ${product.name}`;
            
            // Create purchase form content
            const purchaseFormHTML = `
                <div class="product-purchase-info">
                    <div class="product-details">
                        <h3>${product.name}</h3>
                        <p class="product-description">${product.description}</p>
                        <div class="product-meta">
                            <span class="product-category">${product.category === 'chicken' ? ' Chicken' : ' Pig'} - ${product.category}</span>
                            <div class="product-pricing">
                                <span class="price-option">Sack: ${(product.pricePerSack || product.price || 0).toFixed(2)}</span>
                                <span class="price-option">Kilo: ${(product.pricePerKilo || product.price || 0).toFixed(2)}</span>
                            </div>
                            <div class="product-stock">
                                <span class="stock-option">Sacks: ${product.stockSacks || product.stock || 0}</span>
                                <span class="stock-option">Kilos: ${product.stockKilos || product.stock || 0}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="purchase-options">
                        <h4>Choose Purchase Option:</h4>
                        <div class="option-buttons">
                            <button class="purchase-option-btn" data-unit="sack" data-price="${product.pricePerSack || product.price || 0}">
                                 Buy by Sack - ${(product.pricePerSack || product.price || 0).toFixed(2)}
                            </button>
                            <button class="purchase-option-btn" data-unit="kilo" data-price="${product.pricePerKilo || product.price || 0}">
                                 Buy by Kilo - ${(product.pricePerKilo || product.price || 0).toFixed(2)}
                            </button>
                            <button class="purchase-option-btn" data-unit="half-kilo" data-price="${((product.pricePerKilo || product.price || 0) / 2).toFixed(2)}">
                                 Buy Half Kilo - ${((product.pricePerKilo || product.price || 0) / 2).toFixed(2)}
                            </button>
                        </div>
                    </div>
                    
                    <div class="quantity-section" id="purchaseQuantitySection" style="display: none;">
                        <h4>Quantity:</h4>
                        <input type="number" id="purchaseQuantity" class="quantity-input" min="1" value="1">
                        <div class="total-price" id="purchaseTotal">Total: 0.00</div>
                    </div>
                    
                    <div class="customer-info" id="purchaseCustomerInfo" style="display: none;">
                        <h4>Customer Information:</h4>
                        <div class="form-group">
                            <label for="purchaseCustomerName">Name:</label>
                            <input type="text" id="purchaseCustomerName" placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label for="purchaseCustomerPhone">Phone:</label>
                            <input type="tel" id="purchaseCustomerPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label for="purchaseCustomerEmail">Email (Optional):</label>
                            <input type="email" id="purchaseCustomerEmail" placeholder="Enter email">
                        </div>
                    </div>
                    
                    <div class="purchase-actions" id="purchaseActions" style="display: none;">
                        <button class="btn btn-primary" id="confirmPurchaseBtn">
                             Confirm Purchase
                        </button>
                        <button class="btn btn-secondary" id="cancelPurchaseBtn">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Replace the form content
            const form = document.getElementById('productForm');
            console.log('Form element found:', form);
            if (form) {
                form.innerHTML = purchaseFormHTML;
                console.log('Form content updated');
            } else {
                console.error('Form element not found!');
            }
            
                // Show the modal
                const modal = document.getElementById('productModal');
                console.log('Modal element found:', modal);
                if (modal) {
                    modal.style.display = 'block';
                    modal.style.visibility = 'visible';
                    modal.style.opacity = '1';
                    modal.style.zIndex = '1000';
                    console.log('Modal should now be visible');
                    console.log('Modal computed style:', window.getComputedStyle(modal).display);
                } else {
                    console.error('Modal element not found!');
                }
                
                // Add event listeners for purchase options
                // Setup events immediately
                setupPurchaseModalEvents(product);
            }, 100); // Close the outer setTimeout
        }
        
        // Setup purchase modal events
        function setupPurchaseModalEvents(product) {
            let selectedUnit = '';
            let unitPrice = 0;
            
            // Purchase option buttons
            document.querySelectorAll('.purchase-option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.purchase-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    selectedUnit = btn.getAttribute('data-unit');
                    unitPrice = parseFloat(btn.getAttribute('data-price'));
                    
                    document.getElementById('purchaseQuantitySection').style.display = 'block';
                    document.getElementById('purchaseCustomerInfo').style.display = 'block';
                    document.getElementById('purchaseActions').style.display = 'block';
                    
                    // Set quantity limits based on unit
                    const quantityInput = document.getElementById('purchaseQuantity');
                    if (selectedUnit === 'sack') {
                        // For sacks, limit to available stock
                        const availableSacks = product.stockSacks || product.stock || 0;
                        quantityInput.max = availableSacks;
                        quantityInput.placeholder = `Max: ${availableSacks} sacks`;
                    } else {
                        // For kilo and half-kilo, no limit
                        quantityInput.max = 9999;
                        quantityInput.placeholder = 'Enter quantity';
                    }
                    
                    updatePurchaseTotal();
                });
            });
            
            // Quantity input
            const quantityInput = document.getElementById('purchaseQuantity');
            if (quantityInput) {
                quantityInput.addEventListener('input', updatePurchaseTotal);
            }
            
            function updatePurchaseTotal() {
                const quantity = parseInt(quantityInput.value) || 0;
                const total = quantity * unitPrice;
                document.getElementById('purchaseTotal').textContent = `Total: ${total.toFixed(2)}`;
            }
            
            // Confirm purchase button
            const confirmBtn = document.getElementById('confirmPurchaseBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    const quantity = parseInt(quantityInput.value);
                    const customerName = document.getElementById('purchaseCustomerName').value;
                    const customerPhone = document.getElementById('purchaseCustomerPhone').value;
                    const customerEmail = document.getElementById('purchaseCustomerEmail').value;
                    
                    if (!customerName || !customerPhone) {
                        showNotification('Please fill in customer name and phone number', 'error');
                        return;
                    }
                    
                    if (quantity <= 0) {
                        showNotification('Please enter a valid quantity', 'error');
                        return;
                    }
                    
                    // Stock validation - only check stock for sacks
                    if (selectedUnit === 'sack') {
                        const availableSacks = product.stockSacks || product.stock || 0;
                        if (availableSacks <= 0) {
                            showNotification('This product is out of stock (sacks)', 'error');
                            return;
                        }
                        if (quantity > availableSacks) {
                            showNotification(`Cannot purchase ${quantity} sacks. Only ${availableSacks} sacks available in stock`, 'error');
                            return;
                        }
                    }
                    // For kilo and half-kilo, no stock validation needed
                    
                    try {
                        const saleData = {
                            productId: product.id,
                            quantity: quantity,
                            unit: selectedUnit,
                            pricePerUnit: unitPrice,
                            customerInfo: {
                                name: customerName,
                                phone: customerPhone,
                                email: customerEmail
                            }
                        };
                        
                        console.log('Recording sale with data:', saleData);
                        
                        // Use the same order system as staff dashboard
                        const orderData = {
                            customerName: customerName || 'Customer',
                            customerPhone: customerPhone || '',
                            customerEmail: customerEmail || null,
                            items: [{
                                productId: product.id,
                                productName: product.name,
                                quantity: quantity,
                                unit: selectedUnit,
                                price: unitPrice
                            }],
                            subtotal: quantity * unitPrice,
                            tax: (quantity * unitPrice) * 0.12,
                            total: (quantity * unitPrice) * 1.12,
                            staffId: user._id,
                            staffName: `${user.firstName} ${user.lastName}`
                        };
                        
                        const response = await fetch(`${API_BASE}/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(orderData)
                        });
                        
                        console.log('Sale API response status:', response.status);
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showNotification('Purchase recorded successfully!', 'success');
                            
                            // Print receipt
                            await printReceipt({
                                productName: product.name,
                                quantity: quantity,
                                unit: selectedUnit,
                                unitPrice: unitPrice,
                                total: quantity * unitPrice,
                                customerName: customerName,
                                customerPhone: customerPhone,
                                customerEmail: customerEmail,
                                timestamp: new Date()
                            });
                            
                            closeModal();
                            // Reload products from database to get updated stock
                            await loadProducts();
                            renderProducts();
                        } else {
                            showNotification(result.error || 'Purchase failed', 'error');
                        }
                    } catch (error) {
                        showNotification('Network error. Please try again.', 'error');
                    }
                });
            }
        }
        
        // Close QR Modal
        function closeQRModal() {
            console.log('Closing QR modal');
            document.getElementById('qrModal').style.display = 'none';
        }
        
        // Global function to trigger purchase modal (for QR scanning)
        window.triggerPurchaseModal = function(productId) {
            showProductPurchaseModal(productId);
        };
        
        // Test QR communication system
        function testQRCommunication() {
            console.log('Testing QR communication system...');
            
            // Test 1: Direct function call
            console.log('Test 1: Direct function call');
            showProductPurchaseModal(1);
            
            // Test 2: Local storage trigger
            console.log('Test 2: Local storage trigger');
            setTimeout(() => {
                localStorage.setItem('qrTriggerProduct', JSON.stringify({id: 2, name: 'Test Product'}));
                localStorage.setItem('qrTriggerTime', Date.now().toString());
            }, 1000);
            
            // Test 3: Broadcast channel
            console.log('Test 3: Broadcast channel');
            setTimeout(() => {
                try {
                    const channel = new BroadcastChannel('feeds-store-qr');
                    channel.postMessage({
                        type: 'TRIGGER_PURCHASE_MODAL',
                        productId: 3,
                        timestamp: Date.now()
                    });
                    channel.close();
                } catch (e) {
                    console.log('Broadcast channel test failed:', e);
                }
            }, 2000);
            
            // Test 4: Server trigger
            console.log('Test 4: Server trigger');
            setTimeout(() => {
                fetch(`${API_BASE}/qr/trigger-modal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: 4,
                        timestamp: Date.now()
                    })
                }).then(response => response.json())
                .then(data => console.log('Server trigger response:', data))
                .catch(error => console.error('Server trigger error:', error));
            }, 3000);
            
            showNotification('QR communication test started - check console for results', 'info');
        }
        
        // QR Code Communication System
        function initQRCommunication() {
            console.log('Initializing QR communication system...');
            
            // Listen for localStorage changes (same browser)
            window.addEventListener('storage', (e) => {
                console.log('Storage event detected:', e.key, e.newValue);
                if (e.key === 'qrTriggerProduct') {
                    try {
                        const productData = JSON.parse(e.newValue);
                        if (productData && productData.id) {
                            console.log('Triggering modal for product:', productData.id);
                            showProductPurchaseModal(productData.id);
                            showNotification('QR Code scanned! Opening purchase modal...', 'success');
                        }
                    } catch (error) {
                        console.error('Error parsing QR trigger data:', error);
                    }
                }
            });
            
            // Listen for Broadcast Channel messages (same origin)
            try {
                const channel = new BroadcastChannel('feeds-store-qr');
                channel.addEventListener('message', (event) => {
                    console.log('Broadcast channel message received:', event.data);
                    if (event.data.type === 'TRIGGER_PURCHASE_MODAL') {
                        console.log('Triggering purchase modal for product ID:', event.data.productId);
                        showProductPurchaseModal(event.data.productId);
                        showNotification('QR Code scanned! Opening purchase modal...', 'success');
                    }
                });
                console.log('Broadcast channel initialized');
            } catch (error) {
                console.log('Broadcast channel not supported:', error);
            }
            
            // Listen for window messages (iframe/popup)
            window.addEventListener('message', (event) => {
                console.log('Window message received:', event.data);
                if (event.data.type === 'TRIGGER_PURCHASE_MODAL') {
                    showProductPurchaseModal(event.data.productId);
                    showNotification('QR Code scanned! Opening purchase modal...', 'success');
                }
            });
            
            // Poll for server-side triggers
            setInterval(checkForQRTriggers, 2000);
            console.log('QR communication system initialized');
        }
        
        // Check for QR triggers from server
        async function checkForQRTriggers() {
            try {
                const response = await fetch(`${API_BASE}/qr/check-triggers`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.trigger && data.trigger.productId) {
                        showProductPurchaseModal(data.trigger.productId);
                        showNotification('QR Code scanned! Opening purchase modal...', 'success');
                    }
                }
            } catch (error) {
                // Ignore errors, this is just polling
            }
        }
        
        // Download QR Code
        function downloadQRCode() {
            const qrCodeImg = document.getElementById('qrCodeImage');
            const canvas = document.getElementById('qrCanvas');
            
            if (qrCodeImg && qrCodeImg.src) {
                // Download from image
                const link = document.createElement('a');
                link.download = `product-qr-${Date.now()}.png`;
                link.href = qrCodeImg.src;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('QR Code downloaded successfully!', 'success');
            } else if (canvas) {
                // Fallback to canvas
                const link = document.createElement('a');
                link.download = `product-qr-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('QR Code downloaded successfully!', 'success');
            }
        }
        
        // Print QR Code
        function printQRCode() {
            const canvas = document.getElementById('qrCanvas');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Product QR Code</title>
                        <style>
                            body { text-align: center; font-family: Arial, sans-serif; }
                            h1 { color: #2c3e50; }
                            img { border: 2px solid #333; margin: 20px; }
                        </style>
                    </head>
                    <body>
                        <h1>Product QR Code</h1>
                        <h2>${document.getElementById('qrProductName').textContent}</h2>
                        <p>${document.getElementById('qrProductDetails').textContent}</p>
                        <img src="${canvas.toDataURL()}" alt="QR Code">
                        <p><small>Generated on ${new Date().toLocaleString()}</small></p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Staff Management Variables
        let staff = [];
        
        // Load staff from database
        async function loadStaff() {
            try {
                const response = await fetch(`${API_BASE}/staff`, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    staff = result.staff || [];
                    console.log(' Loaded staff from database:', staff.length);
                    console.log(' Staff data:', staff);
                    displayStaff();
                    updateStaffStats();
                } else {
                    console.error('Failed to load staff:', response.statusText);
                    showNotification('Failed to load staff data', 'error');
                }
            } catch (error) {
                console.error('Error loading staff:', error);
                showNotification('Error loading staff data', 'error');
            }
        }
        
        // Display staff in table
        function displayStaff() {
            const tbody = document.getElementById('staffTableBody');
            if (!tbody) return;
            
            if (staff.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                            No staff members found. Add your first staff member to get started.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = staff.map(member => `
                <tr>
                    <td>
                        <div class="staff-name">${member.firstName} ${member.lastName}</div>
                    </td>
                    <td>
                        <div class="staff-email">${member.email}</div>
                    </td>
                    <td>
                        <span class="staff-role role-${member.role}">${member.role}</span>
                    </td>
                    <td>
                        <span class="staff-status status-${member.status}">${member.status}</span>
                    </td>
                    <td>
                        <div class="staff-created">${new Date(member.createdAt).toLocaleDateString()}</div>
                    </td>
                    <td>
                        <div class="staff-actions">
                            ${member.status === 'pending' ? 
                                `<button class="btn btn-warning btn-sm" onclick="resendInvitation('${member._id}')">Resend</button>` : 
                                ''
                            }
                            ${member.status === 'active' ? 
                                `<button class="btn btn-warning btn-sm" onclick="pauseStaff('${member._id}')"> Pause</button>` : 
                                member.status === 'paused' ? 
                                `<button class="btn btn-success btn-sm" onclick="activateStaff('${member._id}')"> Activate</button>` :
                                ''
                            }
                            <button class="btn btn-secondary btn-sm" onclick="editStaff('${member._id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteStaff('${member._id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Update staff statistics
        function updateStaffStats() {
            const totalStaff = staff.length;
            const activeStaff = staff.filter(member => member.status === 'active').length;
            const pendingStaff = staff.filter(member => member.status === 'pending').length;
            const pausedStaff = staff.filter(member => member.status === 'paused').length;
            
            console.log(' Staff stats calculation:');
            console.log(' Total staff:', totalStaff);
            console.log(' Active staff:', activeStaff);
            console.log(' Pending staff:', pendingStaff);
            console.log(' Paused staff:', pausedStaff);
            console.log(' Staff statuses:', staff.map(s => ({ name: s.firstName + ' ' + s.lastName, status: s.status })));
            
            document.getElementById('totalStaff').textContent = totalStaff;
            document.getElementById('activeStaff').textContent = activeStaff;
            document.getElementById('pendingStaff').textContent = pendingStaff;
            
            // Update paused staff count if element exists
            const pausedStaffElement = document.getElementById('pausedStaff');
            if (pausedStaffElement) {
                pausedStaffElement.textContent = pausedStaff;
            }
        }
        
        // Add new staff
        async function addStaff(staffData) {
            try {
                const response = await fetch('/api/staff', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(staffData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message || 'Staff invitation sent successfully!', 'success');
                    closeStaffModal();
                    loadStaff(); // Reload staff list
                    
                    // Show temporary password for testing (remove in production)
                    if (result.temporaryPassword) {
                        console.log(' Temporary password for testing:', result.temporaryPassword);
                    }
                } else {
                    // Show specific error message
                    const errorMessage = result.message || result.error || 'Failed to add staff';
                    showNotification(errorMessage, 'error');
                    
                    // If it's an email already exists error, highlight the email field
                    if (result.error === 'Email already exists') {
                        const emailField = document.getElementById('staffEmail');
                        if (emailField) {
                            emailField.style.borderColor = '#dc3545';
                            emailField.focus();
                            
                            // Clear the error styling after 3 seconds
                            setTimeout(() => {
                                emailField.style.borderColor = '';
                            }, 3000);
                        }
                    }
                }
            } catch (error) {
                console.error('Error adding staff:', error);
                showNotification('Error adding staff', 'error');
            }
        }
        
        // Update existing staff
        async function updateStaff(staffId, staffData) {
            try {
                const response = await fetch(`/api/staff/${staffId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(staffData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message || 'Staff updated successfully!', 'success');
                    closeStaffModal();
                    loadStaff(); // Reload staff list
                } else {
                    showNotification(result.error || 'Failed to update staff', 'error');
                }
            } catch (error) {
                console.error('Error updating staff:', error);
                showNotification('Error updating staff', 'error');
            }
        }
        
        // Edit staff
        function editStaff(staffId) {
            console.log('Editing staff with ID:', staffId);
            const member = staff.find(s => s._id === staffId);
            if (!member) {
                console.error('Staff member not found:', staffId);
                showNotification('Staff member not found', 'error');
                return;
            }
            
            console.log('Found staff member:', member);
            
            // Populate the form with existing data
            document.getElementById('staffId').value = member._id;
            document.getElementById('staffFirstName').value = member.firstName;
            document.getElementById('staffLastName').value = member.lastName;
            document.getElementById('staffEmail').value = member.email;
            document.getElementById('staffRole').value = 'staff'; // Always set to staff
            document.getElementById('staffStatus').value = member.status;
            
            // Show status field for editing
            document.getElementById('staffStatusGroup').style.display = 'block';
            
            // Update modal title and button text
            document.getElementById('staffModalTitle').textContent = 'Edit Staff Member';
            document.getElementById('saveStaffBtn').textContent = 'Update Staff';
            
            // Open the modal
            openStaffModal();
        }
        
        // Delete staff
        async function deleteStaff(staffId) {
            const member = staff.find(s => s._id === staffId);
            if (!member) {
                console.error('Staff member not found:', staffId);
                showNotification('Staff member not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to deactivate ${member.firstName} ${member.lastName}?`)) {
                return;
            }
            
            try {
                console.log('Deleting staff with ID:', staffId);
                const response = await fetch(`/api/staff/${staffId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Delete response status:', response.status);
                const result = await response.json();
                console.log('Delete response:', result);
                
                if (response.ok) {
                    showNotification(result.message || 'Staff deactivated successfully', 'success');
                    loadStaff(); // Reload staff list
                } else {
                    showNotification(result.error || 'Failed to delete staff', 'error');
                }
            } catch (error) {
                console.error('Error deleting staff:', error);
                showNotification('Error deleting staff: ' + error.message, 'error');
            }
        }
        
        // Resend invitation
        async function resendInvitation(staffId) {
            try {
                const response = await fetch(`${API_BASE}/staff/${staffId}/resend`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message || 'Invitation resent successfully!', 'success');
                    
                    // Show temporary password for testing (remove in production)
                    if (result.temporaryPassword) {
                        console.log(' New temporary password for testing:', result.temporaryPassword);
                    }
                } else {
                    showNotification(result.error || 'Failed to resend invitation', 'error');
                }
            } catch (error) {
                console.error('Error resending invitation:', error);
                showNotification('Error resending invitation', 'error');
            }
        }
        
        // Pause staff account
        async function pauseStaff(staffId) {
            const member = staff.find(s => s._id === staffId);
            if (!member) {
                console.error('Staff member not found:', staffId);
                showNotification('Staff member not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to pause ${member.firstName} ${member.lastName}'s account? They will not be able to log in.`)) {
                return;
            }
            
            try {
                console.log('Pausing staff with ID:', staffId);
                const response = await fetch(`${API_BASE}/staff/${staffId}/pause`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Pause response status:', response.status);
                const result = await response.json();
                console.log('Pause response:', result);
                
                if (response.ok) {
                    showNotification(result.message || 'Staff account paused successfully', 'success');
                    loadStaff(); // Reload staff list
                } else {
                    showNotification(result.error || 'Failed to pause staff account', 'error');
                }
            } catch (error) {
                console.error('Error pausing staff:', error);
                showNotification('Error pausing staff: ' + error.message, 'error');
            }
        }
        
        // Activate staff account
        async function activateStaff(staffId) {
            const member = staff.find(s => s._id === staffId);
            if (!member) {
                console.error('Staff member not found:', staffId);
                showNotification('Staff member not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to activate ${member.firstName} ${member.lastName}'s account? They will be able to log in again.`)) {
                return;
            }
            
            try {
                console.log('Activating staff with ID:', staffId);
                const response = await fetch(`${API_BASE}/staff/${staffId}/activate`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Activate response status:', response.status);
                const result = await response.json();
                console.log('Activate response:', result);
                
                if (response.ok) {
                    showNotification(result.message || 'Staff account activated successfully', 'success');
                    loadStaff(); // Reload staff list
                } else {
                    showNotification(result.error || 'Failed to activate staff account', 'error');
                }
            } catch (error) {
                console.error('Error activating staff:', error);
                showNotification('Error activating staff: ' + error.message, 'error');
            }
        }
        
        // Clear all staff
        async function clearAllStaff() {
            // First, reload staff to get the most current data
            await loadStaff();
            
            if (staff.length === 0) {
                showNotification('No staff members to remove', 'info');
                return;
            }
            
            const confirmMessage = `Are you sure you want to remove ALL ${staff.length} staff members? This action cannot be undone!`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for safety
            if (!confirm('This will permanently delete all staff data. Are you absolutely sure?')) {
                return;
            }
            
            try {
                console.log('Clearing all staff members...');
                const response = await fetch(`${API_BASE}/staff/clear-all`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Clear all response status:', response.status);
                const result = await response.json();
                console.log('Clear all response:', result);
                
                if (response.ok) {
                    showNotification(result.message || 'All staff members removed successfully', 'success');
                    loadStaff(); // Reload staff list
                } else {
                    showNotification(result.error || 'Failed to remove staff members', 'error');
                }
            } catch (error) {
                console.error('Error clearing all staff:', error);
                showNotification('Error clearing all staff: ' + error.message, 'error');
            }
        }
        
        // Staff modal functions
        function openStaffModal() {
            document.getElementById('staffModal').style.display = 'block';
        }
        
        function closeStaffModal() {
            document.getElementById('staffModal').style.display = 'none';
            resetStaffModal();
        }
        
        function resetStaffModal() {
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            document.getElementById('staffStatusGroup').style.display = 'none';
            document.getElementById('staffModalTitle').textContent = 'Add New Staff';
            document.getElementById('saveStaffBtn').textContent = 'Send Invitation';
        }
        
        // Sales Forecasting Functions
        let forecastData = {
            salesHistory: [],
            products: [],
            forecasts: {}
        };
        
        // Load forecasting data
        async function loadForecasting() {
            try {
                console.log(' Loading forecasting data...');
                
                // Load sales data - get all historical data for forecasting
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                const params = new URLSearchParams();
                params.append('startDate', oneYearAgo.toISOString());
                params.append('endDate', new Date().toISOString());
                params.append('_t', Date.now());
                
                console.log(' Loading forecasting data from:', oneYearAgo.toISOString(), 'to:', new Date().toISOString());
                
                const salesResponse = await fetch(`${API_BASE}/orders/date-range?${params}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (salesResponse.ok) {
                    const salesData = await salesResponse.json();
                    forecastData.salesHistory = salesData.orders || [];
                    console.log(' Sales data loaded:', forecastData.salesHistory.length, 'records');
                }
                
                // Load products data
                const productsResponse = await fetch(`${API_BASE}/products`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (productsResponse.ok) {
                    const productsData = await productsResponse.json();
                    forecastData.products = productsData.products || [];
                    console.log(' Products data loaded:', forecastData.products.length, 'products');
                }
                
                // Generate forecasts
                generateForecasts();
                await updateForecastDisplay();
                
                // Set up real-time monitoring
                setupRealTimeForecasting();
                
            } catch (error) {
                console.error('Error loading forecasting data:', error);
            }
        }
        
        // Set up real-time forecasting updates
        function setupRealTimeForecasting() {
            console.log(' Setting up real-time forecasting updates...');
            
            // Method 1: Polling for new sales every 30 seconds
            setInterval(async () => {
                await checkForNewSales();
            }, 30000); // Check every 30 seconds
            
            // Method 2: Listen for storage events (when new sales are added)
            window.addEventListener('storage', (event) => {
                if (event.key === 'newSaleAdded' && event.newValue) {
                    console.log(' New sale detected via storage event');
                    refreshForecastingData();
                }
            });
            
            // Method 3: Listen for custom events
            window.addEventListener('newSaleProcessed', () => {
                console.log(' New sale processed event received');
                refreshForecastingData();
            });
            
            // Method 4: Monitor for changes in sales count
            let lastSalesCount = forecastData.salesHistory.length;
            setInterval(async () => {
                const currentSalesCount = await getCurrentSalesCount();
                if (currentSalesCount > lastSalesCount) {
                    console.log(' New sales detected, updating forecasts...');
                    lastSalesCount = currentSalesCount;
                    await refreshForecastingData();
                }
            }, 10000); // Check every 10 seconds
            
            console.log(' Real-time forecasting monitoring active');
        }
        
        // Check for new sales
        async function checkForNewSales() {
            try {
                // Get recent sales data (last 7 days) to check for new sales
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const params = new URLSearchParams();
                params.append('startDate', oneWeekAgo.toISOString());
                params.append('endDate', new Date().toISOString());
                
                // Add timestamp to prevent caching
                params.append('_t', Date.now());
                
                const response = await fetch(`${API_BASE}/orders?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const salesData = await response.json();
                    const newSalesCount = (salesData.sales || []).length;
                    const currentSalesCount = forecastData.salesHistory.length;
                    
                    if (newSalesCount > currentSalesCount) {
                        console.log(' New sales detected! Updating forecasts...');
                        await refreshForecastingData();
                    }
                }
            } catch (error) {
                console.log(' Sales check error (ignored):', error);
            }
        }
        
        // Get current sales count
        async function getCurrentSalesCount() {
            try {
                // Get recent sales data (last 7 days) to check count
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const params = new URLSearchParams();
                params.append('startDate', oneWeekAgo.toISOString());
                params.append('endDate', new Date().toISOString());
                
                // Add timestamp to prevent caching
                params.append('_t', Date.now());
                
                const response = await fetch(`${API_BASE}/orders?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const salesData = await response.json();
                    return (salesData.sales || []).length;
                }
            } catch (error) {
                console.log(' Sales count check error (ignored):', error);
            }
            return forecastData.salesHistory.length;
        }
        
        // Refresh forecasting data when new sales are detected
        async function refreshForecastingData() {
            try {
                console.log(' Refreshing forecasting data...');
                
                // Reload sales data - get all historical data for forecasting
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                const params = new URLSearchParams();
                params.append('startDate', oneYearAgo.toISOString());
                params.append('endDate', new Date().toISOString());
                
                // Add timestamp to prevent caching
                params.append('_t', Date.now());
                
                const salesResponse = await fetch(`${API_BASE}/orders?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (salesResponse.ok) {
                    const salesData = await salesResponse.json();
                    const newSalesCount = (salesData.sales || []).length;
                    const oldSalesCount = forecastData.salesHistory.length;
                    
                    forecastData.salesHistory = salesData.sales || [];
                    
                    if (newSalesCount > oldSalesCount) {
                        console.log(` New sales detected: ${newSalesCount - oldSalesCount} new orders`);
                        
                        // Regenerate forecasts with new data
                        generateForecasts();
                        await updateForecastDisplay();
                        
                        // Show notification
                        showForecastUpdateNotification();
                    }
                }
            } catch (error) {
                console.error('Error refreshing forecasting data:', error);
            }
        }
        
        // Show notification when forecasts are updated
        function showForecastUpdateNotification() {
            // Create a subtle notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d2b48c;
                color: #8b7355;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.innerHTML = ' Forecasts updated with new sales data';
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Generate sales forecasts
        function generateForecasts() {
            const salesData = forecastData.salesHistory;
            const products = forecastData.products;
            
            if (salesData.length === 0) {
                console.log(' No sales data available for forecasting');
                return;
            }
            
            // Validate sales data structure
            if (!Array.isArray(salesData)) {
                console.error(' Invalid sales data structure:', salesData);
                return;
            }
            
            // Check if sales data has the expected structure
            const sampleSale = salesData[0];
            if (!sampleSale || (!sampleSale.productId && !sampleSale.productName)) {
                console.log(' Sales data structure:', sampleSale);
                // Convert direct database format to expected format
                const convertedSalesData = [];
                
                // Process each order and create individual sales records for each item
                salesData.forEach(order => {
                    if (order.items && Array.isArray(order.items)) {
                        order.items.forEach(item => {
                            convertedSalesData.push({
                                id: `${order.id}-${item.productId || Math.random()}`,
                                productId: item.productId,
                                productName: item.productName || 'Unknown Product',
                                quantity: item.quantity || 1,
                                unit: item.unit || 'sack',
                                totalAmount: item.totalPrice || item.price || 0,
                                saleDate: new Date(order.createdAt),
                                customerName: order.customerName || 'Customer'
                            });
                        });
                    } else {
                        // Fallback for orders without items array
                        convertedSalesData.push({
                            id: order.id,
                            productId: null,
                            productName: 'Unknown Product',
                            quantity: 1,
                            unit: 'sack',
                            totalAmount: order.total || 0,
                            saleDate: new Date(order.createdAt),
                            customerName: order.customerName || 'Customer'
                        });
                    }
                });
                
                console.log(' Converted sales data:', convertedSalesData);
                forecastData.salesHistory = convertedSalesData;
            }
            
            // Calculate monthly sales
            const monthlySales = calculateMonthlySales(forecastData.salesHistory);
            
            // Generate forecasts for each product
            products.forEach(product => {
                // Filter sales data for this specific product
                const productSales = forecastData.salesHistory.filter(sale => {
                    // Handle both string and ObjectId comparisons
                    const productIdMatch = sale.productId === product._id || 
                                         sale.productId === product._id?.toString() ||
                                         sale.productId?.toString() === product._id?.toString();
                    const productNameMatch = sale.productName === product.name;
                    return productIdMatch || productNameMatch;
                });
                
                console.log(` Product ${product.name}: Found ${productSales.length} sales`);
                
                if (productSales.length > 0) {
                    const forecast = calculateProductForecast(productSales, product);
                    forecastData.forecasts[product._id] = forecast;
                    console.log(` Forecast for ${product.name}:`, forecast);
                } else {
                    // Create a default forecast for products with no sales
                    forecastData.forecasts[product._id] = {
                        currentSales: 0,
                        currentRevenue: 0,
                        nextMonthForecast: 0,
                        nextQuarterForecast: 0,
                        growthRate: 0,
                        confidence: 0.1,
                        trend: 0,
                        revenueTrend: 0
                    };
                }
            });
            
            console.log(' Forecasts generated for', Object.keys(forecastData.forecasts).length, 'products');
        }
        
        // Calculate monthly sales
        function calculateMonthlySales(salesData) {
            const monthlySales = {};
            
            salesData.forEach(sale => {
                const date = new Date(sale.saleDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlySales[monthKey]) {
                    monthlySales[monthKey] = 0;
                }
                monthlySales[monthKey] += (sale.totalAmount || 0);
            });
            
            return monthlySales;
        }
        
        // Calculate product forecast
        function calculateProductForecast(salesData, product) {
            console.log(` Calculating forecast for ${product.name} with ${salesData.length} sales`);
            
            const monthlyData = {};
            
            // Group sales by month
            salesData.forEach(sale => {
                const date = new Date(sale.saleDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { quantity: 0, revenue: 0 };
                }
                
                monthlyData[monthKey].quantity += (sale.quantity || 0);
                monthlyData[monthKey].revenue += (sale.totalAmount || 0);
            });
            
            console.log(` Monthly data for ${product.name}:`, monthlyData);
            
            // Calculate trend
            const months = Object.keys(monthlyData).sort();
            const quantities = months.map(month => monthlyData[month].quantity);
            const revenues = months.map(month => monthlyData[month].revenue);
            
            console.log(` Quantities for ${product.name}:`, quantities);
            console.log(` Revenues for ${product.name}:`, revenues);
            
            // Handle cases with limited data
            if (quantities.length === 0) {
                return {
                    currentSales: 0,
                    currentRevenue: 0,
                    nextMonthForecast: 0,
                    nextQuarterForecast: 0,
                    growthRate: 0,
                    confidence: 0.1,
                    trend: 0,
                    revenueTrend: 0
                };
            }
            
            // Simple linear regression for trend
            const trend = calculateTrend(quantities);
            const revenueTrend = calculateTrend(revenues);
            
            console.log(` Trend for ${product.name}:`, trend, 'Revenue trend:', revenueTrend);
            
            // Forecast next month - use average if trend is unreliable
            let nextMonthForecast;
            if (quantities.length >= 3) {
                nextMonthForecast = quantities[quantities.length - 1] + trend;
            } else {
                // Use average for limited data
                const avgQuantity = quantities.reduce((a, b) => a + b, 0) / quantities.length;
                nextMonthForecast = avgQuantity;
            }
            
            const nextQuarterForecast = nextMonthForecast * 3;
            
            const currentSales = quantities[quantities.length - 1] || 0;
            const currentRevenue = revenues[revenues.length - 1] || 0;
            
            // Calculate actual growth rate based on revenue comparison
            let actualGrowthRate = 0;
            
            if (revenues.length >= 2) {
                const currentRevenue = revenues[revenues.length - 1];
                const previousRevenue = revenues[revenues.length - 2];
                if (previousRevenue > 0) {
                    actualGrowthRate = ((currentRevenue - previousRevenue) / previousRevenue) * 100;
                } else if (currentRevenue > 0) {
                    actualGrowthRate = 100; // 100% growth if previous was 0
                }
            } else if (revenues.length === 1 && revenues[0] > 0) {
                // If only one month of data, assume positive growth
                actualGrowthRate = 15; // Assume 15% growth for new products
            }
            
            // If we still have 0 growth rate, use trend-based calculation
            if (actualGrowthRate === 0 && quantities.length >= 2) {
                // Calculate growth based on quantity trend
                const currentQuantity = quantities[quantities.length - 1];
                const previousQuantity = quantities[quantities.length - 2];
                if (previousQuantity > 0) {
                    actualGrowthRate = ((currentQuantity - previousQuantity) / previousQuantity) * 100;
                } else if (currentQuantity > 0) {
                    actualGrowthRate = 100;
                }
            }
            
            // If still 0, use a positive assumption for products with sales
            if (actualGrowthRate === 0 && currentRevenue > 0) {
                actualGrowthRate = 10; // Assume 10% growth for products with current sales
            }
            
            // Cap the growth rate to reasonable limits
            actualGrowthRate = Math.max(-50, Math.min(200, actualGrowthRate));
            
            return {
                currentSales: currentSales,
                currentRevenue: currentRevenue,
                nextMonthForecast: Math.max(0, nextMonthForecast),
                nextQuarterForecast: Math.max(0, nextQuarterForecast),
                growthRate: actualGrowthRate,
                confidence: calculateConfidence(quantities),
                trend: trend,
                revenueTrend: revenueTrend
            };
        }
        
        // Calculate trend using simple linear regression
        function calculateTrend(values) {
            if (values.length < 2) return 0;
            
            const n = values.length;
            const x = Array.from({length: n}, (_, i) => i);
            const y = values;
            
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
            
            const denominator = n * sumXX - sumX * sumX;
            if (Math.abs(denominator) < 1e-10) return 0; // Avoid division by zero
            
            const slope = (n * sumXY - sumX * sumY) / denominator;
            return isNaN(slope) ? 0 : slope;
        }
        
        // Calculate confidence level
        function calculateConfidence(values) {
            if (values.length < 3) return 0.5;
            
            // Calculate coefficient of variation
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            const cv = stdDev / mean;
            
            // Convert to confidence (lower CV = higher confidence)
            return Math.max(0.1, Math.min(0.9, 1 - cv));
        }
        
        // Calculate actual growth rate based on sales data
        function calculateActualGrowthRate(salesData) {
            console.log(' Calculating growth rate with', salesData.length, 'sales');
            
            if (!salesData || salesData.length < 2) {
                console.log(' Not enough sales data for growth calculation');
                return 0;
            }
            
            // Group sales by month
            const monthlyRevenue = {};
            salesData.forEach(sale => {
                const date = new Date(sale.saleDate);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyRevenue[monthKey]) {
                    monthlyRevenue[monthKey] = 0;
                }
                monthlyRevenue[monthKey] += (sale.totalAmount || 0);
            });
            
            console.log(' Monthly revenue data:', monthlyRevenue);
            
            // Sort months and get revenue data
            const months = Object.keys(monthlyRevenue).sort();
            console.log(' Available months:', months);
            
            if (months.length < 2) {
                console.log(' Only one month of data, using trend-based calculation');
                // If only one month, calculate based on daily trend within that month
                return calculateDailyTrendGrowthRate(salesData);
            }
            
            // Calculate month-over-month growth rate
            const recentMonths = months.slice(-2); // Last 2 months
            const currentMonthRevenue = monthlyRevenue[recentMonths[1]] || 0;
            const previousMonthRevenue = monthlyRevenue[recentMonths[0]] || 0;
            
            console.log(' Current month revenue:', currentMonthRevenue);
            console.log(' Previous month revenue:', previousMonthRevenue);
            
            if (previousMonthRevenue === 0) {
                return currentMonthRevenue > 0 ? 100 : 0;
            }
            
            const growthRate = ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100;
            console.log(' Calculated growth rate:', growthRate);
            return isNaN(growthRate) ? 0 : growthRate;
        }
        
        // Calculate growth rate based on daily trend within a single month
        function calculateDailyTrendGrowthRate(salesData) {
            if (salesData.length < 3) {
                return 0; // Not enough data for trend
            }
            
            // Group sales by day
            const dailyRevenue = {};
            salesData.forEach(sale => {
                const date = new Date(sale.saleDate);
                const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                if (!dailyRevenue[dayKey]) {
                    dailyRevenue[dayKey] = 0;
                }
                dailyRevenue[dayKey] += (sale.totalAmount || 0);
            });
            
            const days = Object.keys(dailyRevenue).sort();
            if (days.length < 3) {
                return 0;
            }
            
            // Calculate trend using first half vs second half of the month
            const midPoint = Math.floor(days.length / 2);
            const firstHalf = days.slice(0, midPoint);
            const secondHalf = days.slice(midPoint);
            
            const firstHalfRevenue = firstHalf.reduce((sum, day) => sum + dailyRevenue[day], 0);
            const secondHalfRevenue = secondHalf.reduce((sum, day) => sum + dailyRevenue[day], 0);
            
            if (firstHalfRevenue === 0) {
                return secondHalfRevenue > 0 ? 100 : 0;
            }
            
            const growthRate = ((secondHalfRevenue - firstHalfRevenue) / firstHalfRevenue) * 100;
            console.log(' Daily trend growth rate:', growthRate);
            return isNaN(growthRate) ? 0 : growthRate;
        }
        
        // Fallback growth rate calculation for limited data
        function calculateFallbackGrowthRate(salesData) {
            console.log(' Using fallback growth calculation with', salesData.length, 'sales');
            
            if (salesData.length < 2) {
                return 0;
            }
            
            // Sort sales by date
            const sortedSales = salesData.sort((a, b) => new Date(a.saleDate) - new Date(b.saleDate));
            
            // Use a more sophisticated approach - compare last 25% vs previous 25%
            const quarterPoint = Math.floor(sortedSales.length * 0.25);
            const recentSales = sortedSales.slice(-quarterPoint);
            const previousSales = sortedSales.slice(-quarterPoint * 2, -quarterPoint);
            
            console.log(' Recent sales count:', recentSales.length);
            console.log(' Previous sales count:', previousSales.length);
            
            const recentRevenue = recentSales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            const previousRevenue = previousSales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            
            console.log(' Recent revenue:', recentRevenue);
            console.log(' Previous revenue:', previousRevenue);
            
            // If we don't have enough data for comparison, use a positive growth assumption
            if (previousRevenue === 0 || recentSales.length < 2) {
                console.log(' Insufficient data for comparison, using positive growth assumption');
                return 15; // Assume 15% growth for new businesses
            }
            
            const growthRate = ((recentRevenue - previousRevenue) / previousRevenue) * 100;
            console.log(' Fallback growth rate:', growthRate);
            
            // If growth is very negative, it might be due to data distribution issues
            // Use a more conservative approach
            if (growthRate < -30) {
                console.log(' Very negative growth detected, using conservative positive growth');
                return 10; // Assume 10% growth instead of negative
            }
            
            // Cap the growth rate to reasonable limits
            return Math.max(-20, Math.min(100, isNaN(growthRate) ? 10 : growthRate));
        }
        
        // Business-aware growth rate calculation for high-revenue businesses
        function calculateBusinessAwareGrowthRate(salesData, totalRevenue) {
            console.log(' Calculating business-aware growth rate for high-revenue business');
            console.log(' Total revenue:', totalRevenue);
            
            // For businesses with high revenue, use a more optimistic approach
            const salesCount = salesData.length;
            const avgSaleValue = totalRevenue / salesCount;
            
            console.log(' Sales count:', salesCount);
            console.log(' Average sale value:', avgSaleValue);
            
            // Calculate based on sales frequency and value
            const recentSales = salesData.slice(-Math.min(10, Math.floor(salesCount * 0.1)));
            const recentRevenue = recentSales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            const recentAvg = recentRevenue / recentSales.length;
            
            console.log(' Recent average sale:', recentAvg);
            console.log(' Overall average sale:', avgSaleValue);
            
            // If recent sales are performing well, assume positive growth
            if (recentAvg >= avgSaleValue * 0.8) { // Recent sales are at least 80% of average
                console.log(' Recent sales performing well, assuming positive growth');
                return 15; // Assume 15% growth for healthy businesses
            }
            
            // If we have high revenue but declining recent sales, use conservative growth
            if (totalRevenue > 2000000) { // Over 2M in sales
                console.log(' High-revenue business, using conservative positive growth');
                return 8; // Conservative 8% growth
            }
            
            // Default positive growth for established businesses
            console.log(' Using default positive growth for established business');
            return 12; // 12% growth assumption
        }
        
        // Update forecast display
        async function updateForecastDisplay() {
            console.log(' Updating forecast display...');
            const salesData = forecastData.salesHistory;
            const products = forecastData.products;
            
            console.log(' Sales data length:', salesData.length);
            console.log(' Products length:', products.length);
            console.log(' Raw sales data sample:', salesData.slice(0, 3));
            
            if (salesData.length === 0) {
                console.log(' No sales data to display - showing placeholders');
                // Set default values for UI
                document.getElementById('nextMonthForecast').textContent = `0.00`;
                document.getElementById('quarterlyTarget').textContent = `0.00`;
                document.getElementById('growthRate').textContent = `0%`;
                document.getElementById('topProduct').textContent = `-`;
                return;
            }
            
            // Calculate overall metrics
            const totalRevenue = salesData.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            const monthsDifference = getMonthsDifference(salesData);
            const monthlyRevenue = monthsDifference > 0 ? totalRevenue / monthsDifference : totalRevenue;
            
            console.log(' Forecast calculations:', {
                totalRevenue,
                monthsDifference,
                monthlyRevenue,
                salesCount: salesData.length
            });
            
            // Calculate actual growth rate based on sales data
            let actualGrowthRate = calculateActualGrowthRate(salesData);
            
            // If growth rate is still 0, use a more sophisticated calculation
            if (actualGrowthRate === 0 && salesData.length > 0) {
                console.log(' Using fallback growth calculation...');
                actualGrowthRate = calculateFallbackGrowthRate(salesData);
            }
            
            // If we still have a very negative growth rate, apply business logic
            if (actualGrowthRate < -20 && totalRevenue > 1000000) { // If you have over 1M in sales
                console.log(' High revenue business with negative growth - applying business logic');
                actualGrowthRate = calculateBusinessAwareGrowthRate(salesData, totalRevenue);
            }
            
            const growthMultiplier = 1 + (actualGrowthRate / 100);
            const nextMonthForecast = monthlyRevenue * growthMultiplier;
            
            // Ensure values are not NaN
            const safeNextMonthForecast = isNaN(nextMonthForecast) || nextMonthForecast < 0 ? monthlyRevenue : nextMonthForecast;
            const safeGrowthRate = isNaN(actualGrowthRate) ? 0 : actualGrowthRate;
            const safeQuarterlyTarget = isNaN(monthlyRevenue * 3) ? 0 : monthlyRevenue * 3;
            const safeQuarterlyProgress = isNaN((totalRevenue / (monthlyRevenue * 3)) * 100) ? 0 : Math.min(100, (totalRevenue / (monthlyRevenue * 3)) * 100);
            
            console.log(' Safe values for display:', {
                safeNextMonthForecast: safeNextMonthForecast.toFixed(2),
                safeGrowthRate: safeGrowthRate.toFixed(1),
                safeQuarterlyTarget: safeQuarterlyTarget.toFixed(2),
                safeQuarterlyProgress: safeQuarterlyProgress.toFixed(1)
            });
            
            // Update DOM elements with formatted values
            const nextMonthElement = document.getElementById('nextMonthForecast');
            const quarterlyElement = document.getElementById('quarterlyTarget');
            const growthElement = document.getElementById('growthRate');
            const topProductElement = document.getElementById('topProduct');
            
            if (nextMonthElement) {
                nextMonthElement.textContent = `${safeNextMonthForecast.toFixed(2)}`;
            }
            if (quarterlyElement) {
                quarterlyElement.textContent = `${safeQuarterlyTarget.toFixed(2)}`;
            }
            if (growthElement) {
                growthElement.textContent = `${safeGrowthRate.toFixed(1)}%`;
            }
            
            // Update progress bar
            const progressBar = document.getElementById('quarterlyProgress');
            if (progressBar) {
                progressBar.style.width = `${safeQuarterlyProgress}%`;
            }
            const progressPercent = document.getElementById('quarterlyPercentage');
            if (progressPercent) {
                progressPercent.textContent = `${safeQuarterlyProgress.toFixed(1)}%`;
            }
            
            // Update change percentages
            const nextMonthChange = document.getElementById('nextMonthChange');
            if (nextMonthChange) {
                nextMonthChange.textContent = `${safeGrowthRate >= 0 ? '+' : ''}${safeGrowthRate.toFixed(1)}%`;
            }
            
            // Update growth trend emoji
            const growthTrend = document.getElementById('growthTrend');
            if (growthTrend) {
                growthTrend.textContent = safeGrowthRate >= 0 ? '' : '';
            }
            
            // Top product
            const topProduct = getTopProduct();
            if (topProduct) {
                if (topProductElement) {
                    topProductElement.textContent = topProduct.name;
                }
                const topProductSales = document.getElementById('topProductSales');
                if (topProductSales) {
                    topProductSales.textContent = `${topProduct.revenue.toFixed(2)}`;
                }
            }
            
            // Update daily sales data
            await updateDailySalesDisplay();
            
            // Update recent sales table
            updateRecentSalesTable();
            
            // Update forecast table
            updateForecastTable();
            
            // Update insights
            updateForecastInsights();
            
            console.log(' Forecast display update complete');
        }
        
        // Update daily sales display - use same logic as analytics
        async function updateDailySalesDisplay() {
            try {
                // Get today's sales data
                const { startDate, endDate } = getDateRangeForPeriod('today');
                
                const params = new URLSearchParams();
                params.append('startDate', startDate.toISOString());
                params.append('endDate', endDate.toISOString());
                params.append('_t', Date.now());
                
                console.log(' Loading daily sales from:', startDate, 'to:', endDate);
                
                const response = await fetch(`${API_BASE}/orders/summary/sales?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(' Daily sales data:', data);
                    
                    const summary = data.summary || {};
                    const revenue = summary.totalRevenue || 0;
                    const orders = summary.totalOrders || 0;
                    
                    document.getElementById('todaySales').textContent = `${revenue.toFixed(2)}`;
                    document.getElementById('todayOrders').textContent = `${orders} orders`;
                    
                    // Get yesterday's data
                    const { startDate: yesterdayStart, endDate: yesterdayEnd } = getDateRangeForPeriod('yesterday');
                    
                    const yesterdayParams = new URLSearchParams();
                    yesterdayParams.append('startDate', yesterdayStart.toISOString());
                    yesterdayParams.append('endDate', yesterdayEnd.toISOString());
                    yesterdayParams.append('_t', Date.now());
                    
                    const yesterdayResponse = await fetch(`${API_BASE}/orders/summary/sales?${yesterdayParams}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (yesterdayResponse.ok) {
                        const yesterdayData = await yesterdayResponse.json();
                        const yesterdaySummary = yesterdayData.summary || {};
                        document.getElementById('yesterdaySales').textContent = `${(yesterdaySummary.totalRevenue || 0).toFixed(2)}`;
                        document.getElementById('yesterdayOrders').textContent = `${yesterdaySummary.totalOrders || 0} orders`;
                    } else {
                        document.getElementById('yesterdaySales').textContent = '0.00';
                        document.getElementById('yesterdayOrders').textContent = '0 orders';
                    }
                    
                    // Get this week's data
                    const { startDate: weekStart, endDate: weekEnd } = getDateRangeForPeriod('week');
                    
                    const weekParams = new URLSearchParams();
                    weekParams.append('startDate', weekStart.toISOString());
                    weekParams.append('endDate', weekEnd.toISOString());
                    weekParams.append('_t', Date.now());
                    
                    const weekResponse = await fetch(`${API_BASE}/orders/summary/sales?${weekParams}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (weekResponse.ok) {
                        const weekData = await weekResponse.json();
                        const weekSummary = weekData.summary || {};
                        const weekRevenue = weekSummary.totalRevenue || 0;
                        const weekOrders = weekSummary.totalOrders || 0;
                        document.getElementById('weekSales').textContent = `${weekRevenue.toFixed(2)}`;
                        document.getElementById('weekOrders').textContent = `${weekOrders} orders`;
                        
                        // Calculate daily average for the week
                        const dailyAverage = weekRevenue / 7;
                        const avgOrders = weekOrders / 7;
                        document.getElementById('dailyAverage').textContent = `${dailyAverage.toFixed(2)}`;
                        document.getElementById('avgOrders').textContent = `${avgOrders.toFixed(1)} orders/day`;
                    } else {
                        document.getElementById('weekSales').textContent = '0.00';
                        document.getElementById('weekOrders').textContent = '0 orders';
                        document.getElementById('dailyAverage').textContent = '0.00';
                        document.getElementById('avgOrders').textContent = '0 orders/day';
                    }
                    
                } else {
                    // Fallback to zero values if API call fails
                    document.getElementById('todaySales').textContent = '0.00';
                    document.getElementById('todayOrders').textContent = '0 orders';
                    document.getElementById('yesterdaySales').textContent = '0.00';
                    document.getElementById('yesterdayOrders').textContent = '0 orders';
                    document.getElementById('weekSales').textContent = '0.00';
                    document.getElementById('weekOrders').textContent = '0 orders';
                    document.getElementById('dailyAverage').textContent = '0.00';
                    document.getElementById('avgOrders').textContent = '0 orders/day';
                }
            } catch (error) {
                console.error('Error updating daily sales display:', error);
                // Set all daily stats to zero on error
                document.getElementById('todaySales').textContent = '0.00';
                document.getElementById('todayOrders').textContent = '0 orders';
                document.getElementById('yesterdaySales').textContent = '0.00';
                document.getElementById('yesterdayOrders').textContent = '0 orders';
                document.getElementById('weekSales').textContent = '0.00';
                document.getElementById('weekOrders').textContent = '0 orders';
                document.getElementById('dailyAverage').textContent = '0.00';
                document.getElementById('avgOrders').textContent = '0 orders/day';
            }
        }
        
        // Update recent sales table with pagination
        function updateRecentSalesTable() {
            const salesData = forecastData.salesHistory;
            const tbody = document.getElementById('recentSalesTableBody');
            
            console.log(' Updating recent sales table with', salesData.length, 'sales');
            
            // Store all sales data
            forecastingSalesData = salesData || [];
            
            // Calculate total pages
            totalForecastingPages = Math.max(1, Math.ceil(forecastingSalesData.length / forecastingItemsPerPage));
            
            // Reset to page 1 if current page is beyond total pages
            if (currentForecastingPage > totalForecastingPages) {
                currentForecastingPage = 1;
            }
            
            // Update pagination display
            updateForecastingPagination();
            
            // Update total sales summary with ALL sales
            updateRecentSalesSummary(forecastingSalesData);
            
            // Show pagination controls
            const paginationControls = document.querySelector('.forecasting-pagination-controls');
            if (paginationControls) {
                paginationControls.style.display = 'flex';
            }
            
            if (forecastingSalesData.length === 0) {
                console.log(' No sales data for recent sales table');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #a09080;">No recent sales data</td></tr>';
                return;
            }
            
            // Sort all sales first to find the globally newest one
            const sortedAllSales = [...forecastingSalesData]
                .sort((a, b) => new Date(b.orderDate || b.saleDate) - new Date(a.orderDate || a.saleDate));
            const globallyNewestSaleDate = sortedAllSales[0]?.orderDate || sortedAllSales[0]?.saleDate;
            
            // Get current page data
            const startIndex = (currentForecastingPage - 1) * forecastingItemsPerPage;
            const endIndex = startIndex + forecastingItemsPerPage;
            const currentPageSales = sortedAllSales.slice(startIndex, endIndex);
            
            tbody.innerHTML = currentPageSales.map((sale, index) => {
                try {
                    // Handle both orderDate and saleDate
                    const dateStr = sale.orderDate || sale.saleDate;
                    const saleDate = new Date(dateStr);
                const timeString = saleDate.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                    // Get customer info - try different field names
                    const customerName = sale.customerName || sale.customerInfo?.name || (sale.customerId?.name) || 'Customer';
                    
                    // Handle items display - orders have items array
                    let itemsSummary = 'Order';
                    let quantity = 0;
                    if (sale.items && sale.items.length > 0) {
                        itemsSummary = sale.items.map(i => i.name || i.productName).join(', ');
                        quantity = sale.items.reduce((sum, i) => sum + (i.quantity || 1), 0);
                    } else if (sale.productName) {
                        itemsSummary = sale.productName;
                        quantity = sale.quantity || 0;
                    }
                    
                const status = sale.status || 'completed';
                
                // Highlight ONLY the globally newest sale if it's on page 1
                const isGloballyNewest = dateStr === globallyNewestSaleDate && currentForecastingPage === 1;
                const highlightClass = isGloballyNewest ? 'newest-sale' : '';
                const highlightStyle = isGloballyNewest ? 'background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-left: 4px solid #4CAF50; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);' : '';
                
                // Handle both total and totalAmount
                const totalAmount = sale.total || sale.totalAmount || 0;
                
                return `
                    <tr class="${highlightClass}" style="${highlightStyle}">
                        <td>${timeString}${isGloballyNewest ? ' ' : ''}</td>
                        <td>${customerName}</td>
                            <td>${quantity} items - ${itemsSummary}</td>
                            <td>${totalAmount.toLocaleString()}</td>
                        <td class="status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</td>
                    </tr>
                `;
                } catch (error) {
                    console.error('Error rendering forecasting sale row:', error, sale);
                    return '<tr><td colspan="5">Error displaying sale</td></tr>';
                }
            }).join('');
        }
        
        // Update recent sales summary
        function updateRecentSalesSummary(recentSales) {
            const totalCount = document.getElementById('recentSalesCount');
            const totalRevenue = document.getElementById('recentSalesTotal');
            
            if (!totalCount || !totalRevenue) {
                console.log(' Recent sales summary elements not found');
                return;
            }
            
            const totalOrders = recentSales.length;
            // Handle both old format (totalAmount) and new format (total)
            const totalRevenueAmount = recentSales.reduce((sum, sale) => sum + (sale.total || sale.totalAmount || 0), 0);
            
            totalCount.textContent = totalOrders;
            totalRevenue.textContent = totalRevenueAmount.toFixed(2);
            
            console.log(' Updated recent sales summary:', { totalOrders, totalRevenueAmount });
        }
        
        // Update forecasting pagination controls
        function updateForecastingPagination() {
            const paginationInfo = document.getElementById('forecastingPaginationInfo');
            const prevBtn = document.getElementById('prevForecastingPage');
            const nextBtn = document.getElementById('nextForecastingPage');
            const pageNumbers = document.getElementById('forecastingPageNumbers');
            
            // Update pagination info
            paginationInfo.textContent = `Page ${currentForecastingPage} of ${totalForecastingPages}`;
            
            // Update button states
            prevBtn.disabled = currentForecastingPage <= 1;
            nextBtn.disabled = currentForecastingPage >= totalForecastingPages;
            
            // Generate page numbers
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentForecastingPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalForecastingPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `pagination-btn ${i === currentForecastingPage ? 'active' : ''}`;
                pageBtn.style.cssText = 'padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px; margin: 0 2px;';
                if (i === currentForecastingPage) {
                    pageBtn.style.background = '#2c5530';
                    pageBtn.style.color = 'white';
                }
                pageBtn.addEventListener('click', () => goToForecastingPage(i));
                pageNumbers.appendChild(pageBtn);
            }
        }
        
        // Navigate to specific forecasting page
        function goToForecastingPage(page) {
            if (page >= 1 && page <= totalForecastingPages) {
                currentForecastingPage = page;
                updateRecentSalesTable(); // Refresh with same data
            }
        }
        
        // Navigate to previous forecasting page
        function prevForecastingPage() {
            if (currentForecastingPage > 1) {
                goToForecastingPage(currentForecastingPage - 1);
            }
        }
        
        // Navigate to next forecasting page
        function nextForecastingPage() {
            if (currentForecastingPage < totalForecastingPages) {
                goToForecastingPage(currentForecastingPage + 1);
            }
        }
        
        // Helper function to calculate days difference
        function getDaysDifference(salesData) {
            if (salesData.length === 0) return 1;
            
            const dates = salesData.map(sale => new Date(sale.saleDate));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            return Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1);
        }
        
        // Get top performing product
        function getTopProduct() {
            const productRevenues = {};
            
            forecastData.salesHistory.forEach(sale => {
                // Sales data structure: each sale is a single product transaction
                const productId = sale.productId || sale.productName;
                const productName = sale.productName || 'Unknown Product';
                const revenue = sale.totalAmount || 0;
                
                if (!productRevenues[productId]) {
                    productRevenues[productId] = { name: productName, revenue: 0 };
                }
                productRevenues[productId].revenue += revenue;
            });
            
            const topProduct = Object.values(productRevenues).reduce((max, product) => 
                product.revenue > max.revenue ? product : max, { revenue: 0 });
            
            return topProduct.revenue > 0 ? topProduct : null;
        }
        
        // Update forecast table
        function updateForecastTable() {
            console.log(' Updating forecast table...');
            const tbody = document.getElementById('forecastTableBody');
            const products = forecastData.products;
            
            if (!tbody) {
                console.error(' forecastTableBody element not found');
                return;
            }
            
            if (!products || products.length === 0) {
                console.log(' No products available for forecast table');
                tbody.innerHTML = '<tr><td colspan="6">No products available</td></tr>';
                return;
            }
            
            console.log(' Products for forecast table:', products.length);
            console.log(' Forecasts available:', Object.keys(forecastData.forecasts).length);
            
            const tableRows = products.map(product => {
                const forecast = forecastData.forecasts[product._id];
                if (!forecast) {
                    console.log(` No forecast for product: ${product.name}`);
                    return '';
                }
                
                const growthPercent = forecast.growthRate.toFixed(1);
                const confidence = (forecast.confidence * 100).toFixed(0);
                
                let recommendation = 'Maintain current strategy';
                if (forecast.growthRate > 20) {
                    recommendation = 'Increase inventory and marketing';
                } else if (forecast.growthRate < -10) {
                    recommendation = 'Review pricing and promotion';
                }
                
                return `
                    <tr>
                        <td>${product.name}</td>
                        <td>${forecast.currentRevenue.toLocaleString()}</td>
                        <td>${forecast.nextMonthForecast.toLocaleString()}</td>
                        <td>${growthPercent}%</td>
                        <td>${confidence}%</td>
                        <td>${recommendation}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = tableRows;
            console.log(' Forecast table updated with', products.length, 'products');
        }
        
        // Update forecast insights
        function updateForecastInsights() {
            console.log(' Updating forecast insights...');
            
            const opportunities = [
                'Chicken feed products showing strong growth potential',
                'Pig supplements market expanding rapidly',
                'Seasonal demand increase expected in Q2'
            ];
            
            const risks = [
                'Supply chain disruptions affecting feed availability',
                'Competition from new market entrants',
                'Price volatility in raw materials'
            ];
            
            const recommendations = [
                'Increase inventory for high-growth products',
                'Develop seasonal marketing campaigns',
                'Consider bulk purchasing for cost savings',
                'Monitor competitor pricing strategies'
            ];
            
            // Check if elements exist before updating
            const opportunitiesList = document.getElementById('opportunitiesList');
            const risksList = document.getElementById('risksList');
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (opportunitiesList) {
                opportunitiesList.innerHTML = opportunities.map(opp => `<li>${opp}</li>`).join('');
                console.log(' Updated opportunities list');
            } else {
                console.error(' opportunitiesList element not found');
            }
            
            if (risksList) {
                risksList.innerHTML = risks.map(risk => `<li>${risk}</li>`).join('');
                console.log(' Updated risks list');
            } else {
                console.error(' risksList element not found');
            }
            
            if (recommendationsList) {
                recommendationsList.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
                console.log(' Updated recommendations list');
            } else {
                console.error(' recommendationsList element not found');
            }
        }
        
        // Helper function to calculate months difference
        function getMonthsDifference(salesData) {
            if (salesData.length === 0) return 1;
            
            const dates = salesData.map(sale => new Date(sale.saleDate));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            return Math.max(1, (maxDate.getFullYear() - minDate.getFullYear()) * 12 + 
                (maxDate.getMonth() - minDate.getMonth()) + 1);
        }
        
        // Sales Chart Functions
        async function loadSalesChart() {
            try {
                console.log(' Loading sales chart data...');
                
                // Calculate date range based on current period
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - currentChartPeriod);
                
                const params = new URLSearchParams();
                params.append('startDate', startDate.toISOString());
                params.append('endDate', endDate.toISOString());
                
                // Add timestamp to prevent caching
                params.append('_t', Date.now());
                
                const response = await fetch(`${API_BASE}/orders/date-range?${params}`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(' Sales chart data loaded:', data);
                    createSalesChart(data.orders || []);
                } else {
                    console.error('Failed to load sales chart data');
                    createSalesChart([]);
                }
            } catch (error) {
                console.error('Error loading sales chart:', error);
                createSalesChart([]);
            }
        }
        
        function createSalesChart(salesData) {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (salesChart) {
                salesChart.destroy();
            }
            
            // Process sales data for chart
            const chartData = processSalesDataForChart(salesData);
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Daily Sales ()',
                        data: chartData.values,
                        borderColor: '#8b7355',
                        backgroundColor: 'rgba(139, 115, 85, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#8b7355',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: 'black',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: '#8b7355',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Sales: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(139, 115, 85, 0.2)'
                            },
                            ticks: {
                                color: 'black',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(139, 115, 85, 0.2)'
                            },
                            ticks: {
                                color: 'black',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return '' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function processSalesDataForChart(salesData) {
            console.log(' Processing sales data for chart:', salesData);
            const days = currentChartPeriod;
            const labels = [];
            const values = [];
            
            // Create array of dates
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                values.push(0);
            }
            
            // Group sales by date - handle different data structures
            const salesByDate = {};
            salesData.forEach(sale => {
                // Handle order database structure (has orderDate and total)
                const saleDate = new Date(sale.orderDate || sale.createdAt || sale.saleDate);
                const dateKey = saleDate.toDateString();
                
                if (!salesByDate[dateKey]) {
                    salesByDate[dateKey] = 0;
                }
                // Handle different total amount field names
                const totalAmount = sale.total || sale.totalAmount || 0;
                salesByDate[dateKey] += totalAmount;
            });
            
            // Fill in the values
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (days - 1 - i));
                const dateKey = date.toDateString();
                
                if (salesByDate[dateKey]) {
                    values[i] = salesByDate[dateKey];
                }
            }
            
            console.log(' Final chart data:', { labels, values });
            return { labels, values };
        }
        
        function updateChartPeriod(period) {
            currentChartPeriod = period;
            
            // Update button states
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Reload chart with new period
            loadSalesChart();
        }
        
        function downloadChart() {
            if (!salesChart) {
                showNotification('No chart available to download', 'error');
                return;
            }
            
            try {
                // Get the chart canvas
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    showNotification('Chart canvas not found', 'error');
                    return;
                }
                
                // Create download link
                const link = document.createElement('a');
                link.download = `sales-chart-${currentChartPeriod}days-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Chart downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error downloading chart:', error);
                showNotification('Failed to download chart', 'error');
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            console.log(' Dashboard initializing...');
            
            // Initialize admin QR scanner
            initAdminScanner();
            
            // Test if buttons are clickable
            setTimeout(() => {
                console.log(' Testing button functionality...');
                const testButtons = document.querySelectorAll('button, .btn, .nav-btn');
                console.log('Found buttons:', testButtons.length);
                testButtons.forEach((btn, index) => {
                    if (index < 5) { // Test first 5 buttons
                        console.log(`Button ${index}:`, btn.id || btn.className, 'clickable:', !btn.disabled);
                    }
                });
                
                // Test if sections exist
                const sections = ['dashboard', 'products', 'forecasting', 'staff'];
                sections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    console.log(` Section ${sectionId}:`, section ? 'Found' : 'NOT FOUND');
                });
                
                // Test switchSection function
                console.log(' Testing switchSection function...');
                try {
                    switchSection('dashboard');
                    console.log(' switchSection test successful');
                } catch (error) {
                    console.error(' switchSection test failed:', error);
                }
            }, 1000);
            
            try {
                checkAuth();
                loadForecasting();
                loadSalesChart();
            } catch (error) {
                console.error(' Error during initialization:', error);
            }
            
            // Add logout button event listener
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Setup initial category change listener
            setupCategoryChangeListener();
            
            // Add navigation button event listeners
            const navButtons = document.querySelectorAll('.nav-btn');
            console.log(' Found navigation buttons:', navButtons.length);
            
            navButtons.forEach((btn, index) => {
                console.log(` Button ${index}:`, btn.textContent.trim(), 'data-section:', btn.getAttribute('data-section'));
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(' Navigation button clicked:', btn.textContent.trim());
                    const sectionId = btn.getAttribute('data-section');
                    const buttonId = btn.getAttribute('id');
                    
                    console.log('Navigation clicked:', sectionId);
                    if (sectionId) {
                        switchSection(sectionId);
                    } else {
                        console.warn('No section ID found for button:', btn);
                    }
                });
            });
            
            // Add pagination event listeners
            const prevSalesPageBtn = document.getElementById('prevSalesPage');
            const nextSalesPageBtn = document.getElementById('nextSalesPage');
            
            if (prevSalesPageBtn) {
                prevSalesPageBtn.addEventListener('click', prevSalesPage);
            }
            
            if (nextSalesPageBtn) {
                nextSalesPageBtn.addEventListener('click', nextSalesPage);
            }
            
            // Add forecasting pagination event listeners
            const prevForecastingPageBtn = document.getElementById('prevForecastingPage');
            const nextForecastingPageBtn = document.getElementById('nextForecastingPage');
            
            if (prevForecastingPageBtn) {
                prevForecastingPageBtn.addEventListener('click', prevForecastingPage);
            }
            
            if (nextForecastingPageBtn) {
                nextForecastingPageBtn.addEventListener('click', nextForecastingPage);
            }
            
            // Add event listeners for dynamically created buttons
            document.addEventListener('click', (e) => {
                console.log(' Click detected on:', e.target);
                // Download chart button
                if (e.target.id === 'downloadChartBtn' || e.target.closest('#downloadChartBtn')) {
                    console.log(' Download chart button clicked');
                    downloadChart();
                }
                
                // Chart period buttons
                if (e.target.classList.contains('chart-btn')) {
                    const period = parseInt(e.target.getAttribute('data-period'));
                    updateChartPeriod(period);
                }
                
                // Edit product buttons
                if (e.target.classList.contains('edit-product-btn')) {
                    const productId = e.target.getAttribute('data-product-id');
                    editProduct(productId);
                }
                
                // Update stock buttons
                if (e.target.classList.contains('update-stock-btn')) {
                    const productId = e.target.getAttribute('data-product-id');
                    updateStock(productId);
                }
                
                // Cancel purchase button
                if (e.target.id === 'cancelPurchaseBtn') {
                    closeModal();
                }
            });
            
            // Product Management Event Listeners
            const addProductBtn = document.getElementById('addProductBtn');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', addProduct);
            }
            
            // Initialize cards view
            initializeCardsView();
            
            // Clear Filters Button
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearAllFilters);
            }
            
            // Clear Search Button
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
            
            // Export Products Button
            const exportProductsBtn = document.getElementById('exportProductsBtn');
            if (exportProductsBtn) {
                exportProductsBtn.addEventListener('click', exportProducts);
            }
            
            // Export Forecast Report Button
            const exportForecastBtn = document.getElementById('exportForecastBtn');
            if (exportForecastBtn) {
                exportForecastBtn.addEventListener('click', exportForecastReport);
            }
            
            // Add First Product Button
            const addFirstProductBtn = document.getElementById('addFirstProductBtn');
            if (addFirstProductBtn) {
                addFirstProductBtn.addEventListener('click', addProduct);
            }
            
            // Modal Event Listeners
            const closeModalBtn = document.getElementById('closeModal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }
            
            // Edit Modal Event Listeners
            const closeEditModalBtn = document.getElementById('closeEditModal');
            if (closeEditModalBtn) {
                closeEditModalBtn.addEventListener('click', closeEditModal);
            }
            
            const cancelEditProductBtn = document.getElementById('cancelEditProduct');
            if (cancelEditProductBtn) {
                cancelEditProductBtn.addEventListener('click', closeEditModal);
            }
            
            // Stock Management Buttons
            const addStockBtn = document.getElementById('addStockBtn');
            const removeStockBtn = document.getElementById('removeStockBtn');
            
            if (addStockBtn) {
                addStockBtn.addEventListener('click', addStock);
            }
            if (removeStockBtn) {
                removeStockBtn.addEventListener('click', removeStock);
            }
            
            // Edit Product Form Submission
            const editProductForm = document.getElementById('productEditForm');
            if (editProductForm) {
                editProductForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Form submit event triggered');
                    saveEditProduct();
                });
            }
            
            // Direct button click listener as backup
            const saveEditProductBtn = document.getElementById('saveEditProduct');
            if (saveEditProductBtn) {
                saveEditProductBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Save button clicked');
                    saveEditProduct();
                });
            }
            
            const cancelProduct = document.getElementById('cancelProduct');
            if (cancelProduct) {
                cancelProduct.addEventListener('click', closeModal);
            }
            
            // Setup product form events
            setupProductFormEvents();
            
            // Staff modal event listeners
            const addStaffBtn = document.getElementById('addStaffBtn');
            if (addStaffBtn) {
                addStaffBtn.addEventListener('click', () => {
                    resetStaffModal();
                    openStaffModal();
                });
            }
            
            const clearAllStaffBtn = document.getElementById('clearAllStaffBtn');
            if (clearAllStaffBtn) {
                clearAllStaffBtn.addEventListener('click', clearAllStaff);
            }
            
            const refreshStaffBtn = document.getElementById('refreshStaffBtn');
            if (refreshStaffBtn) {
                refreshStaffBtn.addEventListener('click', loadStaff);
            }
            
            const closeStaffModalBtn = document.getElementById('closeStaffModal');
            if (closeStaffModalBtn) {
                closeStaffModalBtn.addEventListener('click', closeStaffModal);
            }
            
            const cancelStaffBtn = document.getElementById('cancelStaffBtn');
            if (cancelStaffBtn) {
                cancelStaffBtn.addEventListener('click', closeStaffModal);
            }
            
            // Staff form submission
            const staffForm = document.getElementById('staffForm');
            if (staffForm) {
                staffForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(staffForm);
                    const staffId = formData.get('id');
                    const staffData = {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        email: formData.get('email'),
                        role: formData.get('role')
                    };
                    
                    console.log(' Form data being sent:', staffData);
                    console.log(' Form validation - firstName:', staffData.firstName, 'lastName:', staffData.lastName, 'email:', staffData.email, 'role:', staffData.role);
                    
                    // Validate required fields
                    if (!staffData.firstName || !staffData.lastName || !staffData.email) {
                        showNotification('Please fill in all required fields (First Name, Last Name, and Email)', 'error');
                        return;
                    }
                    
                    // Add status if editing
                    if (staffId) {
                        staffData.status = formData.get('status');
                        await updateStaff(staffId, staffData);
                    } else {
                        await addStaff(staffData);
                    }
                });
            }
            
            // Real-time email validation
            const staffEmailField = document.getElementById('staffEmail');
            if (staffEmailField) {
                let emailCheckTimeout;
                staffEmailField.addEventListener('input', (e) => {
                    clearTimeout(emailCheckTimeout);
                    const email = e.target.value;
                    
                    if (email && email.includes('@')) {
                        emailCheckTimeout = setTimeout(async () => {
                            try {
                                const response = await fetch('/api/staff/check-email', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                                    },
                                    body: JSON.stringify({ email: email })
                                });
                                
                                const result = await response.json();
                                
                                if (!result.available) {
                                    e.target.style.borderColor = '#dc3545';
                                    showNotification('This email is already registered. Please use a different email.', 'error');
                                } else {
                                    e.target.style.borderColor = '#28a745';
                                }
                            } catch (error) {
                                console.log('Email check failed:', error);
                            }
                        }, 1000); // Wait 1 second after user stops typing
                    } else {
                        e.target.style.borderColor = '';
                    }
                });
            }
            
            // Category button event listeners
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    
                    // Hide all subcategory buttons first
                    document.querySelectorAll('.subcategory-buttons').forEach(sub => sub.classList.remove('show'));
                    
                    // Show/hide subcategory buttons based on selection
                    const selectedAnimal = btn.getAttribute('data-category');
                    
                    if (selectedAnimal === 'pig') {
                        const pigSubcategories = document.getElementById('pigSubcategories');
                        pigSubcategories.classList.add('show');
                        // Reset subcategory selection for pig
                        document.querySelectorAll('#pigSubcategories .subcategory-btn').forEach(b => b.classList.remove('active'));
                        document.querySelector('#pigSubcategories .subcategory-btn[data-subcategory=""]').classList.add('active');
                    } else if (selectedAnimal === 'chicken') {
                        const chickenSubcategories = document.getElementById('chickenSubcategories');
                        chickenSubcategories.classList.add('show');
                        // Reset subcategory selection for chicken
                        document.querySelectorAll('#chickenSubcategories .subcategory-btn').forEach(b => b.classList.remove('active'));
                        document.querySelector('#chickenSubcategories .subcategory-btn[data-subcategory=""]').classList.add('active');
                    }
                    
                    // Re-render products
                    renderProducts();
                });
            });
            
            // Subcategory button event listeners
            document.querySelectorAll('.subcategory-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Find which animal group this subcategory belongs to
                    const animalGroup = btn.closest('.animal-category-group');
                    const animalButton = animalGroup.querySelector('.category-btn');
                    const animalType = animalButton.getAttribute('data-category');
                    
                    // Remove active class from all subcategory buttons in the same animal group
                    animalGroup.querySelectorAll('.subcategory-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    // Re-render products
                    renderProducts();
                });
            });
            
            // Dynamic form field handling
            const productAnimal = document.getElementById('productAnimal');
            const productCategory = document.getElementById('productCategory');
            
            
            // Search event listener - TEMPORARILY DISABLED
            const searchProduct = document.getElementById('searchProduct');
            if (searchProduct) {
                searchProduct.disabled = true;
                searchProduct.style.opacity = '0.5';
                searchProduct.style.cursor = 'not-allowed';
                searchProduct.placeholder = 'Search disabled temporarily';
            }
            
            // Event delegation for edit, delete, and QR buttons
            document.addEventListener('click', (e) => {
                if (e.target.matches('[data-action="edit"]')) {
                    const productId = e.target.getAttribute('data-product-id');
                    editProduct(productId);
                } else if (e.target.matches('[data-action="delete"]')) {
                    const productId = e.target.getAttribute('data-product-id');
                    deleteProduct(productId);
                } else if (e.target.matches('[data-action="qr"]')) {
                    const productId = e.target.getAttribute('data-product-id');
                    generateQRCode(productId);
                }
            });
            
            // Analytics load button
            // Period button event listeners
            const dayViewBtn = document.getElementById('dayViewBtn');
            const monthViewBtn = document.getElementById('monthViewBtn');
            const yearViewBtn = document.getElementById('yearViewBtn');
            
            if (dayViewBtn) {
                dayViewBtn.addEventListener('click', () => switchAnalyticsPeriod('day'));
            }
            if (monthViewBtn) {
                monthViewBtn.addEventListener('click', () => switchAnalyticsPeriod('month'));
            }
            if (yearViewBtn) {
                yearViewBtn.addEventListener('click', () => switchAnalyticsPeriod('year'));
            }
            
            // Load all analytics periods in parallel (7 days, 30 days, 3 months) for speed
            loadAllAnalyticsPeriods();
            
            // Initialize QR communication system
            initQRCommunication();
            
            // Close modal when clicking outside
            const productModal = document.getElementById('productModal');
            if (productModal) {
                productModal.addEventListener('click', (e) => {
                    if (e.target === productModal) {
                        closeModal();
                    }
                });
            }
            
            // QR Modal Event Listeners
            const closeQrModalBtn = document.getElementById('closeQrModal');
            if (closeQrModalBtn) {
                closeQrModalBtn.addEventListener('click', closeQRModal);
            }
            
            const downloadQrBtn = document.getElementById('downloadQrBtn');
            if (downloadQrBtn) {
                downloadQrBtn.addEventListener('click', downloadQRCode);
            }
            
            
            
            
            // Close QR modal when clicking outside
            const qrModal = document.getElementById('qrModal');
            if (qrModal) {
                qrModal.addEventListener('click', (e) => {
                    if (e.target === qrModal) {
                        closeQRModal();
                    }
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const productModal = document.getElementById('productModal');
                    const qrModal = document.getElementById('qrModal');
                    const lowStockModal = document.getElementById('lowStockModal');
                    const stockManagementModal = document.getElementById('stockManagementModal');
                    if (productModal && productModal.style.display === 'block') {
                        closeModal();
                    } else if (qrModal && qrModal.style.display === 'block') {
                        closeQRModal();
                    } else if (lowStockModal && lowStockModal.style.display === 'block') {
                        closeLowStockModal();
                    } else if (stockManagementModal && stockManagementModal.style.display === 'block') {
                        closeStockManagementModal();
                    }
                }
            });
            
            // Close low stock modal
            const closeLowStockBtn = document.getElementById('closeLowStockModal');
            if (closeLowStockBtn) {
                closeLowStockBtn.addEventListener('click', closeLowStockModal);
            }
            
            // Stock management form
            const stockManagementForm = document.getElementById('stockManagementForm');
            if (stockManagementForm) {
                stockManagementForm.addEventListener('submit', handleStockManagementSubmit);
            }
            
            // Real-time stock calculation for stock management modal
            const stockToAddSacksInput = document.getElementById('stockToAddSacks');
            if (stockToAddSacksInput) {
                stockToAddSacksInput.addEventListener('input', function() {
                    updateStockCalculation();
                });
            }
            
            // Close stock management modal
            const closeStockManagementBtn = document.getElementById('closeStockManagementModal');
            if (closeStockManagementBtn) {
                closeStockManagementBtn.addEventListener('click', closeStockManagementModal);
            }
        });

        // Sales Detail Modal Functions
        // Global variable to store current sales detail data
        let currentSalesDetailData = null;
        let currentSalesPeriod = null;

        function showSalesDetailModal(period) {
            console.log(' Opening sales detail modal for period:', period);
            
            const modal = document.getElementById('salesDetailModal');
            const modalTitle = document.getElementById('modalTitle');
            
            // Set modal title based on period
            const titles = {
                'today': ' Today\'s Sales Details',
                'yesterday': ' Yesterday\'s Sales Details', 
                'week': ' This Week\'s Sales Details'
            };
            
            modalTitle.textContent = titles[period] || 'Sales Details';
            currentSalesPeriod = period;
            
            // Show modal
            modal.style.display = 'block';
            
            // Load data for the selected period
            loadSalesDetailData(period);
        }

        function closeSalesDetailModal() {
            console.log(' Closing sales detail modal');
            const modal = document.getElementById('salesDetailModal');
            modal.style.display = 'none';
        }

        async function loadSalesDetailData(period) {
            try {
                console.log(' Loading sales detail data for period:', period);
                
                // Calculate date range based on period
                const { startDate, endDate } = getDateRangeForPeriod(period);
                
                // Fetch sales analytics data using date-range endpoint (same as forecasting)
                const params = new URLSearchParams();
                params.append('startDate', startDate.toISOString());
                params.append('endDate', endDate.toISOString());
                
                // Add timestamp to prevent caching
                params.append('_t', Date.now());
                const apiUrl = `${API_BASE}/orders/date-range?${params}`;
                console.log(' Making API call to:', apiUrl);
                console.log(' Date range:', { startDate: startDate.toISOString(), endDate: endDate.toISOString() });
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                console.log(' API response status:', response.status);
                console.log(' API response headers:', response.headers);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(' Raw API response:', data);
                    
                    // Process the orders data into analytics format
                    const analytics = processOrdersToAnalytics(data.orders || []);
                    console.log(' Processed analytics data:', analytics);
                    
                    updateSalesDetailModal(analytics, period);
                } else {
                    console.error('Failed to load sales detail data, status:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showNotification('Failed to load sales details', 'error');
                }
            } catch (error) {
                console.error('Error loading sales detail data:', error);
                showNotification('Error loading sales details', 'error');
            }
        }

        function getDateRangeForPeriod(period) {
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'today':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'yesterday':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setDate(endDate.getDate() - 1);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                default:
                    startDate = new Date(now);
                    endDate = new Date(now);
            }
            
            return { startDate, endDate };
        }

        function updateSalesDetailModal(data, period) {
            console.log(' Updating sales detail modal with data:', data);
            
            // Store the data for export
            currentSalesDetailData = data;
            
            // Use backend values but correct only the sales count if it seems duplicated
            let correctedRevenue = data.totalRevenue || 0;
            let correctedSales = data.totalSales || 0;
            let correctedCost = data.totalCost || 0;
            let correctedProfit = data.totalProfit || 0;
            
            // Direct database API provides accurate counts - no correction needed
            
            // DEBUG: Log the actual values being used
            console.log(' Modal: Raw analytics data:', {
                revenue: correctedRevenue,
                cost: correctedCost,
                profit: correctedProfit,
                sales: correctedSales
            });
            
            // Direct database API now provides accurate data - no correction needed
            
            console.log(' Modal: Using values:', {
                revenue: correctedRevenue,
                cost: correctedCost,
                profit: correctedProfit,
                sales: correctedSales
            });
            
            // Update summary cards
            document.getElementById('modalTotalRevenue').textContent = `${(correctedRevenue || 0).toFixed(2)}`;
                    // Removed Total Orders field
            
            // Calculate total items sold - handle different data structures
            let totalItems = 0;
            if (data.sales && Array.isArray(data.sales)) {
                totalItems = data.sales.reduce((sum, sale) => {
                    // Handle direct database API structure
                    if (sale.items && Array.isArray(sale.items)) {
                        return sum + sale.items.reduce((itemSum, item) => itemSum + (item.quantity || 0), 0);
                    }
                    // Handle legacy structure
                    return sum + (sale.quantity || 0);
                }, 0);
            }
            
            // Fallback to correctedSales if totalItems is 0
            if (totalItems === 0) {
                totalItems = correctedSales;
            }
            
            document.getElementById('modalTotalItems').textContent = totalItems;
            
            // Calculate average order value
            const averageOrder = (correctedSales || 0) > 0 ? (correctedRevenue || 0) / (correctedSales || 0) : 0;
            document.getElementById('modalAverageOrder').textContent = `${(averageOrder || 0).toFixed(2)}`;
            
            // Update profit information
            document.getElementById('modalTotalProfit').textContent = `${(correctedProfit || 0).toFixed(2)}`;
            
            // Calculate profit margin
            const profitMargin = (correctedRevenue || 0) > 0 ? ((correctedProfit || 0) / (correctedRevenue || 0)) * 100 : 0;
            document.getElementById('modalProfitMargin').textContent = `${(profitMargin || 0).toFixed(1)}%`;
            
            // Update breakdown by animal
            updateAnimalBreakdown(data.salesByAnimal || {});
            
            // Update breakdown by category
            updateCategoryBreakdown(data.salesByCategory || {});
            
            // Update top products table
            updateTopProductsTable(data.topProducts || []);
            
            // Update recent transactions
            updateRecentTransactionsTable(data.sales);
        }

        function updateAnimalBreakdown(salesByAnimal) {
            const container = document.getElementById('modalAnimalBreakdown');
            if (!container) return;
            
            let html = '';
            if (!salesByAnimal || Object.keys(salesByAnimal).length === 0) {
                container.innerHTML = '<div class="breakdown-item">No animal data available</div>';
                return;
            }
            
            for (const [animal, data] of Object.entries(salesByAnimal)) {
                try {
                    const revenue = Number(data.revenue || 0);
                    const count = Number(data.count || 0);
                    const totalRevenue = Object.values(salesByAnimal).reduce((sum, item) => sum + Number(item.revenue || 0), 0);
                    const percentage = revenue > 0 && totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="breakdown-item">
                            <div class="breakdown-label">${animal.charAt(0).toUpperCase() + animal.slice(1)}</div>
                            <div class="breakdown-value">${revenue.toFixed(2)} (${count} items)</div>
                            <div class="breakdown-percentage">${percentage}%</div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error processing animal breakdown:', error, animal, data);
                }
            }
            container.innerHTML = html;
        }

        function updateCategoryBreakdown(salesByCategory) {
            const container = document.getElementById('modalCategoryBreakdown');
            if (!container) return;
            
            let html = '';
            if (!salesByCategory || Object.keys(salesByCategory).length === 0) {
                container.innerHTML = '<div class="breakdown-item">No category data available</div>';
                return;
            }
            
            for (const [category, data] of Object.entries(salesByCategory)) {
                try {
                    const revenue = Number(data.revenue || 0);
                    const count = Number(data.count || 0);
                    const totalRevenue = Object.values(salesByCategory).reduce((sum, item) => sum + Number(item.revenue || 0), 0);
                    const percentage = revenue > 0 && totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(1) : 0;
                    
                    html += `
                        <div class="breakdown-item">
                            <div class="breakdown-label">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                            <div class="breakdown-value">${revenue.toFixed(2)} (${count} items)</div>
                            <div class="breakdown-percentage">${percentage}%</div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error processing category breakdown:', error, category, data);
                }
            }
            container.innerHTML = html;
        }

        function updateTopProductsTable(topProducts) {
            const tbody = document.getElementById('modalTopProductsTable');
            if (!tbody) return;
            
            let html = '';
            if (!topProducts || !Array.isArray(topProducts)) {
                console.log(' No top products data');
                tbody.innerHTML = '<tr><td colspan="4">No product data available</td></tr>';
                return;
            }
            
            topProducts.forEach((product, index) => {
                try {
                    const revenue = Number(product.revenue || 0);
                    const quantity = Number(product.quantity || 0);
                    const totalRevenue = topProducts.reduce((sum, p) => sum + Number(p.revenue || 0), 0);
                    const percentage = revenue > 0 && totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(1) : 0;
                    
                    html += `
                        <tr>
                            <td>${product.name || 'Unknown Product'}</td>
                            <td>${quantity}</td>
                            <td>${revenue.toFixed(2)}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Error processing product for top products table:', error, product);
                }
            });
            tbody.innerHTML = html;
        }

        function updateRecentTransactionsTable(sales) {
            const tbody = document.getElementById('modalRecentTransactions');
            if (!tbody) return;
            
            let html = '';
            if (!sales || !Array.isArray(sales)) {
                console.log(' No sales data for recent transactions table');
                tbody.innerHTML = '<tr><td colspan="5">No recent transactions</td></tr>';
                return;
            }
            
            sales.forEach(sale => {
                try {
                    const date = new Date(sale.saleDate || sale.createdAt).toLocaleString();
                    const totalAmount = sale.totalAmount || sale.total || 0;
                    const productName = sale.productName || (sale.items && sale.items[0]?.productName) || 'Unknown Product';
                    const quantity = sale.quantity || (sale.items && sale.items[0]?.quantity) || 1;
                    const unit = sale.unit || (sale.items && sale.items[0]?.unit) || 'sack';
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${sale.customerName || 'Customer'}</td>
                            <td>${productName}</td>
                            <td>${quantity} ${unit}</td>
                            <td>${Number(totalAmount).toFixed(2)}</td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Error processing sale for recent transactions:', error, sale);
                }
            });
            tbody.innerHTML = html;
        }

        function exportSalesDetails() {
            console.log(' Exporting sales details to Excel...');
            
            if (!currentSalesDetailData) {
                showNotification('No sales data available to export', 'error');
                return;
            }
            
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                console.warn(' XLSX library not loaded, using fallback method');
                exportSalesDetailsAsCSV();
                return;
            }
            
            try {
                const data = currentSalesDetailData;
                const period = currentSalesPeriod;
                
                // Create a new workbook
                const workbook = XLSX.utils.book_new();
                
                // --- SUMMARY SHEET ---
                const summaryData = [
                    ['Sales Report - ' + (period === 'today' ? 'Today' : period === 'yesterday' ? 'Yesterday' : 'This Week')],
                    [],
                    ['SUMMARY'],
                    ['Total Revenue', `${data.totalRevenue.toFixed(2)}`],
                    ['Total Cost', `${(data.totalCost || 0).toFixed(2)}`],
                    ['Total Profit', `${(data.totalProfit || 0).toFixed(2)}`],
                    ['Profit Margin', `${((data.totalProfit || 0) / data.totalRevenue * 100).toFixed(1)}%`],
                    ['Total Sales', data.totalSales],
                    [],
                    ['BREAKDOWN BY ANIMAL']
                ];
                
                // Add animal breakdown
                if (data.salesByAnimal) {
                    Object.entries(data.salesByAnimal).forEach(([animal, stats]) => {
                        summaryData.push([
                            animal.charAt(0).toUpperCase() + animal.slice(1),
                            `${Number(stats.revenue || 0).toFixed(2)}`,
                            `${Number(stats.count || 0)} items`
                        ]);
                    });
                }
                
                summaryData.push([]);
                summaryData.push(['BREAKDOWN BY CATEGORY']);
                
                // Add category breakdown
                if (data.salesByCategory) {
                    Object.entries(data.salesByCategory).forEach(([category, stats]) => {
                        summaryData.push([
                            category.charAt(0).toUpperCase() + category.slice(1),
                            `${Number(stats.revenue || 0).toFixed(2)}`,
                            `${Number(stats.count || 0)} items`
                        ]);
                    });
                }
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                summarySheet['!cols'] = [{wch: 20}, {wch: 20}, {wch: 20}];
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                // --- TOP PRODUCTS SHEET ---
                const topProductsData = [
                    ['Top Products'],
                    [],
                    ['Product', 'Quantity Sold', 'Revenue', '% of Total']
                ];
                
                if (data.topProducts && Array.isArray(data.topProducts)) {
                    data.topProducts.forEach(product => {
                        const percentage = data.totalRevenue > 0 ? 
                            ((Number(product.revenue || 0) / data.totalRevenue) * 100).toFixed(1) : 0;
                        topProductsData.push([
                            product.name || 'Unknown',
                            product.quantity || 0,
                            `${Number(product.revenue || 0).toFixed(2)}`,
                            `${percentage}%`
                        ]);
                    });
                }
                
                const topProductsSheet = XLSX.utils.aoa_to_sheet(topProductsData);
                topProductsSheet['!cols'] = [{wch: 30}, {wch: 15}, {wch: 15}, {wch: 15}];
                XLSX.utils.book_append_sheet(workbook, topProductsSheet, 'Top Products');
                
                // --- TRANSACTIONS SHEET ---
                const transactionsData = [
                    ['Recent Transactions'],
                    [],
                    ['Date/Time', 'Customer', 'Product', 'Quantity', 'Total', 'Profit']
                ];
                
                if (data.sales && Array.isArray(data.sales)) {
                    data.sales.forEach(sale => {
                        const saleDate = new Date(sale.createdAt).toLocaleString();
                        const customerName = sale.customerName || 'Walk-in Customer';
                        
                        if (sale.items && Array.isArray(sale.items)) {
                            sale.items.forEach((item, index) => {
                                if (index === 0) {
                                    transactionsData.push([
                                        saleDate,
                                        customerName,
                                        item.name || 'Unknown Product',
                                        item.quantity || 0,
                                        `${Number(item.price || 0).toFixed(2)}`,
                                        `${(Number(item.price || 0) - Number(item.cost || 0)).toFixed(2)}`
                                    ]);
                                } else {
                                    transactionsData.push([
                                        '',
                                        '',
                                        item.name || 'Unknown Product',
                                        item.quantity || 0,
                                        `${Number(item.price || 0).toFixed(2)}`,
                                        `${(Number(item.price || 0) - Number(item.cost || 0)).toFixed(2)}`
                                    ]);
                                }
                            });
                        } else {
                            transactionsData.push([
                                saleDate,
                                customerName,
                                '-',
                                1,
                                `${Number(sale.totalPrice || 0).toFixed(2)}`,
                                `${Number(sale.totalProfit || 0).toFixed(2)}`
                            ]);
                        }
                    });
                }
                
                const transactionsSheet = XLSX.utils.aoa_to_sheet(transactionsData);
                transactionsSheet['!cols'] = [{wch: 20}, {wch: 20}, {wch: 25}, {wch: 12}, {wch: 15}, {wch: 15}];
                XLSX.utils.book_append_sheet(workbook, transactionsSheet, 'Transactions');
                
                // Generate filename
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = `Sales_Report_${period}_${dateStr}.xlsx`;
                
                // Write the file
                XLSX.writeFile(workbook, filename);
                showNotification('Sales report exported to Excel successfully!', 'success');
                console.log(' Sales report exported successfully');
                
            } catch (error) {
                console.error('Error exporting sales details:', error);
                showNotification('Failed to export sales report', 'error');
            }
        }

        function exportSalesDetailsAsCSV() {
            console.log(' Exporting sales details as CSV (fallback)...');
            
            try {
                const data = currentSalesDetailData;
                const period = currentSalesPeriod;
                
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // Add report title
                csvContent += `Sales Report - ${period === 'today' ? 'Today' : period === 'yesterday' ? 'Yesterday' : 'This Week'}\n\n`;
                
                // Add summary
                csvContent += 'SUMMARY\n';
                csvContent += `Total Revenue,${data.totalRevenue.toFixed(2)}\n`;
                csvContent += `Total Cost,${(data.totalCost || 0).toFixed(2)}\n`;
                csvContent += `Total Profit,${(data.totalProfit || 0).toFixed(2)}\n`;
                csvContent += `Profit Margin,${((data.totalProfit || 0) / data.totalRevenue * 100).toFixed(1)}%\n`;
                csvContent += `Total Sales,${data.totalSales}\n\n`;
                
                // Add animal breakdown
                csvContent += 'BREAKDOWN BY ANIMAL\n';
                csvContent += 'Animal,Revenue,Items\n';
                if (data.salesByAnimal) {
                    Object.entries(data.salesByAnimal).forEach(([animal, stats]) => {
                        csvContent += `${animal},${Number(stats.revenue || 0).toFixed(2)},${Number(stats.count || 0)}\n`;
                    });
                }
                csvContent += '\n';
                
                // Add category breakdown
                csvContent += 'BREAKDOWN BY CATEGORY\n';
                csvContent += 'Category,Revenue,Items\n';
                if (data.salesByCategory) {
                    Object.entries(data.salesByCategory).forEach(([category, stats]) => {
                        csvContent += `${category},${Number(stats.revenue || 0).toFixed(2)},${Number(stats.count || 0)}\n`;
                    });
                }
                csvContent += '\n';
                
                // Add top products
                csvContent += 'TOP PRODUCTS\n';
                csvContent += 'Product,Quantity,Revenue,% of Total\n';
                if (data.topProducts && Array.isArray(data.topProducts)) {
                    data.topProducts.forEach(product => {
                        const percentage = data.totalRevenue > 0 ? 
                            ((Number(product.revenue || 0) / data.totalRevenue) * 100).toFixed(1) : 0;
                        csvContent += `${product.name || 'Unknown'},${product.quantity || 0},${Number(product.revenue || 0).toFixed(2)},${percentage}%\n`;
                    });
                }
                csvContent += '\n';
                
                // Add transactions
                csvContent += 'RECENT TRANSACTIONS\n';
                csvContent += 'Date/Time,Customer,Product,Quantity,Total,Profit\n';
                if (data.sales && Array.isArray(data.sales)) {
                    data.sales.forEach(sale => {
                        const saleDate = new Date(sale.createdAt).toLocaleString();
                        const customerName = sale.customerName || 'Walk-in';
                        
                        if (sale.items && Array.isArray(sale.items)) {
                            sale.items.forEach((item, index) => {
                                csvContent += `${index === 0 ? saleDate : ''},${index === 0 ? customerName : ''},${item.name || 'Unknown'},${item.quantity || 0},${Number(item.price || 0).toFixed(2)},${(Number(item.price || 0) - Number(item.cost || 0)).toFixed(2)}\n`;
                            });
                        } else {
                            csvContent += `${saleDate},${customerName},-,1,${Number(sale.totalPrice || 0).toFixed(2)},${Number(sale.totalProfit || 0).toFixed(2)}\n`;
                        }
                    });
                }
                
                // Create and trigger download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0];
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `Sales_Report_${period}_${dateStr}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Sales report exported as CSV successfully!', 'success');
                console.log(' Sales report exported as CSV');
                
            } catch (error) {
                console.error('Error exporting sales details as CSV:', error);
                showNotification('Failed to export sales report', 'error');
            }
        }

        // Admin QR Scanner Functions
        function initAdminScanner() {
            const qrInput = document.getElementById('adminQrInput');
            if (!qrInput) return;
            
            console.log(' Initializing admin QR scanner...');
            
            // Keep scanner input focused
            qrInput.focus();
            
            // Listen for scanner input
            qrInput.addEventListener('input', function(e) {
                const value = e.target.value;
                if (value.length > 3) { // Likely scanner input
                    setTimeout(() => {
                        if (qrInput.value.trim()) {
                            scanProductForEdit();
                        }
                    }, 100);
                }
            });
            
            // Listen for Enter key
            qrInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    scanProductForEdit();
                }
            });
            
            // Keep input focused periodically
            setInterval(() => {
                const activeElement = document.activeElement;
                const editModal = document.getElementById('productEditModal');
                
                // Don't refocus if edit modal is open
                if (editModal && editModal.style.display === 'block') {
                    return;
                }
                
                // Don't refocus if user is typing in other inputs
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                    return;
                }
                
                if (qrInput && document.activeElement !== qrInput) {
                    qrInput.focus();
                }
            }, 1000);
        }
        
        function scanProductForEdit() {
            const qrInput = document.getElementById('adminQrInput');
            const productId = qrInput.value.trim();
            
            console.log(' Admin scanner input:', productId);
            
            if (!productId) {
                updateAdminScannerStatus('error', 'Please scan or enter a product ID');
                showNotification('Please scan or enter a product ID', 'error');
                return;
            }
            
            updateAdminScannerStatus('scanning', 'Scanning...');
            
            // Find product by ID
            const product = products.find(p => p.id == productId || p._id == productId);
            
            if (product) {
                console.log(' Product found:', product.name);
                updateAdminScannerStatus('ready', 'Product found! Opening edit modal...');
                
                // Clear input
                qrInput.value = '';
                
                // Open edit modal
                openEditModal(product.id);
                
                // Show success notification
                showNotification(`Opening ${product.name} for editing`, 'success');
            } else {
                console.log(' Product not found');
                updateAdminScannerStatus('error', 'Product not found');
                showNotification('Product not found. Please check the QR code.', 'error');
                
                // Clear input
                qrInput.value = '';
            }
        }
        
        function updateAdminScannerStatus(status, message) {
            const statusElement = document.getElementById('adminScannerStatus');
            if (statusElement) {
                statusElement.className = `scanner-status ${status}`;
                statusElement.textContent = message;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('salesDetailModal');
            if (event.target === modal) {
                closeSalesDetailModal();
            }
        }

        // Bulk Cost Update Functions
        function openBulkCostUpdateModal() {
            console.log('Opening bulk cost update modal');
            const modal = document.getElementById('bulkCostUpdateModal');
            modal.style.display = 'block';
            loadProductsForBulkUpdate();
        }

        function closeBulkCostUpdateModal() {
            const modal = document.getElementById('bulkCostUpdateModal');
            modal.style.display = 'none';
            document.getElementById('bulkCostUpdateForm').reset();
        }

        async function loadProductsForBulkUpdate() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                if (!response.ok) {
                    throw new Error('Failed to load products');
                }
                
                const products = await response.json();
                const productsList = document.getElementById('bulkCostProductsList');
                
                productsList.innerHTML = '';
                
                products.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.className = 'product-checkbox-item';
                    productItem.innerHTML = `
                        <input type="checkbox" id="product-${product._id}" value="${product._id}" class="product-checkbox">
                        <div class="product-checkbox-info">
                            <div class="product-checkbox-name">${product.name}</div>
                            <div class="product-checkbox-details">${product.animal}  ${product.category}  ${product.type}</div>
                        </div>
                        <div class="product-checkbox-cost">Current: ${(product.costPerSack || 0).toFixed(2)}</div>
                    `;
                    productsList.appendChild(productItem);
                });
                
                // Add event listeners for selection controls
                setupBulkCostSelectionControls();
                
            } catch (error) {
                console.error('Error loading products for bulk update:', error);
                showNotification('Failed to load products', 'error');
            }
        }

        function setupBulkCostSelectionControls() {
            // Select All
            document.getElementById('selectAllProducts').addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = true);
            });

            // Select Feeds Only
            document.getElementById('selectFeedsOnly').addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                checkboxes.forEach(checkbox => {
                    const productItem = checkbox.closest('.product-checkbox-item');
                    const details = productItem.querySelector('.product-checkbox-details').textContent;
                    checkbox.checked = details.includes('feeds');
                });
            });

            // Select Supplements Only
            document.getElementById('selectSupplementsOnly').addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                checkboxes.forEach(checkbox => {
                    const productItem = checkbox.closest('.product-checkbox-item');
                    const details = productItem.querySelector('.product-checkbox-details').textContent;
                    checkbox.checked = details.includes('supplements');
                });
            });

            // Clear All
            document.getElementById('clearSelection').addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = false);
            });
        }

        // Handle bulk cost update form submission
        document.getElementById('bulkCostUpdateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const newCostPerSack = parseFloat(formData.get('costPerSack'));
            
            if (isNaN(newCostPerSack) || newCostPerSack < 0) {
                showNotification('Please enter a valid cost price', 'error');
                return;
            }
            
            // Get selected products
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showNotification('Please select at least one product', 'error');
                return;
            }
            
            const selectedProductIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            console.log('Selected product IDs:', selectedProductIds);
            console.log('New cost per sack:', newCostPerSack);
            
            try {
                showNotification('Updating cost prices...', 'info');
                
                const response = await fetch(`${API_BASE}/products/bulk-cost-update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        productIds: selectedProductIds,
                        costPerSack: newCostPerSack
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update cost prices');
                }
                
                const result = await response.json();
                showNotification(`Successfully updated cost prices for ${result.updatedCount} products. All sales profits recalculated automatically.`, 'success');
                
                // Close modal and refresh products
                closeBulkCostUpdateModal();
                loadProducts(); // Refresh the products list
                
                // Also refresh the sales display to show updated profits
                setTimeout(() => {
                    updateDailySalesDisplay();
                }, 1000);
                
            } catch (error) {
                console.error('Error updating cost prices:', error);
                showNotification('Failed to update cost prices', 'error');
            }
        });

        // Add event listener for bulk cost update button
        document.addEventListener('DOMContentLoaded', () => {
            const bulkCostUpdateBtn = document.getElementById('bulkCostUpdateBtn');
            if (bulkCostUpdateBtn) {
                bulkCostUpdateBtn.addEventListener('click', openBulkCostUpdateModal);
            }
        });

        // Test function to check products and their cost prices
        async function testProductsAndCosts() {
            try {
                console.log(' Testing products and their cost prices...');
                
                const response = await fetch(`${API_BASE}/products`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const products = data.products || data;
                    console.log(' Total products found:', products.length);
                    
                    const productsWithCost = products.filter(p => p.costPerSack > 0);
                    console.log(' Products with cost prices:', productsWithCost.length);
                    
                    if (productsWithCost.length > 0) {
                        console.log(' Products with cost prices:', productsWithCost.map(p => ({
                            name: p.name,
                            costPerSack: p.costPerSack
                        })));
                    } else {
                        console.log(' NO PRODUCTS HAVE COST PRICES SET!');
                        console.log(' All products:', products.map(p => ({
                            name: p.name,
                            costPerSack: p.costPerSack,
                            cost: p.cost
                        })));
                    }
                } else {
                    console.error('Failed to load products');
                }
            } catch (error) {
                console.error('Error testing products:', error);
            }
        }

        // Recalculate sales profits
        async function recalculateSales() {
            try {
                showNotification('Recalculating sales profits...', 'info');
                
                const response = await fetch(`${API_BASE}/sales/recalculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to recalculate sales');
                }
                
                const result = await response.json();
                showNotification(`Successfully recalculated ${result.updatedCount} sales!`, 'success');
                
                // Refresh the sales display
                await updateDailySalesDisplay();
                
            } catch (error) {
                console.error('Error recalculating sales:', error);
                showNotification(`Failed to recalculate sales: ${error.message}`, 'error');
            }
        }
        
        // Reset all sales and orders
        async function resetAllSales() {
            try {
                // Show confirmation dialog
                const confirmed = await showResetConfirmation();
                if (!confirmed) {
                    return;
                }
                
                showNotification('Resetting all sales and orders...', 'info');
                
                const response = await fetch(`${API_BASE}/sales/reset-all`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to reset sales');
                }
                
                const result = await response.json();
                showNotification(`Successfully reset all sales! Deleted ${result.deletedOrders} orders and ${result.deletedSales} sales.`, 'success');
                
                // Refresh all displays
                await updateDailySalesDisplay();
                await loadAnalytics('day');
                
            } catch (error) {
                console.error('Error resetting sales:', error);
                showNotification(`Failed to reset sales: ${error.message}`, 'error');
            }
        }
        
        // Show reset confirmation dialog
        function showResetConfirmation() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        max-width: 500px;
                        text-align: center;
                    ">
                        <div style="font-size: 4rem; margin-bottom: 20px;"></div>
                        <h2 style="color: #d32f2f; margin-bottom: 15px;">Reset All Sales</h2>
                        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
                            This action will <strong>permanently delete</strong> all orders and sales data.<br>
                            <strong>This cannot be undone!</strong>
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button id="confirmReset" style="
                                background: #d32f2f;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: bold;
                            ">Yes, Reset All</button>
                            <button id="cancelReset" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 16px;
                            ">Cancel</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('confirmReset').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
                
                document.getElementById('cancelReset').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(false);
                    }
                });
            });
        }
    </script>
    
    <!-- Low Stock Modal -->
    <div id="lowStockModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Low Stock Products</h2>
                <span class="close" id="closeLowStockModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="low-stock-instructions">
                    <p><strong>CLICK TO ADD STOCK</strong> - Click the "Add Stock" button below to update stock levels for each product.</p>
                </div>
                <div id="lowStockList">
                    <div class="loading">Loading low stock products...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stock Management Modal -->
    <div id="stockManagementModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Stock Management</h2>
                <span class="close" id="closeStockManagementModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="product-info-header">
                    <h3 id="stockProductName">Product Name</h3>
                    <p id="stockProductCategory">Category</p>
                    <div class="current-stock-display">
                        <span class="current-stock-label">Current Stock:</span>
                        <span class="current-stock-value" id="currentStockDisplay">0</span>
                    </div>
                    <div class="stock-breakdown" id="stockBreakdownDisplay">
                        <span class="stock-detail">Sacks: <span id="currentSacks">0</span></span>
                        <span class="stock-detail">Kilos: <span id="currentKilos">0</span></span>
                        <span class="stock-detail">Half Kilos: <span id="currentHalfKilos">0</span></span>
                    </div>
                </div>
                
                <form id="stockManagementForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockToAddSacks" class="form-label">Stock to Add (Sacks)</label>
                            <input type="number" id="stockToAddSacks" name="stockToAddSacks" class="form-input" min="0" placeholder="0">
                            <div class="form-help">Enter the number of sacks to add. Kilos and half-kilos will be calculated automatically.</div>
                            
                            <!-- Real-time calculation display -->
                            <div id="stockCalculationDisplay" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                                <div style="font-weight: bold; margin-bottom: 5px;">New Stock After Adding:</div>
                                <div id="newStockSacks">Sacks: 0</div>
                                <div id="newStockKilos">Kilos: 0</div>
                                <div id="newStockHalfKilos">Half Kilos: 0</div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeStockManagementModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Stock</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Cost Update Modal -->
    <div id="bulkCostUpdateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2> Bulk Cost Price Update</h2>
                <span class="close" onclick="closeBulkCostUpdateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="bulk-update-info">
                    <h3>Update Cost Price for Multiple Products</h3>
                    <p>Set the same cost price per sack for multiple products at once.</p>
                </div>
                
                <form id="bulkCostUpdateForm">
                    <div class="form-group">
                        <label for="bulkCostPerSack" class="form-label">
                            New Cost Price per Sack () <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-prefix"></span>
                            <input type="number" id="bulkCostPerSack" name="costPerSack" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                        <div class="form-help">This will update the cost price for all selected products</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Select Products to Update:</label>
                        <div class="product-selection">
                            <div class="selection-controls">
                                <button type="button" class="btn btn-sm btn-secondary" id="selectAllProducts">Select All</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="selectFeedsOnly">Feeds Only</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="selectSupplementsOnly">Supplements Only</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="clearSelection">Clear All</button>
                            </div>
                            <div class="products-list" id="bulkCostProductsList">
                                <!-- Products will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeBulkCostUpdateModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Cost Prices</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sales Detail Modal -->
    <div id="salesDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Sales Details</h2>
                <span class="close" onclick="closeSalesDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="sales-summary">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-icon"></div>
                            <div class="summary-content">
                                <h4>Total Revenue</h4>
                                <div class="summary-value" id="modalTotalRevenue">0.00</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"></div>
                            <div class="summary-content">
                                <h4>Items Sold</h4>
                                <div class="summary-value" id="modalTotalItems">0</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"></div>
                            <div class="summary-content">
                                <h4>Average Order</h4>
                                <div class="summary-value" id="modalAverageOrder">0.00</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"></div>
                            <div class="summary-content">
                                <h4>Total Profit</h4>
                                <div class="summary-value" id="modalTotalProfit">0.00</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"></div>
                            <div class="summary-content">
                                <h4>Profit Margin</h4>
                                <div class="summary-value" id="modalProfitMargin">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sales-breakdown">
                    <h3>Sales Breakdown</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-card">
                            <h4>By Animal</h4>
                            <div id="modalAnimalBreakdown">
                                <!-- Animal breakdown will be populated here -->
                            </div>
                        </div>
                        <div class="breakdown-card">
                            <h4>By Category</h4>
                            <div id="modalCategoryBreakdown">
                                <!-- Category breakdown will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="top-products-modal">
                    <h3>Top Products</h3>
                    <div class="table-container">
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity Sold</th>
                                    <th>Revenue</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="modalTopProductsTable">
                                <!-- Top products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="recent-transactions">
                    <h3>Recent Transactions</h3>
                    <div class="table-container">
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="modalRecentTransactions">
                                <!-- Recent transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSalesDetailModal()">Close</button>
                <button class="btn btn-primary" onclick="exportSalesDetails()">Export Report</button>
            </div>
        </div>
    </div>
</body>
</html>
