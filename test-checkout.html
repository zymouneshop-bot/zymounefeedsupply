<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Checkout Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .product {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .checkout-form {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Mock Checkout Test</h1>
        <p>This will help us test the order creation process and see why duplicates are appearing.</p>
        
        <div class="product">
            <h3>Test Product</h3>
            <p><strong>Name:</strong> SARIMANOK - PRE CONDITIONER</p>
            <p><strong>Price per Sack:</strong> ‚Ç±1120.00</p>
            <p><strong>Cost per Sack:</strong> ‚Ç±1500.00</p>
            <p><strong>Stock:</strong> 10 sacks</p>
        </div>

        <div class="checkout-form">
            <h3>üõí Checkout Form</h3>
            <form id="checkoutForm">
                <div class="form-group">
                    <label for="customerName">Customer Name:</label>
                    <input type="text" id="customerName" value="Test Customer" required>
                </div>
                
                <div class="form-group">
                    <label for="customerPhone">Phone:</label>
                    <input type="text" id="customerPhone" value="123-456-7890">
                </div>
                
                <div class="form-group">
                    <label for="customerEmail">Email:</label>
                    <input type="email" id="customerEmail" value="test@example.com">
                </div>
                
                <div class="form-group">
                    <label for="quantity">Quantity:</label>
                    <input type="number" id="quantity" value="1" min="1" max="10">
                </div>
                
                <div class="form-group">
                    <label for="unit">Unit:</label>
                    <select id="unit">
                        <option value="sack">Sack</option>
                        <option value="kilo">Kilo</option>
                    </select>
                </div>
                
                <button type="button" onclick="testOrderCreation()">üß™ Test Order Creation</button>
                <button type="button" onclick="testAnalytics()">üìä Test Analytics</button>
                <button type="button" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            </form>
        </div>

        <div class="results">
            <h3>üìã Test Results</h3>
            <div id="results"></div>
        </div>

        <div class="results">
            <h3>üìù Console Logs</h3>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api';
        let logCount = 0;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            logCount = 0;
        }

        async function testOrderCreation() {
            log('üß™ Starting order creation test...');
            
            try {
                const orderData = {
                    customerName: document.getElementById('customerName').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    customerEmail: document.getElementById('customerEmail').value,
                    items: [{
                        productId: '68eafcfb7c09959ec2c7bb7b', // Use existing product ID
                        productName: 'SARIMANOK - PRE CONDITIONER',
                        quantity: parseInt(document.getElementById('quantity').value),
                        unit: document.getElementById('unit').value,
                        price: 1120
                    }],
                    subtotal: 1120 * parseInt(document.getElementById('quantity').value),
                    tax: (1120 * parseInt(document.getElementById('quantity').value)) * 0.12,
                    total: (1120 * parseInt(document.getElementById('quantity').value)) * 1.12,
                    staffId: 'test-user',
                    staffName: 'Test User'
                };

                log(`üìù Order data: ${JSON.stringify(orderData, null, 2)}`);

                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    body: JSON.stringify(orderData)
                });

                log(`üì° Response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Order created successfully: ${result.order._id}`);
                    document.getElementById('results').innerHTML += `
                        <div style="color: green; margin: 10px 0;">
                            ‚úÖ Order Created: ${result.order._id}<br>
                            Total: ‚Ç±${result.order.total}<br>
                            Items: ${result.order.items.length}
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    log(`‚ùå Order creation failed: ${error.error}`);
                    document.getElementById('results').innerHTML += `
                        <div style="color: red; margin: 10px 0;">
                            ‚ùå Error: ${error.error}
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`);
                document.getElementById('results').innerHTML += `
                    <div style="color: red; margin: 10px 0;">
                        ‚ùå Network Error: ${error.message}
                    </div>
                `;
            }
        }

        async function testAnalytics() {
            log('üìä Testing analytics API...');
            
            try {
                const now = new Date();
                const startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);

                const params = new URLSearchParams();
                params.append('startDate', startDate.toISOString());
                params.append('endDate', endDate.toISOString());
                params.append('_t', Date.now());

                log(`üìÖ Date range: ${startDate.toISOString()} to ${endDate.toISOString()}`);

                const response = await fetch(`${API_BASE}/sales/analytics?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                log(`üì° Analytics response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`üìä Analytics data: ${JSON.stringify(data, null, 2)}`);
                    
                    document.getElementById('results').innerHTML += `
                        <div style="background: #e8f4f8; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>üìä Analytics Results:</h4>
                            <p><strong>Total Sales:</strong> ${data.totalSales}</p>
                            <p><strong>Total Revenue:</strong> ‚Ç±${data.totalRevenue}</p>
                            <p><strong>Total Cost:</strong> ‚Ç±${data.totalCost}</p>
                            <p><strong>Total Profit:</strong> ‚Ç±${data.totalProfit}</p>
                            <p><strong>Profit Margin:</strong> ${data.totalRevenue > 0 ? ((data.totalProfit / data.totalRevenue) * 100).toFixed(1) : 0}%</p>
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    log(`‚ùå Analytics failed: ${error}`);
                    document.getElementById('results').innerHTML += `
                        <div style="color: red; margin: 10px 0;">
                            ‚ùå Analytics Error: ${error}
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Analytics network error: ${error.message}`);
                document.getElementById('results').innerHTML += `
                    <div style="color: red; margin: 10px 0;">
                        ‚ùå Analytics Network Error: ${error.message}
                    </div>
                `;
            }
        }

        // Auto-log console messages
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.join(' '));
        };

        log('üöÄ Mock checkout test initialized');
        log('üí° Click "Test Order Creation" to create a test order');
        log('üí° Click "Test Analytics" to check analytics data');
    </script>
</body>
</html>
